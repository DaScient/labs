<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>LLaMA-Energy Chat</title>
<style>
  :root{--bg:#0b1220;--panel:#0f172a;--ink:#e8ebf1;--mut:#9aa4b2;--accent:#2563eb}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font:15px system-ui,-apple-system,Segoe UI,Roboto}
  header{padding:12px 16px;background:#101b2d;font-weight:600} .mut{color:var(--mut)}
  #chat{height:64vh;min-height:320px;overflow:auto;padding:12px 16px}
  .msg{max-width:80%;padding:10px 12px;border-radius:10px;margin:8px 0;white-space:pre-wrap;line-height:1.45}
  .u{margin-left:auto;background:#14325f} .a{margin-right:auto;background:#132036}
  #bar{display:flex;gap:8px;padding:10px 12px;background:#101b2d;position:sticky;bottom:0}
  select,input,button{border:none;border-radius:8px}
  select{background:#132036;color:var(--ink);padding:8px}
  #q{flex:1;padding:10px;background:#0b1426;color:var(--ink)}
  button{padding:10px 14px;background:var(--accent);color:#fff;cursor:pointer}
  #status{padding:4px 16px;font-size:12px} .src{font-size:12px;color:var(--mut);margin-top:4px}
</style>
</head>
<body>
<header>⚡ LLaMA-Energy Chat <span class="mut">• EIA-grounded / FERC-aware</span></header>

<div id="chat" aria-live="polite"></div>
<div id="status" class="mut">Ready.</div>

<div id="bar">
  <select id="state" title="State">
    <option value="VA" selected>VA</option><option>CA</option><option>TX</option><option>NY</option>
    <option>IL</option><option>WA</option><option>FL</option><option>NC</option><option>MD</option>
  </select>
  <input id="q" placeholder="Ask about disposition, IPPs, losses, % of supply, or cite FERC dockets…" />
  <button id="send">Send</button>
</div>

<script>
const API = "https://llama-energy.aristocles24.workers.dev/api/rag";
const chat = document.getElementById('chat'), q = document.getElementById('q');
const statusEl = document.getElementById('status'), stateSel = document.getElementById('state');

function add(role, text, sources){
  const b=document.createElement('div'); b.className='msg '+(role==='user'?'u':'a'); b.textContent=text||''; chat.appendChild(b);
  if(Array.isArray(sources)&&sources.length){ const s=document.createElement('div'); s.className='src'; s.textContent='Sources: '+sources.map(x=>x.accession||x.series||x.url||x.source).join(', '); chat.appendChild(s); }
  chat.scrollTop=chat.scrollHeight;
}

async function send(){
  const text=q.value.trim(); if(!text) return;
  const state=stateSel.value;
  add('user', text); q.value=''; statusEl.textContent='⏳ querying…';
  try{
    const res=await fetch(API,{method:'POST',headers:{'content-type':'application/json'},
      body:JSON.stringify({question:text,state,context:{persona:'hyper-unit',region:`PJM-${state}`}})});
    if(!res.ok) throw new Error('HTTP '+res.status);
    const ct=(res.headers.get('content-type')||'').toLowerCase();
    if(ct.includes('application/json')){
      const j=await res.json();
      add('assistant', j.answer || '[no answer]', j.sources||[]);
      statusEl.textContent='✔ ' + new Date().toLocaleTimeString();
    }else{
      const t=await res.text();
      add('assistant', `Non-JSON (${res.status}). Preview:\n`+t.slice(0,400));
      statusEl.textContent='⚠ Non-JSON';
    }
  }catch(e){
    add('assistant','Error: '+e.message); statusEl.textContent='⚠ '+e.message;
  }
}

document.getElementById('send').onclick=send;
q.addEventListener('keydown',e=>{ if(e.key==='Enter') send(); });

// welcome
add('assistant','Ask for a snapshot (latest year, YoY, and % of supply) or request docket-aware context. Try: "VA IPPs vs direct-use since 2018; cite EIA."');
</script>
</body>
</html>
