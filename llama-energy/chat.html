<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>LLaMA-Energy Chat</title>
<style>
  :root{--bg:#0b1220;--panel:#0f172a;--ink:#e8ebf1;--mut:#9aa4b2;--pri:#2563eb;--ok:#10b981;--warn:#f59e0b;--err:#ef4444}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font:15px system-ui,-apple-system,Segoe UI,Roboto}
  header{padding:12px 16px;background:#101b2d;font-weight:600;display:flex;gap:8px;align-items:center;justify-content:space-between;flex-wrap:wrap}
  header small{color:var(--mut);font-weight:400}
  #board{height:60vh;min-height:320px;overflow:auto;padding:14px 16px}
  .msg{max-width:78%;padding:10px 12px;border-radius:10px;margin:8px 0;white-space:pre-wrap;line-height:1.45}
  .u{margin-left:auto;background:#14325f} .a{margin-right:auto;background:#132036}
  .src{font-size:12px;color:var(--mut);margin:-2px 0 6px 6px}
  #bar{display:flex;gap:8px;padding:10px 12px;background:#101b2d;position:sticky;bottom:0}
  select,input,button{border:none;border-radius:8px}
  select{background:#132036;color:var(--ink);padding:8px}
  #q{flex:1;padding:10px;background:#0b1426;color:var(--ink)}
  button{padding:10px 14px;background:var(--pri);color:#fff;cursor:pointer} button:disabled{opacity:.6;cursor:not-allowed}
  #status{padding:6px 16px;font-size:12px;color:var(--mut);display:flex;gap:10px;flex-wrap:wrap}
  .pill{padding:2px 8px;border-radius:999px;font-size:12px}
  .ok{background:#0f2a21;color:var(--ok)} .bad{background:#2a1416;color:#ffb4b4} .warn{background:#2a2314;color:#ffd18a}
  .qs{display:flex;gap:6px;flex-wrap:wrap;padding:6px 12px}
  .qs button{background:#1e293b}
  a, a:visited{color:#93c5fd;text-decoration:none}
</style>
</head>
<body>
<header>
  <div>⚡ LLaMA-Energy Chat <small>• EIA-grounded • FERC-aware</small></div>
  <div id="health">
    <span class="pill warn">checking…</span>
  </div>
</header>

<div id="board" aria-live="polite"></div>

<div id="status">Ready.</div>

<div class="qs">
  <button type="button" data-q="Snapshot for hyperscale siting; cite EIA.">Snapshot</button>
  <button type="button" data-q="IPPs vs Direct Use since 2018; % of supply; implications.">IPPs vs Direct</button>
  <button type="button" data-q="Losses trend last 5 years; planning implication.">Losses trend</button>
</div>

<div id="bar">
  <select id="state" title="State">
    <option value="VA" selected>VA</option><option>CA</option><option>TX</option><option>NY</option>
    <option>IL</option><option>WA</option><option>FL</option><option>NC</option><option>MD</option>
  </select>
  <input id="q" placeholder="Ask about disposition, IPPs, losses, % supply, or cite a FERC docket…" />
  <button id="send">Send</button>
</div>

<script>
const API_RAG = "https://llama-energy.aristocles24.workers.dev/api/rag";
const API_STATUS = "https://llama-energy.aristocles24.workers.dev/api/status";
const API_HFSTAT = "https://llama-energy.aristocles24.workers.dev/api/hf/status";

const board = document.getElementById('board');
const q = document.getElementById('q');
const stateSel = document.getElementById('state');
const sendBtn = document.getElementById('send');
const statusEl = document.getElementById('status');
const healthEl = document.getElementById('health');

function msg(role, text, sources){
  const b=document.createElement('div'); b.className='msg '+(role==='user'?'u':'a'); b.textContent=text||''; board.appendChild(b);
  if (Array.isArray(sources) && sources.length){
    const s=document.createElement('div'); s.className='src';
    s.textContent='Sources: '+sources.map(x =>
      x.url || x.accession || x.series || x.source || JSON.stringify(x)
    ).join(' | ');
    board.appendChild(s);
  }
  board.scrollTop=board.scrollHeight;
}

async function fetchJSON(url, opts={}, timeoutMs=20000){
  const ctrl=new AbortController(); const t=setTimeout(()=>ctrl.abort(), timeoutMs);
  try{
    const res = await fetch(url, {...opts, signal: ctrl.signal});
    const ct=(res.headers.get('content-type')||'').toLowerCase();
    if(!res.ok){
      const preview = ct.includes('application/json') ? JSON.stringify(await res.json()).slice(0,300) : (await res.text()).slice(0,300);
      throw new Error(`HTTP ${res.status}: ${preview}`);
    }
    if(!ct.includes('application/json')) throw new Error(`Non-JSON (${res.status})`);
    return await res.json();
  } finally { clearTimeout(t); }
}

async function send(text){
  const state = stateSel.value;
  msg('user', text);
  setBusy(true, '⏳ querying…');
  try{
    const body = { question:text, state, context:{ persona:'hyper-unit', region:`PJM-${state}` } };
    const data = await fetchJSON(API_RAG, { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify(body) });
    msg('assistant', data.answer || '[no answer]', data.sources||[]);
    setBusy(false, '✔ ' + new Date().toLocaleTimeString());
  }catch(e){
    msg('assistant', 'Error: '+e.message);
    setBusy(false, '⚠ '+e.message);
  }
}

function setBusy(on,text){
  sendBtn.disabled = !!on;
  statusEl.textContent = text || (on ? 'Working…' : 'Ready.');
}

sendBtn.onclick = () => { const text=q.value.trim(); if(text){ q.value=''; send(text); } };
q.addEventListener('keydown', e => { if(e.key==='Enter'){ const t=q.value.trim(); if(t){ q.value=''; send(t); } } });
document.querySelectorAll('.qs button').forEach(b=> b.onclick = () => { q.value=b.dataset.q; q.focus(); });

async function diagnostics(){
  try{
    const [st, hf] = await Promise.allSettled([ fetchJSON(API_STATUS), fetchJSON(API_HFSTAT) ]);
    const pills=[]; 
    if (st.status==='fulfilled' && st.value?.ok) pills.push(`<span class="pill ok">API OK</span>`);
    else pills.push(`<span class="pill bad">API ERR</span>`);
    if (hf.status==='fulfilled') pills.push(`<span class="pill ${hf.value.token_count>0?'ok':'warn'}">HF tokens: ${hf.value.token_count}</span>`);
    else pills.push(`<span class="pill warn">HF n/a</span>`);
    healthEl.innerHTML = pills.join(' ');
  }catch{ healthEl.innerHTML = `<span class="pill bad">diag fail</span>`; }
}

// Welcome
msg('assistant','Welcome. Ask for a state snapshot (latest year, YoY, % of supply) or request FERC-aware context. Try: “VA IPPs vs direct-use since 2018; cite EIA.”');

diagnostics();
</script>
</body>
</html>
