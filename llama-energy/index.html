<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>LLaMA-Energy • Hyper-Unit Console</title>
<style>
  :root{
    --bg:#0b1220; --panel:#0f172a; --ink:#e8ebf1; --mut:#9aa4b2; --line:#1e2a3e;
    --pri:#3b82f6; --ok:#10b981; --warn:#f59e0b; --bad:#ef4444
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
  header{padding:16px 20px;border-bottom:1px solid var(--line);background:linear-gradient(180deg,#101a2e 0,#0b1220 100%)}
  .wrap{max-width:1200px;margin:0 auto}
  h1{margin:0;font-size:18px}
  .mut{color:var(--mut)}
  .topbar{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-top:6px}
  .tabs{display:flex;gap:8px}
  .tab{padding:8px 12px;border:1px solid var(--line);border-radius:10px;background:var(--panel);cursor:pointer}
  .tab.active{border-color:#2c4270;background:#0c1527}
  main{display:grid;grid-template-columns:320px 1fr;gap:14px;max-width:1200px;margin:14px auto;padding:0 20px}
  @media (max-width:980px){main{grid-template-columns:1fr}}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:14px}
  .card .hd{padding:12px 14px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between}
  .card .bd{padding:12px 14px}
  input,select,button,textarea{background:#0b1426;color:var(--ink);border:1px solid var(--line);border-radius:10px;padding:10px}
  button{cursor:pointer}
  .btn{background:var(--pri);border-color:transparent}
  .btn.secondary{background:#1a2741;border-color:#223b68}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .kv{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  .list{display:flex;flex-direction:column;gap:8px}
  .pill{padding:3px 8px;border-radius:999px;border:1px solid var(--line);color:var(--mut);font-size:12px}
  .chat{display:flex;flex-direction:column;height:520px}
  .chatlog{flex:1;overflow:auto;display:flex;flex-direction:column;gap:10px;padding:8px;background:#0b1426;border:1px solid var(--line);border-radius:10px}
  .msg{max-width:85%;padding:10px 12px;border-radius:12px;border:1px solid var(--line)}
  .u{align-self:flex-end;background:#162443}
  .a{align-self:flex-start;background:#121f33}
  .foot{display:flex;gap:8px;margin-top:8px}
  canvas{width:100%;height:300px;background:#0c1528;border:1px solid var(--line);border-radius:10px}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{padding:8px;border-top:1px solid var(--line);text-align:left}
  .hint{font-size:12px;color:var(--mut)}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>LLaMA-Energy — Hyper-Unit Console</h1>
    <div class="topbar">
      <div class="mut">Conversational analytics, tariff-aware billing, and compliance lookups for hyperscale electricity strategy.</div>
      <div class="tabs">
        <div class="tab active" data-panel="chat">Chat</div>
        <div class="tab" data-panel="analytics">Analytics</div>
        <div class="tab" data-panel="billing">Billing</div>
        <div class="tab" data-panel="compliance">Compliance</div>
      </div>
    </div>
  </div>
</header>

<main class="wrap">
  <!-- LEFT: Controls / Routines -->
  <section class="card">
    <div class="hd"><strong>Routines & Filters</strong><span class="mut mono" id="status">idle</span></div>
    <div class="bd">
      <div class="list">
        <div class="row">
          <label style="flex:1">State
            <select id="state" style="width:100%">
              <option value="VA" selected>Virginia (VA)</option>
              <option value="MD">Maryland (MD)</option>
              <option value="DC">District of Columbia (DC)</option>
              <option value="NC">North Carolina (NC)</option>
              <option value="WV">West Virginia (WV)</option>
              <option value="PA">Pennsylvania (PA)</option>
            </select>
          </label>
        </div>
        <div class="row">
          <label style="flex:1">Series (Ctrl/Cmd-click to multi-select)
            <select id="series" multiple size="6" style="width:100%">
              <option value="direct-use" selected>Direct Use</option>
              <option value="facility-direct" selected>Facility Direct</option>
              <option value="independent-power-producers" selected>Independent Power Producers</option>
              <option value="estimated-losses" selected>Estimated Losses</option>
              <option value="total-supply" selected>Total Supply</option>
              <option value="total-disposition">Total Disposition</option>
            </select>
          </label>
        </div>
        <div class="row">
          <button class="btn" id="runRoutine">Run: Hyper-Unit Snapshot</button>
          <button class="btn secondary" id="exportCsv">Export CSV</button>
        </div>
        <div class="row hint">Tip: Press <span class="pill">⌘/Ctrl + Enter</span> to ask in Chat. Press <span class="pill">L</span> to reload analytics.</div>
      </div>
    </div>
  </section>

  <!-- RIGHT: Panels -->
  <section class="card">
    <div class="bd" id="panel-chat">
      <div class="chat">
        <div class="chatlog" id="chatlog" aria-live="polite"></div>
        <div class="foot">
          <input id="prompt" class="mono" style="flex:1" placeholder="Ask about tariffs, interconnection, congestion, or ‘explain last year’s direct use in VA’…" />
          <button class="btn" id="ask">Send</button>
        </div>
        <div class="hint" style="margin-top:6px">Answers cite Worker APIs (EIA, FERC). If RAG is not wired, a local assistant provides safe hints.</div>
      </div>
    </div>

    <div class="bd" id="panel-analytics" style="display:none">
      <div class="row" style="align-items:center;justify-content:space-between;margin-bottom:8px">
        <strong>Analytics — Levels & Shares</strong>
        <button class="btn" id="reload">Load Data</button>
      </div>
      <div class="row" style="gap:12px;flex-wrap:wrap">
        <div style="flex:1;min-width:280px">
          <div class="hint">Absolute Levels (MWh)</div>
          <canvas id="levels"></canvas>
        </div>
        <div style="flex:1;min-width:280px">
          <div class="hint">% of Total Supply</div>
          <canvas id="shares"></canvas>
        </div>
      </div>
      <div style="margin-top:10px">
        <table>
          <thead><tr><th>Period</th><th>Metric</th><th>Value</th></tr></thead>
          <tbody id="tbl"></tbody>
        </table>
      </div>
    </div>

    <div class="bd" id="panel-billing" style="display:none">
      <div class="row">
        <div style="flex:1;min-width:260px">
          <div class="kv">
            <label>Monthly kWh<input type="number" id="kwh" value="12000000" class="mono"></label>
            <label>Peak kW (Demand)<input type="number" id="kw" value="25000" class="mono"></label>
            <label>On-Peak kWh<input type="number" id="kwh_on" value="7000000" class="mono"></label>
            <label>Off-Peak kWh<input type="number" id="kwh_off" value="5000000" class="mono"></label>
            <label>Energy $/kWh<input type="number" step="0.0001" id="rate_energy" value="0.085" class="mono"></label>
            <label>Demand $/kW<input type="number" step="0.01" id="rate_demand" value="16.50" class="mono"></label>
            <label>On-Peak Adder $/kWh<input type="number" step="0.0001" id="rate_on" value="0.012" class="mono"></label>
            <label>Off-Peak Adder $/kWh<input type="number" step="0.0001" id="rate_off" value="-0.004" class="mono"></label>
            <label>Rider/Adjust %<input type="number" step="0.01" id="adj_pct" value="3.5" class="mono"></label>
            <label>Power Factor %<input type="number" step="0.1" id="pf" value="97" class="mono"></label>
          </div>
          <div class="row" style="margin-top:10px">
            <button class="btn" id="calc">Estimate Bill</button>
            <button class="btn secondary" id="explain">Explain Drivers</button>
          </div>
        </div>
        <div style="flex:1;min-width:280px">
          <div class="card" style="background:#0b1426;border-color:#14243e">
            <div class="hd"><strong>Bill Summary</strong><span class="mut">Tariff-aware sketch</span></div>
            <div class="bd" id="bill_out">
              <div class="mut">Enter values and click <b>Estimate Bill</b>.</div>
            </div>
          </div>
        </div>
      </div>
      <div class="hint" style="margin-top:8px">Note: Real tariff rules (ratchets, seasonal tiers, riders) vary by utility; plug your tariff book via RAG for exacts.</div>
    </div>

    <div class="bd" id="panel-compliance" style="display:none">
      <div class="row" style="align-items:center;gap:8px">
        <input id="accession" class="mono" placeholder="FERC accession (e.g., 20110106-3009)" style="flex:1">
        <button class="btn" id="docinfoBtn">Fetch Docinfo</button>
      </div>
      <div id="docinfo" class="mut" style="margin-top:10px;white-space:pre-wrap;max-height:300px;overflow:auto;border:1px solid var(--line);border-radius:10px;padding:10px;background:#0c1526"></div>
      <div class="hint" style="margin-top:8px">Pipe docinfo → parser → Qdrant for compliance tags (topic, deadline, obligations, jurisdiction).</div>
    </div>
  </section>
</main>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<script>
/* ======================= CONFIG ======================= */
// Set to your Worker URL (e.g., "https://llama-energy-worker.YOUR.workers.dev")
// or leave "" if your domain routes /api/* to the Worker:
const API_BASE = "";

/* ======================= UTIL ========================= */
const $ = s => document.querySelector(s);
const on = (el,ev,fn)=> el.addEventListener(ev,fn);
const chartColors = ['#60a5fa','#f59e0b','#10b981','#ef4444','#a78bfa','#f472b6'];
function qs(params){return new URLSearchParams(params).toString()}
function api(path, params){ return `${API_BASE}${path}${params ? ("?"+qs(params)) : ""}` }
function money(x){ return "$" + (Number(x||0).toFixed(2)).replace(/\B(?=(\d{3})+(?!\d))/g,',') }

/* ======================= TABS ========================= */
const tabs = document.querySelectorAll('.tab');
tabs.forEach(t=>{
  on(t,'click',()=>{
    tabs.forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    const panel = t.dataset.panel;
    ['chat','analytics','billing','compliance'].forEach(p=>{
      $('#panel-'+p).style.display = (p===panel)?'block':'none';
    });
  })
});

/* =================== CHAT / RAG ======================= */
const chatlog = $('#chatlog');
function pushMsg(text, role){ const b=document.createElement('div'); b.className='msg '+(role==='user'?'u':'a'); b.textContent=text; chatlog.appendChild(b); chatlog.scrollTop=chatlog.scrollHeight; }
async function ragAsk(q){
  const url = api('/api/rag', { q });
  try{
    const r = await fetch(url); // if 404, fallback
    if(!r.ok) throw new Error('no rag');
    const j = await r.json();
    return j.answer || JSON.stringify(j);
  }catch{
    // Local safe fallback
    return "Here’s a structured approach:\n• If tariff-specific: provide the utility, rider, season, TOU windows.\n• For EIA analytics: use the Analytics tab; shares show hyper-unit trends.\n• For compliance: fetch FERC docinfo by accession, then parse obligations & deadlines.";
  }
}
async function handleAsk(){
  const q = $('#prompt').value.trim(); if(!q) return;
  pushMsg(q,'user'); $('#prompt').value=''; $('#status').textContent='thinking…';
  const a = await ragAsk(q);
  pushMsg(a,'assistant'); $('#status').textContent='idle';
}

/* Keyboard shortcuts */
on(document,'keydown',e=>{
  if((e.ctrlKey||e.metaKey) && e.key==='Enter'){ e.preventDefault(); handleAsk(); }
  if(e.key.toLowerCase()==='l'){ e.preventDefault(); loadAnalytics(); }
});

/* =================== ANALYTICS ======================== */
let levelsChart, sharesChart, lastPayload;
async function fetchEIA(state, series){
  const url = api('/api/eia', { state, series: series.join(',') });
  const r = await fetch(url, { headers:{'Accept':'application/json'}});
  if(!r.ok){ const t=await r.text(); throw new Error(`API ${r.status}: ${t.slice(0,280)}`); }
  return r.json();
}
function drawChart(ctx, labels, datasets, isShare=false){
  const sets = datasets.map((d,i)=>({
    label:d.label, data:d.data,
    borderColor:chartColors[i%chartColors.length],
    backgroundColor:chartColors[i%chartColors.length] + (isShare?'33':'55'),
    fill:isShare, tension:0.2, pointRadius:2
  }));
  return new Chart(ctx, {
    type:'line',
    data:{ labels, datasets: sets },
    options:{ plugins:{ legend:{position:'bottom'} },
      scales:{ y:{ title:{ display:true, text:isShare? '% of Total Supply':'MWh' }}}}
  });
}
async function loadAnalytics(){
  $('#status').textContent='loading…';
  const state = $('#state').value || 'VA';
  const series = Array.from($('#series').selectedOptions).map(o=>o.value);
  try{
    const payload = await fetchEIA(state, series);
    lastPayload = payload;
    const { periods, levels, shares } = payload;
    const levelKeys = Object.keys(levels||{});
    const shareKeys = Object.keys(shares||{});
    const levelDatasets = levelKeys.map(k=>({label:k, data:levels[k].map(v=>v??null)}));
    const shareDatasets = shareKeys.map(k=>({label:k, data:shares[k].map(v=>Number.isFinite(v)?Number(v.toFixed(2)):0)}));
    if(levelsChart) levelsChart.destroy();
    if(sharesChart) sharesChart.destroy();
    levelsChart = drawChart($('#levels'), periods, levelDatasets, false);
    sharesChart = drawChart($('#shares'), periods, shareDatasets, true);

    // Populate table (latest year)
    const tbody = $('#tbl'); tbody.innerHTML='';
    const n = periods.length, i = n? n-1 : -1;
    if(i>=0){
      levelKeys.forEach(k=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${periods[i]}</td><td>${k}</td><td>${(levels[k][i]??'—').toLocaleString?.()||levels[k][i]||'—'}</td>`;
        tbody.appendChild(tr);
      });
      shareKeys.forEach(k=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${periods[i]}</td><td>${k}</td><td>${(shares[k][i]??0).toFixed(2)} %</td>`;
        tbody.appendChild(tr);
      });
    }
  }catch(err){
    alert(err.message);
  }finally{
    $('#status').textContent='idle';
  }
}
on($('#reload'),'click',loadAnalytics);
on($('#runRoutine'),'click',loadAnalytics);
on($('#exportCsv'),'click',()=>{
  if(!lastPayload) return alert('Load analytics first.');
  const { periods, levels, shares } = lastPayload;
  const cols = ['period', ...Object.keys(levels||{}), ...Object.keys(shares||{})];
  const rows = [cols.join(',')];
  for(let i=0;i<periods.length;i++){
    const line = [periods[i]];
    Object.keys(levels||{}).forEach(k=> line.push(levels[k][i] ?? ''));
    Object.keys(shares||{}).forEach(k=> line.push(shares[k][i] ?? ''));
    rows.push(line.join(','));
  }
  const blob = new Blob([rows.join('\n')], {type:'text/csv'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob); a.download = `llama-energy_${($('#state').value||'VA')}.csv`;
  document.body.appendChild(a); a.click(); a.remove();
});

/* =================== BILLING ========================== */
function estimateBill(){
  const kwh = +$('#kwh').value||0, kw = +$('#kw').value||0;
  const kwh_on= +$('#kwh_on').value||0, kwh_off= +$('#kwh_off').value||0;
  const rate_energy= +$('#rate_energy').value||0;
  const rate_demand= +$('#rate_demand').value||0;
  const rate_on= +$('#rate_on').value||0, rate_off= +$('#rate_off').value||0;
  const adj_pct= (+$('#adj_pct').value||0)/100;
  const pf = (+$('#pf').value||100)/100;

  // Sketch: energy + demand + TOU adders + riders; PF penalty if PF<95%
  const energy = kwh * rate_energy;
  const tou = (kwh_on * rate_on) + (kwh_off * rate_off);
  const demand = kw * rate_demand;
  const subtotal = energy + demand + tou;
  const rider = subtotal * adj_pct;
  const pfPenalty = (pf < 0.95) ? subtotal * (0.95 - pf) * 0.1 : 0; // simple placeholder
  const total = subtotal + rider + pfPenalty;

  return { energy, demand, tou, rider, pfPenalty, total };
}
function explainBill(b){
  const lines = [];
  lines.push(`Energy: ${money(b.energy)} • Demand: ${money(b.demand)} • TOU Adj: ${money(b.tou)}`);
  lines.push(`Riders/Adjust: ${money(b.rider)} • Power Factor Penalty: ${money(b.pfPenalty)}`);
  lines.push(`Total: ${money(b.total)}`);
  lines.push(`Drivers: high peak kW inflates demand charges; TOU windows shift marginal costs; riders add pass-throughs (fuel/RECs/EE).`);
  lines.push(`Next steps: evaluate load shifting, on-site gen/PPAs, demand response, and conductor upgrades near congested nodes.`);
  return lines.join('\n');
}
on($('#calc'),'click',()=>{
  const b = estimateBill();
  $('#bill_out').innerHTML = `
    <div>Energy: <b>${money(b.energy)}</b></div>
    <div>Demand: <b>${money(b.demand)}</b></div>
    <div>TOU Adj: <b>${money(b.tou)}</b></div>
    <div>Riders/Adj: <b>${money(b.rider)}</b></div>
    <div>Power Factor Penalty: <b>${money(b.pfPenalty)}</b></div>
    <hr style="border:0;border-top:1px solid var(--line);margin:8px 0">
    <div style="font-size:18px">Total: <b>${money(b.total)}</b></div>
  `;
});
on($('#explain'),'click',()=>{
  const b = estimateBill();
  $('#bill_out').textContent = explainBill(b);
});

/* =================== COMPLIANCE ======================= */
on($('#docinfoBtn'),'click', async ()=>{
  const acc = ($('#accession').value||'').trim();
  if(!/^\d{8}-\d{4}$/.test(acc)) return alert('Use accession like 20110106-3009');
  const r = await fetch(api('/api/ferc/docinfo',{ accession:acc }));
  if(!r.ok) { $('#docinfo').textContent = `Error ${r.status}`; return; }
  const html = await r.text();
  $('#docinfo').textContent = html.replace(/<[^>]+>/g,' ').replace(/\s+/g,' ').slice(0,10000);
});

/* =================== INIT ============================= */
on($('#ask'),'click',handleAsk);
on($('#prompt'),'keydown',e=>{ if(e.key==='Enter' && !e.shiftKey) { e.preventDefault(); handleAsk(); }});
window.addEventListener('load',()=>{
  pushMsg("Hello—ask me about tariffs, interconnection, and grid strategy. Try: “Compare VA direct-use vs IPPs last 5 years.”","assistant");
});
</script>
</body>
</html>
