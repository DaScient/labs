<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>RAG Ubiq — Universal RAG UI</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  :root{
    --bg:#0b0e14; --panel:#131827; --muted:#8a93a6; --txt:#eef2ff; --line:#243047; --acc:#5aa9ff;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#0b0e14 0%,#0f1422 100%);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto;color:var(--txt)}
  header{padding:18px 20px;border-bottom:1px solid var(--line);position:sticky;top:0;background:rgba(11,14,20,.85);backdrop-filter:blur(8px)}
  h1{margin:0;font-size:18px;letter-spacing:.5px}
  main{max-width:1100px;margin:22px auto;padding:0 16px;display:grid;grid-template-columns:380px 1fr;gap:16px}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .pad{padding:16px}
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  input[type="text"], textarea, select{
    width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#0e1422;color:var(--txt);
    outline:none;caret-color:var(--acc)
  }
  textarea{min-height:120px;resize:vertical}
  .row{display:flex;gap:10px}
  .row > *{flex:1}
  .btn{background:var(--acc);color:#051225;border:0;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .muted{color:var(--muted)}
  .split{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .pill{display:inline-flex;align-items:center;gap:8px;background:#0f1a2b;border:1px solid var(--line);padding:8px 10px;border-radius:12px}
  .sources{display:grid;gap:8px;margin-top:12px}
  .src{border:1px dashed var(--line);padding:10px;border-radius:10px;background:#0f1627}
  pre{white-space:pre-wrap;word-wrap:break-word}
  .chat{display:flex;flex-direction:column;gap:12px;height:560px}
  .chat-box{flex:1;overflow:auto;padding:12px;border:1px solid var(--line);border-radius:12px;background:#0e1422}
  .bubble{padding:12px 14px;border-radius:12px;margin:8px 0;max-width:100%}
  .u{background:#0f1a2a;border:1px solid #1c2b46}
  .a{background:#0f1828;border:1px solid #1a2942}
  .foot{display:flex;gap:8px;margin-top:8px}
  .files{border:1px dashed var(--line);padding:10px;border-radius:10px;background:#0f1322}
  .tiny{font-size:11px}
</style>
</head>
<body>
<header><h1>RAG Ubiq — Universal RAG UI</h1></header>
<main>
  <!-- Left: Indexing -->
  <section class="card pad">
    <h3 style="margin-top:0">Index Content</h3>
    <div class="split">
      <div>
        <label>Title (optional)</label>
        <input id="title" type="text" placeholder="e.g., Product Handbook v3">
      </div>
      <div>
        <label>Tags (comma-separated)</label>
        <input id="tags" type="text" placeholder="finance, policy, SOP">
      </div>
    </div>
    <div style="margin-top:12px">
      <label>Paste Text / Markdown</label>
      <textarea id="text" placeholder="Paste clean text or markdown here..."></textarea>
    </div>
    <div class="row" style="margin-top:10px">
      <div>
        <label>Source URL (optional)</label>
        <input id="url" type="text" placeholder="https://…">
      </div>
      <div>
        <label>Source ID (auto if blank)</label>
        <input id="sourceId" type="text" placeholder="SRC_…">
      </div>
    </div>
    <div style="margin-top:12px" class="files">
      <label>Or Upload Files (.txt/.md recommended)</label>
      <input id="files" type="file" multiple accept=".txt,.md,.csv,.log">
      <div class="tiny muted">Note: PDFs/Office docs should be converted to text before upload for best results.</div>
    </div>
    <div style="display:flex;gap:8px;margin-top:12px">
      <button class="btn" id="btnIndexText">Index Pasted Text</button>
      <button class="btn" id="btnIndexFiles">Index Files</button>
      <button class="pill" id="btnRefreshSources" title="Refresh source list">↻ Refresh Sources</button>
    </div>
    <div style="margin-top:14px">
      <label class="muted">Sources</label>
      <div class="sources" id="sources"></div>
    </div>
  </section>

  <!-- Right: Chat -->
  <section class="card pad">
    <h3 style="margin-top:0">Ask with RAG</h3>
    <div class="row">
      <div>
        <label>Top-K</label>
        <input id="topk" type="text" value="6">
      </div>
      <div>
        <label>Temperature</label>
        <input id="temp" type="text" value="0.2">
      </div>
    </div>
    <div class="chat">
      <div id="chatBox" class="chat-box"></div>
      <div class="foot">
        <input id="query" type="text" placeholder="Ask a question…">
        <button class="btn" id="btnAsk">Ask</button>
      </div>
    </div>
  </section>
</main>

<script>
  // === Configure your worker URL here ===
  const WORKER_BASE = location.origin.includes("localhost") ? "http://127.0.0.1:8787" : location.origin;

  const qs = s => document.querySelector(s);
  const chatBox = qs("#chatBox");

  function addBubble(text, who="a") {
    const div = document.createElement("div");
    div.className = "bubble " + who;
    div.innerHTML = text;
    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  async function indexText() {
    const text = qs("#text").value.trim();
    if (!text) return alert("Paste some text first.");
    disable(true);
    try {
      const payload = {
        text,
        title: qs("#title").value.trim() || null,
        url: qs("#url").value.trim() || null,
        tags: qs("#tags").value.trim(),
        sourceId: qs("#sourceId").value.trim() || null
      };
      const res = await fetch(WORKER_BASE + "/api/index", {
        method: "POST",
        headers: {"content-type":"application/json"},
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || res.statusText);
      alert(`Indexed: ${data.chunks} chunks\nSource: ${data.sourceId}`);
      qs("#sourceId").value = data.sourceId;
      await refreshSources();
    } catch(e){ alert(e.message) } finally { disable(false) }
  }

  async function indexFiles() {
    const files = qs("#files").files;
    if (!files.length) return alert("Choose at least one file.");
    disable(true);
    try {
      const fd = new FormData();
      fd.append("title", qs("#title").value.trim());
      fd.append("url", qs("#url").value.trim());
      fd.append("tags", qs("#tags").value.trim());
      if (qs("#sourceId").value.trim()) fd.append("sourceId", qs("#sourceId").value.trim());
      for (const f of files) fd.append("files", f, f.name);
      const res = await fetch(WORKER_BASE + "/api/index", { method:"POST", body: fd });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || res.statusText);
      alert(`Indexed: ${data.chunks} chunks\nSource: ${data.sourceId}`);
      qs("#sourceId").value = data.sourceId;
      await refreshSources();
    } catch(e){ alert(e.message) } finally { disable(false) }
  }

  async function ask() {
    const q = qs("#query").value.trim();
    if (!q) return;
    addBubble(q.replace(/</g,"&lt;"), "u");
    qs("#query").value = "";
    disable(true);
    try {
      const res = await fetch(WORKER_BASE + "/api/query", {
        method:"POST",
        headers: {"content-type":"application/json"},
        body: JSON.stringify({
          query: q,
          top_k: parseInt(qs("#topk").value || "6", 10),
          temperature: parseFloat(qs("#temp").value || "0.2")
        })
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || res.statusText);
      const cited = linkifySources(data.answer || "", data.sources || []);
      addBubble(cited, "a");
    } catch(e){ addBubble("Error: " + e.message, "a"); }
    finally { disable(false); }
  }

  function linkifySources(answer, sources) {
    // Replace [S<id>] patterns with titles/links where possible. We used sourceId as S# for simplicity.
    const idToTitle = {}, idToUrl = {};
    sources.forEach((s, i) => {
      idToTitle[s.sourceId] = s.title || ("Source " + (i+1));
      idToUrl[s.sourceId] = s.url || "";
    });
    return answer.replace(/\[S(\w+)\]/g, (_, sid) => {
      const t = idToTitle["SRC_" + sid] || idToTitle[sid] || "Source";
      const u = idToUrl["SRC_" + sid] || idToUrl[sid] || "";
      return u ? `<a href="${u}" target="_blank" rel="noopener">[${t}]</a>` : `[${t}]`;
    });
  }

  async function refreshSources() {
    const box = qs("#sources");
    box.innerHTML = "<div class='muted tiny'>Loading…</div>";
    const res = await fetch(WORKER_BASE + "/api/sources");
    const data = await res.json();
    if (!res.ok) { box.textContent = data.error || res.statusText; return; }
    box.innerHTML = "";
    (data.sources || []).forEach(s => {
      const el = document.createElement("div");
      el.className = "src";
      el.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
          <div>
            <div><strong>${escapeHtml(s.title)}</strong></div>
            <div class="tiny muted">ID: ${s.sourceId} • Chunks: ${s.chunks} • ${(s.bytes/1024).toFixed(1)} KB</div>
            ${s.url ? `<div class="tiny"><a href="${s.url}" target="_blank" rel="noopener">${s.url}</a></div>` : ""}
          </div>
          <button class="pill tiny" data-del="${s.sourceId}">Delete</button>
        </div>`;
      box.appendChild(el);
      el.querySelector("[data-del]").onclick = async () => {
        if (!confirm("Delete this source and all vectors?")) return;
        const resp = await fetch(WORKER_BASE + "/api/source?id=" + encodeURIComponent(s.sourceId), { method: "DELETE" });
        const j = await resp.json();
        if (!resp.ok) alert(j.error || resp.statusText);
        await refreshSources();
      };
    });
  }

  function escapeHtml(s){ return (s||"").replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
  function disable(flag){
    ["btnAsk","btnIndexText","btnIndexFiles","btnRefreshSources","query","text","files","title","tags","url","sourceId","topk","temp"]
    .forEach(id => { const el = qs("#"+id); if (el) el.disabled = flag; });
  }

  qs("#btnIndexText").onclick = indexText;
  qs("#btnIndexFiles").onclick = indexFiles;
  qs("#btnAsk").onclick = ask;
  qs("#query").addEventListener("keydown", e => { if (e.key === "Enter") qs("#btnAsk").click(); });
  qs("#btnRefreshSources").onclick = refreshSources;
  refreshSources();
</script>
</body>
</html>
