<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>ASCII — Analyzed + AI Summary</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  /* bare terminal */
  html,body{height:100%}
  body{margin:0;background:#000;color:#9affb3;font:14px/1.6 ui-monospace,Menlo,Consolas,monospace;white-space:pre-wrap}
  #t{padding:10px}
  a{color:#7fffd4;text-decoration:none}
  .dim{color:#6fdc95}
</style>
</head>
<body>
<pre id="t">[boot] analyzer online…</pre>
<script>
"use strict";

/* ========== tiny term ========= */
const T = document.getElementById('t');
const now = () => new Date().toISOString().replace('T',' ').replace(/\..+/,'');
const println = (s='') => { T.textContent += '\n' + s; T.scrollTop = T.scrollHeight; };

/* ========== params ========== */
const q = new URLSearchParams(location.search);
const get = (k,d=null)=> q.get(k) ?? d;

const INTERVAL = Math.max(30, parseInt(get('interval','180')) || 180);
const FEEDS_URL = get('feedsUrl','/labs/configs/feeds.txt');
const CORS_BASE = get('corsBase','/');       // "/", "/cors", or absolute
const GEN_BASE  = get('genBase','');         // e.g., https://your-worker.example.com/gen
const MODEL     = get('model','heuristic');  // "heuristic" means local summarizer
const MAX_ANALYZED = Math.max(1000, parseInt(get('maxAnalyzedChars','6000')) || 6000);

/* ========== util ========== */
async function fetchText(url, corsBase){
  if(!corsBase){
    const r = await fetch(url, {headers:{'Accept':'application/rss+xml,text/xml,text/html'}});
    if(!r.ok) throw new Error(r.status);
    return await r.text();
  }
  const base = new URL(corsBase, location.origin);
  if(!base.pathname.endsWith('/cors')) base.pathname = base.pathname.replace(/\/$/,'') + '/cors';
  base.searchParams.set('url', url);
  const r = await fetch(base.toString(), {cache:'no-cache'});
  if(!r.ok) throw new Error(r.status);
  return await r.text();
}

function parseFeed(xmlTxt){
  const doc = new DOMParser().parseFromString(xmlTxt,'application/xml');
  let items = Array.from(doc.querySelectorAll('item')); 
  if(!items.length) items = Array.from(doc.querySelectorAll('entry'));
  return items.map(n=>({
    title:(n.querySelector('title')?.textContent||'').trim(),
    link:(n.querySelector('link')?.getAttribute('href')||n.querySelector('link')?.textContent||'').trim(),
    guid:(n.querySelector('guid')?.textContent||n.querySelector('id')?.textContent||'').trim(),
    published:(n.querySelector('pubDate')?.textContent||n.querySelector('updated')?.textContent||'').trim()
  }));
}

function extractReadable(html){
  const doc = new DOMParser().parseFromString(html,'text/html');
  doc.querySelectorAll('script,style,noscript,iframe,header,footer,nav').forEach(e=>e.remove());
  const blocks=[];
  doc.querySelectorAll('p,article,section,div').forEach(el=>{
    const txt=(el.textContent||'').replace(/\s+/g,' ').trim();
    if(txt.split(' ').length>=12) blocks.push({txt,score:txt.length});
  });
  blocks.sort((a,b)=>b.score-a.score);
  const best = blocks.slice(0,8).map(b=>b.txt).join('\n\n');
  return best || (doc.body?.innerText||'').trim();
}

/* ========== local (heuristic) summarizer ========== */
const SENT_SPLIT=/([.!?])\s+/g;
function sentences(t){ if(!t) return []; return t.split(SENT_SPLIT).reduce((a,c,i,arr)=>{ if(i%2===0){ const s=(c+(arr[i+1]||'')).trim(); if(s) a.push(s)} return a},[]) }
function words(t){ return (t.toLowerCase().match(/[a-z0-9]{3,}/g)||[]) }

function textrank(text, topN=10){
  const s = sentences(text), n=s.length;
  const toks = s.map(x=>new Set(words(x)));
  const M = Array.from({length:n},()=>Array(n).fill(0));
  for(let i=0;i<n;i++) for(let j=i+1;j<n;j++){
    const A=toks[i], B=toks[j];
    const inter=[...A].filter(x=>B.has(x)).length;
    const den=Math.log(A.size+1)+Math.log(B.size+1);
    const sim=den>0? inter/den : 0;
    M[i][j]=M[j][i]=sim;
  }
  let rank=Array(n).fill(1/n), d=.85;
  for(let it=0; it<30; it++){
    const nr=Array(n).fill((1-d)/n);
    for(let i=0;i<n;i++){
      const deg=M[i].reduce((a,b)=>a+b,0);
      if(deg>0){ for(let j=0;j<n;j++) if(M[i][j]>0) nr[j]+=d*(M[i][j]/deg)*rank[i]; }
    }
    rank=nr;
  }
  const idx=rank.map((v,i)=>[i,v]).sort((a,b)=>b[1]-a[1]).slice(0,topN).map(x=>x[0]).sort((a,b)=>a-b);
  return idx.map(i=>s[i]).join(' ');
}

function heuristicSummary(text){
  // short, clean operator-focused summary
  const core = textrank(text, 8);
  const s = sentences(core);
  return s.slice(0,6).join(' ');
}

/* ========== remote AI (optional via Worker) ========== */
async function aiSummary(text, model){
  if(!GEN_BASE || model==='heuristic') return heuristicSummary(text);
  const r = await fetch(GEN_BASE, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({
      model,
      input: `Summarize the following article for tech/business leaders. 
      Requirements: 6-10 sentences, crisp, neutral, actionable; avoid fluff; ASCII only; no bullets.
      TEXT:
      """${text.slice(0, 8000)}"""` // limit payload
    })
  });
  if(!r.ok){
    println(`[${now()}] GEN ERR :: ${r.status} (falling back to heuristic)`);
    return heuristicSummary(text);
  }
  const data = await r.json().catch(()=>null);
  const out = (data && (data.output_text || data.text || data.summary || '')) || '';
  return (out.trim() ? out.trim() : heuristicSummary(text));
}

/* ========== engine ========== */
let seen = new Set();

async function processItem(feedUrl, item){
  const fp = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(feedUrl+'|'+item.guid+'|'+item.link));
  const key = Array.from(new Uint8Array(fp)).map(b=>b.toString(16).padStart(2,'0')).join('');
  if(seen.has(key)) return; seen.add(key);

  println(`\n[${now()}] ${item.title}`);
  println(`SRC  :: ${item.link}`);
  try{
    const html = await fetchText(item.link, CORS_BASE);
    const raw  = extractReadable(html);
    if(!raw || raw.split(' ').length < 60){ println(`(skipped: not enough content)`); return; }

    // analyzed text (trim for readability)
    const analyzed = raw.slice(0, MAX_ANALYZED).trim();
    println(`\n--- ARTICLE ANALYZED TEXT ---\n${analyzed}\n`);

    // AI enriched summary (or heuristic)
    const summary = await aiSummary(raw, MODEL);
    println(`--- AI-ENRICHED SUMMARY [model=${MODEL}] ---\n${summary}\n`);
    println(`------------------------------------------------------------`);
    parent.postMessage({type:'AIRTICLE_HEIGHT', height:document.documentElement.scrollHeight}, '*');
  }catch(e){
    println(`ERR  :: ${e}`);
  }
}

async function loadList(u){
  const abs = u.startsWith('http') ? u : new URL(u, location.origin).toString();
  const r = await fetch(abs, {cache:'no-cache'}); if(!r.ok) throw new Error(r.status);
  return (await r.text()).split('\n').map(s=>s.trim()).filter(Boolean);
}

async function pollOnce(){
  for(const f of window.FEEDS){
    try{
      const xml = await fetchText(f, CORS_BASE);
      const items = parseFeed(xml).slice(0, 5);
      for(const it of items) await processItem(f, it);
    }catch(e){
      println(`[${now()}] FEED ERR :: ${f} → ${e}`);
    }
  }
}

(async function boot(){
  try{ window.FEEDS = await loadList(FEEDS_URL); }
  catch(e){
    window.FEEDS = [
      'https://rss.nytimes.com/services/xml/rss/nyt/HomePage.xml',
      'https://feeds.washingtonpost.com/rss/national',
      'https://www.forbes.com/most-popular/feed/'
    ];
    println(`[${now()}] WARN :: using default feeds (${e})`);
  }
  println(`[${now()}] START :: interval=${INTERVAL}s feeds=${window.FEEDS.length} model=${MODEL}`);
  await pollOnce();
  if(get('autoStart','1')==='1') setInterval(pollOnce, INTERVAL*1000);
})();
</script>
</body>
</html>
