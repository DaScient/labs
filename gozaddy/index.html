<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>AI-Generated News Summaries</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root{
    --bg:#fff; --text:#0b1220; --muted:#667085; --border:#e5e7eb; --pill:#f3f4f6; --accent:#0f6fff;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;line-height:1.6}
  header{position:sticky;top:0;z-index:10;background:rgba(255,255,255,.92);backdrop-filter:saturate(140%) blur(6px);border-bottom:1px solid var(--border)}
  .wrap{max-width:900px;margin:0 auto;padding:16px}
  h1{margin:0;font-size:26px;font-weight:800}
  .meta{font-size:13px;color:var(--muted)}
  main{padding:18px 0 60px}
  .card{border:1px solid var(--border);border-radius:14px;padding:16px;margin:14px 0;background:#fff}
  .title{font-size:20px;font-weight:800;margin:0 0 6px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;color:var(--muted);font-size:13px;margin-bottom:8px}
  .pill{display:inline-block;padding:4px 8px;border:1px solid var(--border);border-radius:999px;background:var(--pill);color:#111;font-size:12px}
  .kw{display:inline-block;margin:6px 6px 0 0;padding:4px 8px;border:1px dashed var(--border);border-radius:999px;font-size:12px;color:#0b1220;background:#fff}
  a{color:var(--accent);text-decoration:none} a:hover{text-decoration:underline}
  .blink{animation:blink .8s ease 1} @keyframes blink{50%{box-shadow:0 0 0 3px rgba(15,111,255,.18)}}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>AI-Generated News Summaries</h1>
    <div class="meta" id="status">Loading…</div>
  </div>
</header>

<main class="wrap" id="list"></main>

<script>
/* CONFIG */
const API_BASE = "https://gozaddy.aristocles24.workers.dev";
const DEFAULT_FEEDS = [
  "https://rss.nytimes.com/services/xml/rss/nyt/HomePage.xml",
  "https://feeds.washingtonpost.com/rss/national",
  "https://feeds.reuters.com/reuters/topNews",
  "https://www.aljazeera.com/xml/rss/all.xml",
  "https://feeds.npr.org/1001/rss.xml",
  "https://feeds.bbci.co.uk/news/rss.xml"
];
const LIMIT = 18;
const SERVER_INTERVAL_SEC = 3600; // cache window at Worker
let REFRESH_MS = 60_000; // default 60s; override via ?refresh=ms

/* Helpers */
const $ = (s)=>document.querySelector(s);
function host(href){ try{ return new URL(href).hostname.replace(/^www\./,''); }catch{ return ""; } }
function qs(name){ const u=new URL(location.href); return u.searchParams.get(name); }

/* Build URL */
function buildUrl(){
  const feeds = qs("feeds") ? qs("feeds").split(",") : DEFAULT_FEEDS;
  const refresh = parseInt(qs("refresh")||"",10);
  if(!isNaN(refresh) && refresh>1000) REFRESH_MS = refresh;
  const f = encodeURIComponent(feeds.join(","));
  return `${API_BASE}/summaries?feeds=${f}&limit=${LIMIT}&interval=${SERVER_INTERVAL_SEC}`;
}

/* Render */
function render(items){
  const root = $("#list"); root.innerHTML = "";
  if(!items.length){ root.innerHTML = `<div class="meta">No articles yet.</div>`; return; }

  for(const it of items){
    const card = document.createElement("article");
    card.className = "card";
    card.innerHTML = `
      <h2 class="title">${escapeHTML(it.title || "(untitled)")}</h2>
      <div class="row">
        ${it.source ? `<span class="pill">${escapeHTML(it.source)}</span>`: ""}
        ${it.published ? `<span class="meta">${escapeHTML(it.published)}</span>`: ""}
        ${it.link ? `<a href="${it.link}" target="_blank" rel="noopener">Open source</a>` : ""}
        <span class="meta">Confidence: ${it.confidence ?? "—"}</span>
      </div>
      <div class="body">${paraHTML(it.summary || "")}</div>
      <div class="row" style="margin-top:8px">${(it.keywords||[]).map(k=>`<span class="kw">${escapeHTML(k)}</span>`).join("")}</div>
    `;
    root.appendChild(card);
  }
}
function paraHTML(text){
  // split into short paragraphs
  const chunks = (text || "").split(/\n{2,}/).map(s=>s.trim()).filter(Boolean);
  if(!chunks.length) return `<p>${escapeHTML(text)}</p>`;
  return chunks.map(p=>`<p>${escapeHTML(p)}</p>`).join("");
}
function escapeHTML(s){
  return (s||"").replace(/[&<>"]/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[c]));
}

/* Live loop */
let LAST_SIG = "";
async function tick(){
  try{
    const url = buildUrl();
    const r = await fetch(url + "&_t=" + Date.now(), { cache: "no-store" });
    if(!r.ok) throw new Error("Fetch failed " + r.status);
    const data = await r.json();
    const items = (data.items || []);
    const sig = JSON.stringify(items.slice(0, 12).map(x=>x.title));
    if(sig !== LAST_SIG){
      render(items);
      LAST_SIG = sig;
      $("#list").classList.add("blink");
      setTimeout(()=>$("#list").classList.remove("blink"), 900);
    }
    $("#status").textContent = `Updated ${new Date().toLocaleString()} • ${items.length} articles`;
  }catch(e){
    $("#status").textContent = "Error: " + e;
    console.error(e);
  }finally{
    setTimeout(tick, REFRESH_MS);
  }
}
tick();
</script>
</body>
</html>
