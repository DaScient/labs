<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>AI-Generated News Summaries</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root{
    --bg:#ffffff; --text:#0b1220; --muted:#667085; --accent:#0f6fff;
    --card:#ffffff; --border:#e5e7eb;
  }
  *{box-sizing:border-box}
  body{ margin:0; background:var(--bg); color:var(--text);
        font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial; line-height:1.55; }
  header{ position:sticky; top:0; z-index:10; background:rgba(255,255,255,.92);
          backdrop-filter:saturate(140%) blur(6px); border-bottom:1px solid var(--border); }
  .wrap{ max-width:1100px; margin:0 auto; padding:16px; }
  h1{ margin:0; font-size:24px; font-weight:800; letter-spacing:.2px; }
  .toolbar{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:8px; }
  .pill{ display:inline-block; padding:6px 10px; border:1px solid var(--border); border-radius:999px; font-size:12px; color:#111; background:#f8fafc }
  .btn{ padding:8px 12px; border:1px solid var(--border); border-radius:10px; background:#fff; cursor:pointer; }
  .btn:hover{ border-color:#cbd5e1 }
  main{ padding:18px 0 60px }
  .card{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px 16px; margin:12px 0; }
  .title{ font-weight:800; font-size:22px; margin-bottom:6px; line-height:1.25 }
  .meta{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; font-size:13px; color:var(--muted); }
  .host{ display:inline-block; padding:4px 8px; border:1px solid var(--border); border-radius:999px; background:#f9fafb; color:#0b1220; font-weight:600 }
  .summary{ margin-top:12px; font-size:16px }
  .keywords{ margin-top:8px; color:#555; font-size:13px }
  .actions{ display:flex; gap:8px; flex-wrap:wrap; margin-top:12px }
  a{ color:var(--accent); text-decoration:none } a:hover{ text-decoration:underline }
  .good{ color:#15803d } .warn{ color:#b45309 } .bad{ color:#b91c1c }
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>AI-Generated News Summaries</h1>
    <div class="toolbar">
      <span id="last" class="pill">Last updated: â€¦</span>
      <span id="ref" class="pill">Refresh: 60s</span>
      <button id="refresh" class="btn">Refresh now</button>
    </div>
  </div>
</header>

<main class="wrap">
  <div id="list"></div>
</main>

<script>
const WORKER = "https://gozaddy.aristocles24.workers.dev";
const FEEDS_URL_DEFAULT = "https://raw.githubusercontent.com/DaScient/labs/main/gozaddy/feeds.txt";

const q = new URLSearchParams(location.search);
const refreshMs = Math.max(20_000, parseInt(q.get("refresh")||"60000",10));
const feedsUrl = q.get("feedsUrl") || FEEDS_URL_DEFAULT;
document.getElementById("ref").textContent = "Refresh: " + Math.round(refreshMs/1000) + "s";

const SUM_URL = WORKER + "/summaries?feedsUrl=" + encodeURIComponent(feedsUrl) + "&limit=50&interval=3600";

function hostOf(link){
  try{ return new URL(link).hostname.replace(/^www\./,''); }catch(_){ return ""; }
}
function gradeClass(score){ return score>=70?"good":score>=45?"warn":"bad"; }
function uniq(items){
  const seen=new Set(), out=[];
  for(const a of items){
    const k=((a.link||"") + "|" + (a.title||"")).toLowerCase();
    if(seen.has(k)) continue; seen.add(k); out.push(a);
  }
  return out;
}
function cleanTitle(t){ return (t||"").replace(/<!\[CDATA\[(.*?)\]\]>/gi,"$1").replace(/\s+/g," ").trim(); }

async function load(){
  try{
    const r = await fetch(SUM_URL + "&_t=" + Date.now(), { cache:"no-store" });
    if(!r.ok) throw new Error("Fetch failed: "+r.status);
    const j = await r.json();
    const items = uniq(j.items||[]);
    render(items);
    document.getElementById("last").textContent = "Last updated: " + new Date().toLocaleString();
  }catch(e){
    console.error(e);
  }finally{
    setTimeout(load, refreshMs);
  }
}

function render(items){
  const root = document.getElementById("list");
  root.innerHTML = "";
  for(const it of items){
    const card = document.createElement("div");
    card.className = "card";

    const title = cleanTitle(it.title);
    const link = it.link || "";
    const h = document.createElement("div");
    h.className = "title";
    h.textContent = title;
    card.appendChild(h);

    const meta = document.createElement("div");
    meta.className = "meta";
    const host = hostOf(link);
    const conf = Math.round(it.confidence || 0);
    const confCls = gradeClass(conf);
    meta.innerHTML = `
      <span class="host">${host||"unknown"}</span>
      <span>${it.published || ""}</span>
      ${link ? `<a href="${link}" target="_blank" rel="noopener">Open source</a>` : ""}
      <span>Confidence: <span class="${confCls}">${conf}</span></span>
      ${it.model ? `<span>Model: ${it.model}</span>` : ""}
    `;
    card.appendChild(meta);

    if (it.summary) {
      const s = document.createElement("div");
      s.className = "summary";
      s.textContent = it.summary;
      card.appendChild(s);
    }

    if (it.keywords && it.keywords.length){
      const k = document.createElement("div");
      k.className = "keywords";
      k.textContent = "Top terms: " + it.keywords.slice(0,8).join(", ");
      card.appendChild(k);
    }

    // actions
    const actions = document.createElement("div");
    actions.className = "actions";

    // Copy
    const copyBtn = document.createElement("button");
    copyBtn.className = "btn";
    copyBtn.textContent = "Copy";
    copyBtn.onclick = async ()=>{
      const text = `${title}\n\n${it.summary || ""}\n\n${link}`;
      await navigator.clipboard.writeText(text);
      copyBtn.textContent = "Copied";
      setTimeout(()=>copyBtn.textContent="Copy", 1200);
    };
    actions.appendChild(copyBtn);

    // Generate prompt (client-side)
    const promptBtn = document.createElement("button");
    promptBtn.className = "btn";
    promptBtn.textContent = "Generate prompt";
    promptBtn.onclick = ()=>{
      const prompt = [
        `You are an expert analyst. Use the headline and brief to craft a 5-bullet executive summary + 3 action items.`,
        `Headline: ${title}`,
        `Brief: ${it.summary || "(none)"}`,
        `Source: ${it.link || "(none)"}`,
        `Constraints: concise, factual, neutral tone.`,
      ].join("\n");
      navigator.clipboard.writeText(prompt);
      promptBtn.textContent = "Prompt copied";
      setTimeout(()=>promptBtn.textContent="Generate prompt", 1200);
    };
    actions.appendChild(promptBtn);

    // Open ChatGPT
    const chatBtn = document.createElement("a");
    chatBtn.className = "btn";
    chatBtn.target = "_blank";
    chatBtn.rel = "noopener";
    chatBtn.href = "https://chat.openai.com/?temporary-chat=true";
    chatBtn.textContent = "Open ChatGPT";
    actions.appendChild(chatBtn);

    card.appendChild(actions);
    root.appendChild(card);
  }
}

document.getElementById("refresh").onclick = ()=>load();
load();
</script>
</body>
</html>
