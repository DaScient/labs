<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>AI-Generated News Summaries</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta name="description" content="Real-time AI news summaries from global sources. Clean titles, concise takeaways, host labels, confidence signal, and quick actions.">
<style>
  :root{
    --bg: transparent;
    --text:#0b1220;
    --muted:#667085;
    --accent:#0f6fff;
    --card:#ffffff;
    --border:#e5e7eb;
    --soft:#f8fafc;
    --title:28px;
  }
  *{ box-sizing:border-box }
  body{
    margin:0; background:var(--bg); color:var(--text);
    font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
    line-height:1.55;
  }
  header{
    position:sticky; top:0; z-index:5;
    background:rgba(255,255,255,.92);
    backdrop-filter:saturate(140%) blur(6px);
    border-bottom:1px solid var(--border);
  }
  .wrap{ max-width:960px; margin:0 auto; padding:16px; }
  h1{ margin:0; font-size:var(--title); letter-spacing:.2px }
  .controls{ display:flex; flex-wrap:wrap; gap:8px; margin-top:6px; color:var(--muted); font-size:13px; align-items:center }
  .pill{ display:inline-flex; gap:6px; align-items:center; padding:6px 10px; border:1px solid var(--border); border-radius:999px; background:#fff }
  .btn{
    display:inline-flex; align-items:center; gap:8px;
    padding:8px 12px; border:1px solid var(--border); border-radius:10px;
    background:#fff; color:#0b1220; cursor:pointer;
  }
  .btn:hover{ border-color:#cbd5e1 }
  main{ padding:20px 0 60px }
  .list{ display:flex; flex-direction:column; gap:14px }
  .card{
    background:var(--card); border:1px solid var(--border); border-radius:16px; padding:14px 14px 16px;
    box-shadow: 0 6px 18px rgba(15,23,42,.05);
  }
  .title{
    margin:0 0 6px; font-size:21px; font-weight:800; letter-spacing:.2px;
  }
  .meta{
    display:flex; flex-wrap:wrap; gap:10px; align-items:center;
    color:var(--muted); font-size:13px; margin-bottom:10px;
  }
  .host{ display:inline-block; padding:4px 10px; background:var(--soft); border:1px solid var(--border); border-radius:999px; color:#0b1220; font-weight:600; }
  .conf{ font-weight:800 }
  .conf.good{ color:#14803a } .conf.mid{ color:#b45309 } .conf.low{ color:#b91c1c }
  .summary{ font-size:16px }
  .actions{ display:flex; gap:8px; flex-wrap:wrap; margin-top:12px }
  a{ color:var(--accent); text-decoration:none } a:hover{ text-decoration:underline }
  .empty{ color:var(--muted); padding:18px; border:1px dashed var(--border); border-radius:12px; background:#fff }
  .fine{ font-size:12px; color:var(--muted) }
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>AI-Generated News Summaries</h1>
    <div class="controls">
      <span id="status" class="pill">Loading…</span>
      <span id="refreshPill" class="pill">Refresh: —</span>
      <button id="refreshBtn" class="btn" type="button">Refresh now</button>
    </div>
  </div>
</header>

<main class="wrap">
  <div id="feed" class="list"></div>
  <div class="fine" style="margin-top:18px">Powered by GoZaddy Worker · Caches server-side to avoid over-clocking.</div>
</main>

<script>
/* ---------- Config (override via query) ---------- */
const DEFAULT_WORKER = "https://gozaddy.aristocles24.workers.dev";
const params = new URLSearchParams(location.search);
const WORKER_BASE = (params.get("worker") || DEFAULT_WORKER).replace(/\/+$/,"");
const LIMIT   = parseInt(params.get("limit")||"30",10);
const INTERVAL= parseInt(params.get("interval")||"3600",10);   // server cache seconds
const REFRESH = parseInt(params.get("refresh") || "180000",10); // 3min frontend poll (server still cached)
const FEEDS   = params.get("feeds") || ""; // optional CSV; otherwise worker default set

/* ---------- DOM helpers ---------- */
const $ = s => document.querySelector(s);
function hostOf(link){ try{ return new URL(link).hostname.replace(/^www\./,""); }catch{ return ""; } }
function clsForConf(c){ return c>=70?"good":c>=55?"mid":"low"; }
function fmtDate(s){
  if(!s) return "";
  // Try parse RFC or ISO strings safely
  const d = new Date(s);
  if (isNaN(d.getTime())) return s;
  return d.toUTCString().replace("GMT","UTC");
}
function dedupeSummary(title, summary){
  if(!summary) return "";
  const t = (title||"").toLowerCase().replace(/[^\w\s]+/g," ").replace(/\s+/g," ").trim();
  let s = String(summary);
  // remove leading "SUMMARY " or similar boilerplate
  s = s.replace(/^\s*(summary|abstract|lede)\s*[:\-–]\s*/i,"");
  // drop exact title line at start if present
  const sHead = s.slice(0, Math.min(140, s.length)).toLowerCase().replace(/[^\w\s]+/g," ").replace(/\s+/g," ").trim();
  if (t && (sHead.startsWith(t) || t.startsWith(sHead))) {
    // remove first line
    s = s.replace(/^.*?\n+/, "").trim();
  }
  return s;
}

/* ---------- Render ---------- */
function render(items){
  const root = $("#feed");
  root.innerHTML = "";
  if(!items || !items.length){
    root.innerHTML = '<div class="empty">No articles available yet. Check back shortly.</div>';
    return;
  }
  for(const a of items){
    const card = document.createElement("article");
    card.className = "card";
    const confCls = clsForConf(a.confidence||0);
    const host = a.source || hostOf(a.link) || "—";
    const summary = dedupeSummary(a.title, a.summary);

    card.innerHTML = `
      <h2 class="title">${escapeHtml(a.title||"(untitled)")}</h2>
      <div class="meta">
        <span class="host">${escapeHtml(host)}</span>
        ${a.published ? `<span>${escapeHtml(fmtDate(a.published))}</span>` : ""}
        ${a.link ? `<a href="${a.link}" target="_blank" rel="noopener">Open source</a>` : ""}
        <span>Confidence: <span class="conf ${confCls}">${a.confidence ?? "—"}</span></span>
      </div>
      ${summary ? `<div class="summary">${escapeHtml(summary)}</div>` : ""}
      ${a.keywords?.length ? `<div class="fine" style="margin-top:8px">Top terms: ${a.keywords.slice(0,8).join(", ")}</div>` : ""}
      <div class="actions">
        <button class="btn btn-copy" type="button">Copy</button>
        <a class="btn" href="${promptUrl(a)}" target="_blank" rel="noopener">Generate prompt</a>
        <a class="btn" href="${chatgptUrl(a)}" target="_blank" rel="noopener">Open ChatGPT</a>
      </div>
    `;
    // copy
    card.querySelector(".btn-copy").onclick = async () => {
      const text = `${a.title}\n${a.link||""}\n\n${summary}`;
      try{ await navigator.clipboard.writeText(text); }catch(_){}
      const btn = card.querySelector(".btn-copy"); const old=btn.textContent; btn.textContent="Copied"; setTimeout(()=>btn.textContent=old,900);
    };
    root.appendChild(card);
  }
}

function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#39;");
}
function promptUrl(a){
  const u = new URL((params.get("promptPage") || "prompt.html"), location.href);
  u.searchParams.set("title", a.title||"");
  if (a.link) u.searchParams.set("link", a.link);
  return u.toString();
}
function chatgptUrl(a){
  // Plain link to ChatGPT with a seed message in the query
  const seed = `Summarize and analyze: ${a.title}${a.link? " — " + a.link : ""}`;
  const u = new URL("https://chat.openai.com/");
  u.searchParams.set("q", seed);
  return u.toString();
}

/* ---------- Data fetch ---------- */
async function fetchSummaries(){
  const url = new URL(WORKER_BASE + "/summaries");
  if (FEEDS) url.searchParams.set("feeds", FEEDS);
  url.searchParams.set("limit", String(LIMIT));
  url.searchParams.set("interval", String(INTERVAL));
  url.searchParams.set("_t", String(Date.now())); // bust any intermediary caches (worker still caches internally)

  const r = await fetch(url.toString(), { cache:"no-store" });
  if (!r.ok) throw new Error("HTTP "+r.status);
  const data = await r.json();
  if (!data || !Array.isArray(data.items)) throw new Error("Bad payload");
  return data.items;
}

/* ---------- Loop ---------- */
let timer=null;
async function tick(){
  try{
    $("#status").textContent = "Refreshing…";
    const items = await fetchSummaries();
    render(items);
    const ts = new Date().toLocaleString();
    $("#status").textContent = "Last updated: " + ts;
  }catch(e){
    console.error(e);
    $("#status").textContent = "Error fetching data";
    if(!$("#feed").innerHTML) $("#feed").innerHTML = '<div class="empty">Unable to load articles right now.</div>';
  }finally{
    if (timer) clearTimeout(timer);
    timer = setTimeout(tick, REFRESH);
  }
}
$("#refreshBtn").onclick = ()=>{ if(timer) clearTimeout(timer); tick(); };
$("#refreshPill").textContent = "Refresh: " + Math.round(REFRESH/1000) + "s";

/* ---------- Boot ---------- */
tick();
</script>
</body>
</html>
