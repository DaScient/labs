<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>AI-Generated News Summaries</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root{
    --bg:#ffffff00;      /* transparent-friendly */
    --panel:#ffffff;
    --text:#0b1220;
    --muted:#667085;
    --accent:#0f6fff;
    --border:#e5e7eb;
    --dash:#eef2f7;
    --title:28px; --h2:16px; --body:16px; --mono:12px;
  }
  @media (min-width:960px){
    :root{ --title:32px; --h2:18px; --body:17px; }
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--text);
    font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
    line-height:1.6;
  }
  header{
    position:sticky; top:0; z-index:5;
    background:rgba(255,255,255,.92); backdrop-filter:saturate(140%) blur(6px);
    border-bottom:1px solid var(--border);
  }
  .wrap{ max-width:880px; margin:0 auto; padding:16px; }
  h1{ margin:0; font-size:var(--title); font-weight:800; letter-spacing:.2px }
  .meta{ margin-top:6px; color:var(--muted); font-size:13px; display:flex; gap:10px; flex-wrap:wrap }

  main{ padding:20px 0 64px }
  .list{ display:flex; flex-direction:column; gap:14px; }

  .card{
    background:var(--panel); border:1px solid var(--border);
    border-radius:14px; padding:16px;
  }
  .title{
    margin:0 0 2px; font-size:20px; line-height:1.35; font-weight:800;
    word-wrap:break-word;
  }
  .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:6px }
  .pill{
    display:inline-flex; align-items:center; gap:6px;
    padding:4px 10px; border:1px solid var(--border); border-radius:999px;
    background:#f9fafb; color:#0b1220; font-size:12px;
  }
  .byline{ font-size:13px; color:var(--muted) }
  .link{ color:var(--accent); text-decoration:none }
  .link:hover{ text-decoration:underline }

  .body{ margin-top:12px; font-size:var(--body); color:#111 }
  .body p{ margin:0 0 10px }
  .body h3{
    margin:14px 0 6px; font-size:var(--h2); font-weight:800; letter-spacing:.02em;
  }
  .body ul, .body ol{ margin:8px 0 12px 20px; padding:0 }
  .body li{ margin:6px 0 }
  pre, code, .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:var(--mono) }

  .tags{ display:flex; flex-wrap:wrap; gap:6px; margin-top:8px }
  .tag{
    border:1px dashed var(--dash); padding:4px 8px; border-radius:999px;
    font-size:12px; color:#0b1220; background:#fff;
  }
  .divider{ height:1px; background:var(--border); margin:12px 0 8px; }

  .empty{
    border:1px dashed var(--border); border-radius:12px; padding:18px; color:var(--muted);
    text-align:center; background:#fff;
  }

  .blink{ animation:blink .7s ease 1 }
  @keyframes blink{ 50%{ box-shadow:0 0 0 3px rgba(15,111,255,.18) } }
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>AI-Generated News Summaries</h1>
    <div class="meta">
      <span id="status">Loading…</span>
      <span class="pill">Auto-refresh</span>
      <span class="pill" id="rate"></span>
    </div>
  </div>
</header>

<main class="wrap">
  <div id="feed" class="list"></div>
  <div id="empty" class="empty" style="display:none">
    No summaries yet. Waiting for the next refresh window…
  </div>
</main>

<script>
/* ============ CONFIG ============ */
/* Default worker endpoint: override with ?worker=... */
const DEFAULT_WORKER_ASCII_URL =
  "https://gozaddy.aristocles24.workers.dev/ascii?limit=40&interval=3600";

/* Runtime controls via URL (persist in localStorage):
   ?refresh=60000&max=20
*/
const qs = new URLSearchParams(location.search);
const WORKER_ASCII_URL = qs.get("worker") || DEFAULT_WORKER_ASCII_URL;
let REFRESH_MS = parseInt(qs.get("refresh") || localStorage.getItem("idx.refresh") || "60000", 10);
if (isNaN(REFRESH_MS) || REFRESH_MS < 10000) REFRESH_MS = 60000;
let MAX_ITEMS = parseInt(qs.get("max") || localStorage.getItem("idx.max") || "20", 10);
if (isNaN(MAX_ITEMS) || MAX_ITEMS < 5) MAX_ITEMS = 20;
document.getElementById("rate").textContent = `Every ${Math.round(REFRESH_MS/1000)}s`;
/* ================================= */

const $ = (s)=>document.querySelector(s);

function hostOf(link){
  try{ return new URL(link).hostname.replace(/^www\./,''); }catch(_){ return ""; }
}
async function fetchText(url){
  const u = url + (url.includes("?") ? "&" : "?") + "_t=" + Date.now();
  const r = await fetch(u, { cache:"no-store" });
  if(!r.ok) throw new Error("Fetch failed "+r.status);
  return r.text();
}
async function sha(str){
  const d = new TextEncoder().encode(str);
  const b = await crypto.subtle.digest("SHA-256", d);
  return Array.from(new Uint8Array(b)).map(x=>x.toString(16).padStart(2,"0")).join("");
}

/* === Parse the ASCII produced by the worker ===
Expected per-article block:
  Title | link | published
  ------------------------       (>=20 dashes)
  BODY...
  ---------------------------------------------------------- (>=60 dashes)  ← separator
*/
function parseArticles(txt){
  const lines = txt.split(/\r?\n/);
  // cut header/banner
  let i=0; while(i<lines.length && (lines[i].startsWith("=") || !lines[i].trim())) i++;
  // cut optional footer
  const footIdx = lines.findIndex(L=>/\(Updates hourly/i.test(L));
  const usable = (footIdx>-1 ? lines.slice(i, footIdx) : lines.slice(i));

  const out = [];
  let idx=0;
  while(idx<usable.length){
    const titleLine = (usable[idx]||"").trim();
    const dashLine  = (usable[idx+1]||"").trim();
    const isStart = !!titleLine && /^-{20,}$/.test(dashLine);
    if(!isStart){ idx++; continue; }

    const parts = titleLine.split("|").map(s=>s.trim());
    let title = parts[0] || "(untitled)";
    let link = ""; let published = "";
    if(parts.length>=2 && /^https?:\/\//i.test(parts[1])) link = parts[1];
    if(parts.length>=3) published = parts.slice(2).join(" | ");

    const body = [];
    let j = idx+2;
    while(j<usable.length){
      const L = (usable[j]||"").trim();
      const longSep = /^-{60,}$/.test(L);
      const aheadTitle = (usable[j+1]||"").trim();
      const aheadDash  = (usable[j+2]||"").trim();
      const nextStart  = aheadTitle && /^-{20,}$/.test(aheadDash);
      if(longSep && nextStart){ j++; break; }
      body.push(usable[j]);
      j++;
    }
    out.push({ title, link, published, body: body.join("\n").trim(), observedAt: Date.now() });
    idx = j+1;
  }
  return out;
}

/* === Transform plaintext body into tidy HTML === */
function renderBody(text){
  // Pull perspective & SEO line (optional)
  let perspective = "";
  const perspMatch = text.match(/^\s*PERSPECTIVE:\s*(.+)$/mi);
  if(perspMatch) perspective = perspMatch[1].trim();

  let seo = [];
  const seoMatch = text.match(/^\s*SEO KEYWORDS:\s*(.+)$/mi);
  if(seoMatch){
    seo = (seoMatch[1]||"").split(/[;,]/g).map(s=>s.trim()).filter(Boolean).slice(0,10);
  }
  // Remove SEO line from body
  text = text.replace(/^\s*SEO KEYWORDS:.*$/gmi, "").trim();

  // Sectionize:
  //  - Lines in ALL CAPS (or ending with ':') -> <h3>
  //  - Bullets starting with -, * -> <ul>
  //  - Numbered "1. " -> <ol>
  //  - Otherwise -> paragraphs
  const lines = text.split(/\r?\n/);
  const out = [];
  let mode = null; // "ul" | "ol" | null
  const flushList = ()=>{
    if(mode){ out.push(`</${mode}>`); mode=null; }
  };
  const isAllCaps = (s)=> /^[A-Z0-9 \-&/()]+$/.test(s) && s.replace(/[^A-Z0-9]/g,"").length >= 3;

  for(let raw of lines){
    const line = raw.trimRight();
    if(!line.trim()){
      flushList();
      continue;
    }
    if(/^\- |\* /.test(line)){ // unordered
      if(mode!=="ul"){ flushList(); out.push("<ul>"); mode="ul"; }
      out.push(`<li>${escapeHtml(line.replace(/^\- |\* /,""))}</li>`);
      continue;
    }
    if(/^\d+\.\s+/.test(line)){ // ordered
      if(mode!=="ol"){ flushList(); out.push("<ol>"); mode="ol"; }
      out.push(`<li>${escapeHtml(line.replace(/^\d+\.\s+/,""))}</li>`);
      continue;
    }
    flushList();
    if (isAllCaps(line) || /:\s*$/.test(line)) {
      out.push(`<h3>${escapeHtml(line.replace(/:\s*$/,""))}</h3>`);
    } else {
      out.push(`<p>${escapeHtml(line)}</p>`);
    }
  }
  flushList();

  return { html: out.join("\n"), perspective, seo };
}

function escapeHtml(s){
  return s.replace(/[&<>"]/g, m => ({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"}[m]));
}

/* === Render one article card === */
function renderCard(a){
  const { html, perspective, seo } = renderBody(a.body);
  const host = hostOf(a.link);
  const byline = [
    host || "",
    a.published || ""
  ].filter(Boolean).join(" • ");

  const tags = seo.length ? (
    `<div class="tags">${seo.map(t=>`<span class="tag">${escapeHtml(t)}</span>`).join("")}</div>`
  ) : "";

  const pill = perspective ? `<span class="pill">${escapeHtml(perspective)}</span>` : "";

  return `
    <article class="card blink">
      <h2 class="title">${escapeHtml(a.title)}</h2>
      <div class="row">
        ${pill}
        <div class="byline">${escapeHtml(byline)}</div>
        ${a.link ? `<a class="link" href="${a.link}" target="_blank" rel="noopener">Open source</a>` : ""}
      </div>
      <div class="body">${html}</div>
      ${tags ? `<div class="divider"></div>${tags}` : ""}
    </article>
  `;
}

/* === Live loop === */
let LAST_HASH = "";
let CACHE = [];

function dedupeKeepLatest(list){
  const m = new Map();
  for(const x of list){
    const key = (x.title + "|" + hostOf(x.link)).toLowerCase();
    const prev = m.get(key);
    if(!prev || x.observedAt > prev.observedAt) m.set(key, x);
  }
  return [...m.values()];
}

async function tick(){
  try{
    const txt = await fetchText(WORKER_ASCII_URL);
    const h = await sha(txt);
    if(h !== LAST_HASH){
      const parsed = parseArticles(txt);
      CACHE = dedupeKeepLatest(parsed).slice(0, MAX_ITEMS);
      draw();
      LAST_HASH = h;
      $("#status").textContent = "Last updated " + new Date().toLocaleString();
    }
  }catch(e){
    console.error(e);
    $("#status").textContent = "Error fetching summaries. Retrying…";
  }finally{
    setTimeout(tick, REFRESH_MS);
  }
}

function draw(){
  const root = $("#feed");
  if(!CACHE.length){
    root.innerHTML = "";
    $("#empty").style.display = "block";
    return;
  }
  $("#empty").style.display = "none";
  root.innerHTML = CACHE.map(renderCard).join("\n");
  // remove blink after a moment
  setTimeout(()=>document.querySelectorAll(".blink").forEach(n=>n.classList.remove("blink")), 800);
}

/* Boot */
localStorage.setItem("idx.refresh", String(REFRESH_MS));
localStorage.setItem("idx.max", String(MAX_ITEMS));
draw();
tick();
</script>
</body>
</html>
