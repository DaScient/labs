<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>AI-Generated News Summaries — Analytics</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root{
    --bg:#ffffff; --text:#0b1220; --muted:#667085; --accent:#0f6fff;
    --card:#ffffff; --border:#e5e7eb; --dash:#eef2f7; --chip:#f3f4f6;
    --good:#15803d; --warn:#b45309; --bad:#b91c1c;
    --title:26px; --h2:18px; --body:16px; --mono:12px;
  }
  @media (max-width:999px){
    :root{ --title:22px; --h2:16px; --body:15px; }
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:transparent; color:var(--text);
    font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial; line-height:1.5;
  }

  header{
    position:sticky; top:0; z-index:10;
    background:rgba(255,255,255,.92); backdrop-filter:saturate(140%) blur(6px);
    border-bottom:1px solid var(--border);
  }
  .wrap{ max-width:1200px; margin:0 auto; padding:14px 16px; }
  h1{ margin:0; font-size:var(--title); font-weight:800; letter-spacing:.2px; }
  .metaBar{ display:flex; gap:8px 10px; align-items:center; flex-wrap:wrap; margin-top:6px; color:var(--muted); font-size:13px }
  .pill{ display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border:1px solid var(--border);
         border-radius:999px; background:#fff; }
  .controls{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-left:auto }
  select,input[type="number"],input[type="search"]{
    border:1px solid var(--border); border-radius:10px; padding:6px 10px; background:#fff; font:inherit; color:inherit;
  }
  button{ border:1px solid var(--border); background:#fff; border-radius:10px; padding:6px 10px; cursor:pointer }
  button:hover{ border-color:#c7d2fe }

  main.wrap{ padding:18px 16px 60px }

  .kpis{ display:grid; grid-template-columns: repeat(6, 1fr); gap:12px; margin:8px 0 16px }
  @media (max-width:1100px){ .kpis{ grid-template-columns: repeat(3, 1fr); } }
  @media (max-width:640px){ .kpis{ grid-template-columns: repeat(2, 1fr); } }

  .kpi{
    background:var(--card); border:1px solid var(--border); border-radius:14px; padding:12px 14px;
  }
  .kpi .lab{ font-size:12px; color:var(--muted); text-transform:uppercase; letter-spacing:.06em }
  .kpi .val{ font-size:24px; font-weight:800; margin-top:2px }
  .kpi .sub{ font-size:12px; color:var(--muted) }

  .grid{ display:grid; grid-template-columns: 2fr 1fr; gap:16px; }
  @media (max-width:1000px){ .grid{ grid-template-columns: 1fr; } }

  .card{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:16px; }
  h2{ margin:0 0 10px; font-size:var(--h2); font-weight:800; letter-spacing:.2px }

  .list{ display:flex; flex-direction:column; gap:10px }
  .barrow{ display:grid; grid-template-columns: 160px 1fr auto; gap:12px; align-items:center; }
  .barrow .label{ font-weight:600; font-size:14px; color:#0b1220; overflow:hidden; text-overflow:ellipsis; white-space:nowrap }
  .barrow .barWrap{ background:#f1f5f9; border-radius:8px; height:10px; position:relative }
  .barrow .bar{ position:absolute; left:0; top:0; bottom:0; border-radius:8px; background:linear-gradient(90deg,#0f6fff,#5aa3ff) }
  .barrow .val{ font-size:13px; color:var(--muted) }

  .mono{ font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; font-size:var(--mono); color:#222 }
  .muted{ color:var(--muted) }
  .good{ color:var(--good) } .warn{ color:var(--warn) } .bad{ color:var(--bad) }

  .heat{
    display:grid; gap:2px; border:1px solid var(--border); border-radius:10px; padding:8px;
    overflow:auto; max-height:520px; background:#fff;
  }
  .heat .hdr{ position:sticky; top:0; background:#fff }
  .heat .cell{ display:flex; align-items:center; justify-content:center; height:26px; border-radius:4px; color:#0b1220; font-size:12px }
  .heat .lab{ font-size:12px; color:#111; white-space:nowrap }

  .table{ width:100%; border-collapse:collapse; font-size:14px }
  .table th,.table td{ border-bottom:1px dashed var(--dash); padding:8px 0; text-align:left; vertical-align:top }
  .table th{ font-weight:700; color:#111 }

  .chips{ display:flex; flex-wrap:wrap; gap:6px }
  .chip{ background:var(--chip); border:1px solid var(--border); border-radius:999px; padding:4px 8px; font-size:12px; color:#111 }
  .blink{ animation:blink .8s ease 1 } @keyframes blink{ 50%{ box-shadow:0 0 0 3px rgba(15,111,255,.18)}}
  a{ color:var(--accent); text-decoration:none } a:hover{ text-decoration:underline }
</style>
</head>
<body>
<header>
  <div class="wrap" style="display:flex; align-items:flex-start; gap:14px;">
    <div>
      <h1>AI-Generated News Summaries — Analytics</h1>
      <div class="metaBar">
        <span id="lastUpdated" class="muted">Loading…</span>
        <span class="pill" id="windowPill">Window: 6h</span>
        <span class="pill">Auto-refresh</span>
        <span class="pill"><span id="newBadge">New: 0</span></span>
      </div>
    </div>
    <div class="controls">
      <label class="muted mono">Window (h)
        <select id="windowSel">
          <option>1</option><option selected>6</option><option>12</option><option>24</option><option>48</option>
        </select>
      </label>
      <label class="muted mono">Refresh (s)
        <select id="refreshSel">
          <option>30</option><option>60</option><option selected>90</option><option>180</option><option>300</option>
        </select>
      </label>
      <label class="muted mono">Filter
        <input id="filterBox" type="search" placeholder="keyword or source…" />
      </label>
      <button id="btnRefresh">Refresh now</button>
      <button id="btnCSV">Export CSV</button>
    </div>
  </div>
</header>

<main class="wrap">
  <!-- KPI row -->
  <section class="kpis" id="kpisRow">
    <div class="kpi"><div class="lab">Articles</div><div class="val" id="kpiArticles">—</div><div class="sub" id="kpiArticlesSub"></div></div>
    <div class="kpi"><div class="lab">Unique Sources</div><div class="val" id="kpiSources">—</div><div class="sub" id="kpiSourcesSub"></div></div>
    <div class="kpi"><div class="lab">Top Keyword</div><div class="val" id="kpiTopKW">—</div><div class="sub" id="kpiTopKWSub"></div></div>
    <div class="kpi"><div class="lab">Avg Confidence</div><div class="val" id="kpiAvgC">—</div><div class="sub" id="kpiAvgCSub"></div></div>
    <div class="kpi"><div class="lab">Momentum</div><div class="val" id="kpiMomentum">—</div><div class="sub" id="kpiMomentumSub"></div></div>
    <div class="kpi"><div class="lab">Diversity</div><div class="val" id="kpiDiversity">—</div><div class="sub" id="kpiDiversitySub"></div></div>
  </section>

  <div class="grid">
    <section class="card">
      <h2>Key Metrics</h2>
      <div class="list" style="gap:14px">
        <div class="list" id="sources"></div>
        <div class="list" id="keywords"></div>
        <div class="list" id="confSources"></div>
      </div>
    </section>

    <section class="card">
      <h2>Keyword Correlations</h2>
      <div class="muted" style="margin-bottom:8px">Co-occurrence across the current window (top terms).</div>
      <div id="heat"></div>
    </section>
  </div>

  <div class="grid" style="margin-top:16px">
    <section class="card">
      <h2>Latest Articles</h2>
      <table class="table">
        <thead>
          <tr><th style="width:46%">Title</th><th>Source</th><th>Confidence</th><th>Top Terms</th></tr>
        </thead>
        <tbody id="latest"></tbody>
      </table>
    </section>

    <section class="card">
      <h2>Decision Aids</h2>
      <div class="list">
        <div>
          <div class="muted mono">Topic Momentum (Δ last half-window vs prior)</div>
          <div class="list" id="momentum"></div>
        </div>
        <div>
          <div class="muted mono">Source Reliability (heuristic)</div>
          <div class="list" id="reliability"></div>
        </div>
        <div>
          <div class="muted mono">Volume by Region (host TLD heuristic)</div>
          <div class="chips" id="regions"></div>
        </div>
      </div>
    </section>
  </div>
</main>

<script>
/* ===== CONFIG ===== */
const WORKER_ASCII_URL =
  "https://gozaddy.aristocles24.workers.dev/ascii?feeds=" +
  encodeURIComponent([
    // core set — expand freely
    "https://rss.nytimes.com/services/xml/rss/nyt/HomePage.xml",
    "https://feeds.washingtonpost.com/rss/national",
    "https://www.forbes.com/most-popular/feed/",
    "https://www.aljazeera.com/xml/rss/all.xml",
    "https://feeds.bbci.co.uk/news/rss.xml",
    "https://www.reutersagency.com/feed/?best-topics=top-news",
    "https://www.npr.org/rss/rss.php?id=1001",
  ].join(",")) +
  "&limit=60&interval=3600"; // worker updates ≤ hourly

let FRONTEND_POLL_MS = 90_000;   // will be user-tunable
let WINDOW_HOURS = 6;            // user-tunable window
/* ================== */

const $ = (s)=>document.querySelector(s);
const nowStr = ()=>new Date().toLocaleString();

/* ——— helpers ——— */
async function fetchText(url){
  const r = await fetch(url + "&_t=" + Date.now(), { cache:"no-store" });
  if(!r.ok) throw new Error("Fetch failed "+r.status);
  return r.text();
}
async function sha(str){
  const d = new TextEncoder().encode(str);
  const b = await crypto.subtle.digest("SHA-256", d);
  return Array.from(new Uint8Array(b)).map(x=>x.toString(16).padStart(2,"0")).join("");
}
function cleanCdata(s=""){
  return s.replace(/^<!\[CDATA\[/, "").replace(/\]\]>$/, "").trim();
}
function hostOf(link){
  try{ return new URL(link).hostname.replace(/^www\./,''); }catch(_){ return ""; }
}
function words(t){ return (t.toLowerCase().match(/[a-z0-9]+/g)||[]); }
const STOP = new Set(`a,an,the,of,in,on,for,with,and,or,to,from,by,as,is,are,was,were,be,been,at,that,this,these,those,it,its,their,his,her,our,your,not,no,if,then,than,but,so,also,into,over,under,about,via,per,within,without,across,between,among,will,can,may,might,could,should,would`.split(","));

/* ——— parse Worker ASCII ———
Block format (your worker):
Title | link | published
------------------------
BODY…
------------------------------------------------------------  (between articles)
*/
function parseArticles(txt){
  const lines = txt.split(/\r?\n/);
  // trim banner/footer
  let i=0; while(i<lines.length && (lines[i].startsWith("=") || !lines[i].trim())) i++;
  const footIdx = lines.findIndex(L=>/\(Updates hourly/i.test(L));
  const usable = (footIdx>-1 ? lines.slice(i, footIdx) : lines.slice(i));

  const out = [];
  let idx=0;
  while(idx<usable.length){
    const L1 = (usable[idx]||"").trim();
    const L2 = (usable[idx+1]||"").trim();
    const start = !!L1 && /^-{20,}$/.test(L2);
    if(!start){ idx++; continue; }

    const parts = L1.split("|").map(s=>s.trim());
    let title = cleanCdata(parts[0]||"(untitled)");
    let link = ""; let published = "";
    if(parts.length>=2 && /^https?:\/\//i.test(parts[1])) link = parts[1];
    if(parts.length>=3) published = parts.slice(2).join(" | ");

    const body = [];
    let j = idx+2;
    while(j<usable.length){
      const row = (usable[j]||"").trim();
      const longSep = /^-{60,}$/.test(row);
      const aheadT = (usable[j+1]||"").trim();
      const aheadD = (usable[j+2]||"").trim();
      const nextStart = aheadT && /^-{20,}$/.test(aheadD);
      if(longSep && nextStart){ j++; break; }
      body.push(usable[j]);
      j++;
    }
    out.push({ title, link, published, body: cleanCdata(body.join("\n").trim()), observedAt: Date.now() });
    idx = j+1;
  }
  return out;
}

function findSeoKeywords(text){
  const m = text.match(/^\s*seo keywords:\s*(.+)$/gim);
  if(!m) return [];
  const line = m[m.length-1];
  const list = line.split(":")[1]||"";
  return list.split(/[;,]/g).map(s=>s.trim()).filter(Boolean);
}
function topKeywords(articles, k=20){
  const freq = new Map();
  for(const a of articles){
    let kws = findSeoKeywords(a.body);
    if(!kws.length){
      kws = words(a.body).filter(w=>!STOP.has(w) && w.length>2).slice(0,80);
    }
    for(const kw of kws){
      const key = kw.toLowerCase();
      freq.set(key, (freq.get(key)||0)+1);
    }
  }
  return [...freq.entries()].sort((a,b)=>b[1]-a[1]).slice(0,k);
}

/* ——— confidence heuristic ——— */
const POS = new Set("confirm,confirmed,official,approved,announced,launch,launched,records,record,acquires,acquired,sec,filing,final,definitive,report,results".split(","));
const NEG = new Set("may,might,could,reportedly,rumor,alleged,seems,suggests,likely,unverified,investigating,unclear,disputed,questioned,unconfirmed".split(","));
function confidenceScore(text, sourceHost=""){
  const bag = words(text);
  let pos=0, neg=0;
  for(const w of bag){ if(POS.has(w)) pos++; if(NEG.has(w)) neg++; }
  let score = 52 + 6*pos - 6*neg;
  if(/nytimes\.com|washingtonpost\.com|reuters\.|bbc\.co|npr\.org|aljazeera\.com|forbes\.com/i.test(sourceHost)) score += 6;
  return Math.max(0, Math.min(100, score));
}

/* ——— correlations ——— */
function cooccurMatrix(articles, keys){
  const K = keys.length;
  const index = new Map(keys.map((k,i)=>[k,i]));
  const M = Array.from({length:K},()=>Array(K).fill(0));
  for(const a of articles){
    let kws = findSeoKeywords(a.body);
    if(!kws.length){ kws = words(a.body).filter(w=>!STOP.has(w) && w.length>2).slice(0,50); }
    const set = new Set(kws.map(k=>k.toLowerCase()).filter(k=>index.has(k)));
    const arr = [...set];
    for(let i=0;i<arr.length;i++){
      for(let j=i;j<arr.length;j++){
        const ii = index.get(arr[i]), jj = index.get(arr[j]);
        M[ii][jj]++; if(ii!==jj) M[jj][ii]++;
      }
    }
  }
  return M;
}

/* ——— UI helpers ——— */
function gradeClass(score){ return score>=70?"good":score>=45?"warn":"bad"; }
function renderBars(containerSel, pairs, cap=10, suffix=""){
  const root = $(containerSel); root.innerHTML = "";
  if(!pairs.length){ root.innerHTML = '<div class="muted">No data</div>'; return; }
  const max = Math.max(...pairs.map(p=>p[1])) || 1;
  pairs.slice(0,cap).forEach(([label,val])=>{
    const row = document.createElement("div"); row.className="barrow";
    const lab = document.createElement("div"); lab.className="label"; lab.textContent=label;
    const wrap = document.createElement("div"); wrap.className="barWrap";
    const bar = document.createElement("div"); bar.className="bar"; bar.style.width = (100*val/max).toFixed(1)+"%";
    const v = document.createElement("div"); v.className="val"; v.textContent = val + (suffix? " "+suffix:"");
    wrap.appendChild(bar);
    row.appendChild(lab); row.appendChild(wrap); row.appendChild(v);
    root.appendChild(row);
  });
}
function renderHeat(containerSel, keys, M){
  const root = $(containerSel); root.innerHTML="";
  if(!keys.length){ root.innerHTML='<div class="muted">No correlations yet.</div>'; return; }
  const K = keys.length;
  const max = Math.max(1, ...M.flat());
  root.className = "heat";
  root.style.gridTemplateColumns = `140px repeat(${K}, minmax(36px, 1fr))`;
  const blank = document.createElement("div"); blank.className="lab hdr"; root.appendChild(blank);
  for(let j=0;j<K;j++){ const d=document.createElement("div"); d.className="lab hdr"; d.textContent=keys[j]; root.appendChild(d); }
  for(let i=0;i<K;i++){
    const lab = document.createElement("div"); lab.className="lab"; lab.textContent=keys[i]; root.appendChild(lab);
    for(let j=0;j<K;j++){
      const v = M[i][j]; const ratio = v/max;
      const hue = 210 - Math.round(210*ratio); const alpha = 0.15 + 0.65*ratio;
      const cell = document.createElement("div"); cell.className="cell";
      cell.style.background = `hsla(${hue}, 85%, 60%, ${alpha.toFixed(2)})`;
      cell.title = `${keys[i]} × ${keys[j]}: ${v}`; cell.textContent = v? String(v): "";
      root.appendChild(cell);
    }
  }
}
function renderLatest(list){
  const tbody = $("#latest"); tbody.innerHTML="";
  const q = ($("#filterBox").value||"").trim().toLowerCase();
  const filtered = list.filter(a=>{
    if(!q) return true;
    return a.title.toLowerCase().includes(q) || a.host.toLowerCase().includes(q) || a.topTerms.join(" ").includes(q);
  });
  filtered.forEach(a=>{
    const tr = document.createElement("tr");
    const tdT = document.createElement("td");
    const tdS = document.createElement("td");
    const tdC = document.createElement("td");
    const tdK = document.createElement("td");
    tdT.innerHTML = `<div style="font-weight:700">${a.title}</div>
                     <div class="mono">${a.published || ""}</div>
                     ${a.link ? `<a href="${a.link}" target="_blank" rel="noopener">Open source</a>` : ""}`;
    tdS.textContent = a.host || "—";
    tdC.innerHTML = `<span class="${gradeClass(a.confidence)}" style="font-weight:700">${a.confidence}</span>`;
    tdK.textContent = (a.topTerms||[]).slice(0,6).join(", ");
    tr.appendChild(tdT); tr.appendChild(tdS); tr.appendChild(tdC); tr.appendChild(tdK);
    tbody.appendChild(tr);
  });
}

/* ——— snapshot & KPIs ——— */
function renderSnapshotAndKpis(windowed, kwPairs, sourcePairs, momentumPairs){
  const total = windowed.length;
  const uniqSources = new Set(windowed.map(a=>a.host||"unknown")).size;
  const topKW = kwPairs[0]?.[0] || "—";
  const topKWVal = kwPairs[0]?.[1] || 0;
  const avgConf = total? Math.round(windowed.reduce((s,a)=>s+a.confidence,0)/total) : 0;

  // diversity: (unique sources / total) scaled to %
  const diversity = total? Math.round((uniqSources/total)*100) : 0;

  // momentum: sum positive deltas of top terms
  const momentumTop = momentumPairs[0] || ["—",0];
  const momentumScore = momentumPairs.slice(0,5).reduce((s,[_k,delta])=> s + Math.max(0,delta), 0);

  $("#kpiArticles").textContent = String(total);
  $("#kpiSources").textContent  = String(uniqSources);
  $("#kpiTopKW").textContent    = topKW;
  $("#kpiAvgC").textContent     = String(avgConf);
  $("#kpiMomentum").textContent = momentumTop[0] + (momentumTop[1] ? ` (+${momentumTop[1]})` : "");
  $("#kpiDiversity").textContent= `${diversity}%`;

  $("#kpiArticlesSub").textContent = (sourcePairs[0]?.[0] ? `Top source: ${sourcePairs[0][0]}` : "");
  $("#kpiSourcesSub").textContent  = (sourcePairs[0]?.[1] ? `${sourcePairs[0][1]} articles` : "");
  $("#kpiTopKWSub").textContent    = topKWVal ? `${topKWVal} mentions` : "";
  $("#kpiAvgCSub").textContent     = "Heuristic veracity";
  $("#kpiMomentumSub").textContent = `Sum Δ of top movers: ${momentumScore}`;
  $("#kpiDiversitySub").textContent= "Higher is better";
}

/* ——— extra decision aids ——— */
function computeMomentum(articles){
  // split window into two halves and compare keyword frequencies
  const mid = Date.now() - (WINDOW_HOURS*3600*1000)/2;
  const first = articles.filter(a=> a.observedAt < mid);
  const second= articles.filter(a=> a.observedAt >= mid);
  const f1 = new Map(topKeywords(first, 100));
  const f2 = new Map(topKeywords(second,100));
  const keys = new Set([...f1.keys(), ...f2.keys()]);
  const deltas = [];
  keys.forEach(k=>{
    const d = (f2.get(k)||0) - (f1.get(k)||0);
    deltas.push([k, d]);
  });
  return deltas.sort((a,b)=> b[1]-a[1]).slice(0,10);
}
function renderMomentum(pairs){
  renderBars("#momentum", pairs.map(([k,v])=>[k, Math.max(0,v)]), 8, "Δ");
}
function reliabilityScore(host, avgConf){
  // combine heuristic whitelist + observed avg confidence
  let base = 0;
  if(/reuters|nytimes|bbc|washingtonpost|npr|aljazeera/.test(host)) base += 15;
  return Math.max(0, Math.min(100, Math.round(base + 0.85*avgConf)));
}
function renderReliability(articles){
  const map = new Map(); // host -> [sumConf, count]
  articles.forEach(a=>{
    const h = a.host||"unknown";
    const v = map.get(h)||[0,0];
    v[0]+=a.confidence; v[1]+=1; map.set(h,v);
  });
  const pairs = [...map.entries()].map(([h,[s,c]])=>[h, reliabilityScore(h, s/c)]);
  pairs.sort((a,b)=>b[1]-a[1]);
  renderBars("#reliability", pairs, 8, "score");
}
function regionFromHost(host=""){
  if(/\.uk$|bbc\.co\.uk/.test(host)) return "UK";
  if(/\.de$|dw\.com/.test(host)) return "DE";
  if(/\.jp$/.test(host)) return "JP";
  if(/\.in$/.test(host)) return "IN";
  if(/\.ru$/.test(host)) return "RU";
  if(/aljazeera\.com|\.sa$|\.ae$|\.qa$/.test(host)) return "MENA";
  if(/reuters\.|nytimes\.|washingtonpost\.|npr\.org|forbes\.com/.test(host)) return "US";
  if(/\.cn$|xinhuanet|globaltimes/.test(host)) return "CN";
  if(/\.fr$/.test(host)) return "FR";
  return "Other";
}
function renderRegions(articles){
  const m = new Map();
  articles.forEach(a=>{
    const r = regionFromHost(a.host);
    m.set(r, (m.get(r)||0)+1);
  });
  const pairs = [...m.entries()].sort((a,b)=>b[1]-a[1]);
  const root = $("#regions"); root.innerHTML="";
  pairs.forEach(([lab,val])=>{
    const span = document.createElement("span");
    span.className="chip"; span.textContent = `${lab}: ${val}`;
    root.appendChild(span);
  });
}

/* ——— state & loop ——— */
let LAST_HASH = "";
let CACHE = [];
let NEW_COUNT = 0;

function withinWindow(a){
  const ageMs = Date.now() - a.observedAt;
  return ageMs <= WINDOW_HOURS*3600*1000;
}

async function tick(force=false){
  try{
    const txt = await fetchText(WORKER_ASCII_URL);
    const h = await sha(txt);
    if(h === LAST_HASH && !force) return schedule();

    const parsed = parseArticles(txt).map(a=>{
      const host = hostOf(a.link);
      const conf = confidenceScore(a.body, host);
      const kws = findSeoKeywords(a.body);
      const topTerms = (kws.length ? kws : words(a.body).filter(w=>!STOP.has(w)).slice(0,8)).map(w=>w.toLowerCase());
      return { ...a, host, confidence: conf, topTerms };
    });

    // unique by title+host
    const uniqKey = (x)=> (x.title + "|" + x.host).toLowerCase();
    const before = new Map(CACHE.filter(withinWindow).map(a=>[uniqKey(a), a]));
    let added = 0;
    parsed.forEach(p=> { if(!before.has(uniqKey(p))) added++; before.set(uniqKey(p), p); });
    CACHE = [...before.values()].sort((a,b)=>b.observedAt - a.observedAt);
    NEW_COUNT = added;

    renderAll();
    LAST_HASH = h;
    $("#lastUpdated").textContent = "Last updated " + nowStr();
    $("#newBadge").textContent = "New: " + NEW_COUNT;
    document.querySelectorAll(".card,.kpi").forEach(n=>n.classList.add("blink"));
    setTimeout(()=>document.querySelectorAll(".blink").forEach(n=>n.classList.remove("blink")), 900);
  }catch(e){
    console.error(e);
  }finally{
    schedule();
  }
}

function schedule(){ setTimeout(()=>tick(false), FRONTEND_POLL_MS); }

function renderAll(){
  const windowed = CACHE.filter(withinWindow);

  // base aggregations
  const srcCounts = new Map();
  windowed.forEach(a=> srcCounts.set(a.host || "unknown", (srcCounts.get(a.host || "unknown")||0)+1));
  const sourcePairs = [...srcCounts.entries()].sort((a,b)=>b[1]-a[1]);

  const kwPairs = topKeywords(windowed, 20);

  const confMap = new Map(); // host -> [sum, cnt]
  windowed.forEach(a=>{
    const k = a.host || "unknown";
    const acc = confMap.get(k) || [0,0];
    acc[0]+=a.confidence; acc[1]+=1; confMap.set(k, acc);
  });
  const confPairs = [...confMap.entries()].map(([h,[s,c]])=>[h, Math.round(s/c)]).sort((a,b)=>b[1]-a[1]);

  const keyList = kwPairs.slice(0,12).map(p=>p[0]);
  const M = cooccurMatrix(windowed, keyList);

  // decisions
  const momentumPairs = computeMomentum(windowed);

  // render sections
  renderBars("#sources", sourcePairs, 10, "articles");
  renderBars("#keywords", kwPairs, 12, "hits");
  renderBars("#confSources", confPairs, 8, "conf");
  renderHeat("#heat", keyList, M);
  renderLatest(windowed.slice(0,20));
  renderMomentum(momentumPairs);
  renderReliability(windowed);
  renderRegions(windowed);
  renderSnapshotAndKpis(windowed, kwPairs, sourcePairs, momentumPairs);
  $("#windowPill").textContent = "Window: " + WINDOW_HOURS + "h";
}

/* ——— controls ——— */
$("#btnRefresh").onclick = ()=> tick(true);
$("#filterBox").addEventListener("input", ()=> renderLatest(CACHE.filter(withinWindow)));
$("#windowSel").addEventListener("change", e=>{
  WINDOW_HOURS = parseInt(e.target.value,10)||6;
  renderAll();
});
$("#refreshSel").addEventListener("change", e=>{
  FRONTEND_POLL_MS = (parseInt(e.target.value,10)||90) * 1000;
});
$("#btnCSV").onclick = ()=>{
  const rows = [["title","link","published","host","confidence","top_terms"]];
  CACHE.filter(withinWindow).forEach(a=>{
    rows.push([a.title, a.link, a.published, a.host, String(a.confidence), `"${(a.topTerms||[]).join(" ")}"`]);
  });
  const csv = rows.map(r=>r.map(x=>String(x).replace(/"/g,'""')).join(",")).join("\n");
  const blob = new Blob([csv], {type:"text/csv"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `analytics-${Date.now()}.csv`;
  a.click(); URL.revokeObjectURL(a.href);
};

/* ——— boot ——— */
(function initFromQuery(){
  const q = new URLSearchParams(location.search);
  const w = parseInt(q.get("window")||"", 10);
  const r = parseInt(q.get("refresh")||"", 10);
  if(!isNaN(w) && w>0){ WINDOW_HOURS = w; $("#windowSel").value=String(w); }
  if(!isNaN(r) && r>0){ FRONTEND_POLL_MS = r*1000; $("#refreshSel").value=String(r); }
})();
tick(true);
</script>
</body>
</html>
