<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>AI-Generated News Summaries — Analytics</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root{
    --bg:#ffffff; --text:#0b1220; --muted:#667085; --accent:#0f6fff;
    --card:#ffffff; --border:#e5e7eb; --dash:#eef2f7;
    --title:24px; --h2:18px; --body:16px; --mono:12px;
  }
  @media (min-width:1100px){
    :root{ --title:28px; --h2:19px; --body:17px; }
  }
  *{box-sizing:border-box}
  body{ margin:0; background:var(--bg); color:var(--text);
        font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial; line-height:1.55; }
  header{ position:sticky; top:0; z-index:10;
          background:rgba(255,255,255,.92); backdrop-filter:saturate(140%) blur(6px);
          border-bottom:1px solid var(--border); }
  .wrap{ max-width:1200px; margin:0 auto; padding:16px; }
  h1{ margin:0; font-size:var(--title); font-weight:800; letter-spacing:.2px; }
  .metaBar{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:10px; color:var(--muted); font-size:13px }
  .pill{ display:inline-flex; gap:6px; align-items:center; padding:4px 10px; border:1px solid var(--border); border-radius:999px; font-size:12px; background:#f8fafc }
  .controls{ margin-left:auto; display:flex; gap:8px; align-items:center }
  select{ border:1px solid var(--border); border-radius:10px; padding:6px 10px; background:#fff; color:#111; font-size:13px }
  main{ padding:20px 0 60px }
  .grid{ display:grid; gap:16px; }
  @media (min-width:1100px){ .grid{ grid-template-columns: 2fr 1fr; } }
  .card{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:16px; }
  .split{ display:grid; gap:16px }
  @media (min-width:1100px){ .split{ grid-template-columns:1fr 1fr } }
  h2{ margin:0 0 10px; font-size:var(--h2); font-weight:800; letter-spacing:.2px }
  .list{ display:flex; flex-direction:column; gap:10px }
  .barrow{ display:grid; grid-template-columns: 190px 1fr auto; gap:12px; align-items:center; }
  .barrow .label{ font-weight:600; font-size:14px; color:#0b1220; overflow:hidden; text-overflow:ellipsis; white-space:nowrap }
  .barrow .barWrap{ background:#f1f5f9; border-radius:8px; height:10px; position:relative }
  .barrow .bar{ position:absolute; left:0; top:0; bottom:0; border-radius:8px; background:linear-gradient(90deg,#0f6fff,#5aa3ff) }
  .barrow .val{ font-size:13px; color:var(--muted) }
  .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:var(--mono); color:#222 }
  .table{ width:100%; border-collapse:collapse; font-size:14px }
  .table th,.table td{ border-bottom:1px dashed var(--dash); padding:10px 0; text-align:left; vertical-align:top }
  .table th{ font-weight:700; color:#111 }
  .heat{ display:grid; gap:2px; border:1px solid var(--border); border-radius:10px; padding:8px; overflow:auto; max-height:520px; background:#fff; }
  .heat .hdr{ position:sticky; top:0; background:#fff; font-weight:600 }
  .heat .cell{ display:flex; align-items:center; justify-content:center; height:28px; border-radius:4px; color:#0b1220; font-size:12px }
  .heat .lab{ font-size:12px; color:#111; white-space:nowrap }
  .muted{ color:var(--muted) }
  .good{ color:#15803d; font-weight:700 } .warn{ color:#b45309; font-weight:700 } .bad{ color:#b91c1c; font-weight:700 }
  .blink{ animation:blink .8s ease 1 } @keyframes blink{ 50%{ box-shadow:0 0 0 3px rgba(15,111,255,.18)}}
  a{ color:var(--accent); text-decoration:none } a:hover{ text-decoration:underline }
  .chip{ display:inline-block; padding:2px 8px; border:1px solid var(--border); border-radius:999px; font-size:12px; background:#fff }
  .hostDot{ width:18px; height:18px; border-radius:50%; background:#e5e7eb; display:inline-flex; align-items:center; justify-content:center; font-size:11px; font-weight:700; color:#475569; margin-right:8px }
  .titleCell{ max-width:520px }
  .truncate{ display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden }
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>AI-Generated News Summaries — Analytics</h1>
    <div class="metaBar">
      <span id="lastUpdated" class="muted">Loading…</span>
      <span class="pill" id="windowPill">Window: 6h</span>
      <div class="controls">
        <label class="muted">Refresh</label>
        <select id="refreshSel">
          <option value="30000">30s</option>
          <option value="60000" selected>1m</option>
          <option value="120000">2m</option>
          <option value="300000">5m</option>
          <option value="600000">10m</option>
        </select>
        <label class="muted">Window</label>
        <select id="windowSel">
          <option value="1">1h</option>
          <option value="3">3h</option>
          <option value="6" selected>6h</option>
          <option value="12">12h</option>
          <option value="24">24h</option>
        </select>
      </div>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="grid">
    <section class="card">
      <h2>Key Metrics</h2>
      <div class="split">
        <div>
          <div class="list" id="sources"></div>
        </div>
        <div>
          <div class="list" id="keywords"></div>
        </div>
      </div>
      <div class="split" style="margin-top:12px">
        <div>
          <h2>Average Confidence by Source</h2>
          <div class="list" id="confSources"></div>
        </div>
        <div>
          <h2>Snapshot</h2>
          <table class="table"><tbody id="snapshot"></tbody></table>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>Keyword Correlations</h2>
      <div class="muted" style="margin-bottom:8px">Co-occurrence across the current window (top terms).</div>
      <div id="heat"></div>
    </section>
  </div>

  <section class="card" style="margin-top:16px">
    <h2>Latest Articles</h2>
    <table class="table">
      <thead>
        <tr><th style="width:50%">Title</th><th>Source</th><th>Confidence</th><th>Top Terms</th></tr>
      </thead>
      <tbody id="latest"></tbody>
    </table>
  </section>
</main>

<script>
/* ===== CONFIG ===== */
const WORKER_JSON_URL =
  "https://gozaddy.aristocles24.workers.dev/json?limit=60&interval=3600";

let FRONTEND_POLL_MS = 60_000;
let WINDOW_HOURS = 6;

/* ================== */

const $ = (s)=>document.querySelector(s);
const nowStr = ()=>new Date().toLocaleString();

async function fetchJSON(url){
  const r = await fetch(url + "&_t=" + Date.now(), { cache:"no-store" });
  if(!r.ok) throw new Error("Fetch failed "+r.status);
  return r.json();
}

function words(t){ return (t.toLowerCase().match(/[a-z0-9]+/g)||[]); }
const STOP = new Set(`a,an,the,of,in,on,for,with,and,or,to,from,by,as,is,are,was,were,be,been,at,that,this,these,those,it,its,their,his,her,our,your,not,no,if,then,than,but,so,also,into,over,under,about,via,per,within,without,across,between,among,will,can,may,might,could,should,would`.split(","));

function findSeoKeywords(text){
  const m = text.match(/^\s*seo keywords:\s*(.+)$/gim);
  if(!m) return [];
  const line = m[m.length-1];
  const list = line.split(":")[1]||"";
  return list.split(/[;,]/g).map(s=>s.trim()).filter(Boolean);
}
function topKeywords(articles, k=20){
  const freq = new Map();
  for(const a of articles){
    let kws = a.seo?.length ? a.seo : findSeoKeywords(a.summary);
    if(!kws.length){
      kws = words(a.summary).filter(w=>!STOP.has(w) && w.length>2).slice(0,100);
    }
    for(const kw of kws){
      const key = kw.toLowerCase();
      freq.set(key, (freq.get(key)||0)+1);
    }
  }
  return [...freq.entries()].sort((a,b)=>b[1]-a[1]).slice(0,k);
}

function cooccurMatrix(articles, keys){
  const K = keys.length;
  const index = new Map(keys.map((k,i)=>[k,i]));
  const M = Array.from({length:K},()=>Array(K).fill(0));
  for(const a of articles){
    let kws = a.seo?.length ? a.seo : words(a.summary).filter(w=>!STOP.has(w) && w.length>2).slice(0,60);
    const set = new Set(kws.map(k=>k.toLowerCase()).filter(k=>index.has(k)));
    const arr = [...set];
    for(let i=0;i<arr.length;i++){
      for(let j=i;j<arr.length;j++){
        const ii=index.get(arr[i]), jj=index.get(arr[j]);
        M[ii][jj]++; if(ii!==jj) M[jj][ii]++;
      }
    }
  }
  return M;
}

function hostOf(link){
  try{ return new URL(link).hostname.replace(/^www\./,''); }catch(_){ return ""; }
}
function gradeClass(score){ return score>=70?"good":score>=45?"warn":"bad"; }

/* ===== Rendering helpers ===== */
function renderBars(containerSel, pairs, cap=10, suffix=""){
  const root = $(containerSel); root.innerHTML = "";
  if(!pairs.length){ root.innerHTML = '<div class="muted">No data</div>'; return; }
  const max = Math.max(...pairs.map(p=>p[1])) || 1;
  pairs.slice(0,cap).forEach(([label,val])=>{
    const row = document.createElement("div"); row.className="barrow";
    const lab = document.createElement("div"); lab.className="label"; lab.textContent=label;
    const wrap = document.createElement("div"); wrap.className="barWrap";
    const bar = document.createElement("div"); bar.className="bar"; bar.style.width = (100*val/max).toFixed(1)+"%";
    const v = document.createElement("div"); v.className="val"; v.textContent = val + (suffix? " "+suffix:"");
    wrap.appendChild(bar); row.appendChild(lab); row.appendChild(wrap); row.appendChild(v); root.appendChild(row);
  });
}
function renderHeat(containerSel, keys, M){
  const root = $(containerSel); root.innerHTML="";
  if(!keys.length){ root.innerHTML='<div class="muted">No correlations yet.</div>'; return; }
  const K = keys.length;
  const max = Math.max(1, ...M.flat());
  root.className = "heat";
  root.style.gridTemplateColumns = `160px repeat(${K}, minmax(36px, 1fr))`;
  const blank = document.createElement("div"); blank.className="lab hdr"; root.appendChild(blank);
  for(let j=0;j<K;j++){ const d=document.createElement("div"); d.className="lab hdr"; d.textContent=keys[j]; root.appendChild(d); }
  for(let i=0;i<K;i++){
    const lab=document.createElement("div"); lab.className="lab"; lab.textContent=keys[i].toLowerCase(); root.appendChild(lab);
    for(let j=0;j<K;j++){
      const v=M[i][j], ratio=v/max, hue=210-Math.round(210*ratio), alpha=0.15+0.65*ratio;
      const cell=document.createElement("div"); cell.className="cell";
      cell.style.background=`hsla(${hue},85%,60%,${alpha.toFixed(2)})`;
      cell.title=`${keys[i]} × ${keys[j]}: ${v}`; cell.textContent = v? String(v): ""; root.appendChild(cell);
    }
  }
}
function renderLatest(list){
  const tbody = $("#latest"); tbody.innerHTML="";
  list.forEach(a=>{
    const tr = document.createElement("tr");
    const tdT = document.createElement("td"); tdT.className="titleCell";
    const host = hostOf(a.link);
    const dot = `<span class="hostDot" title="${host||'—'}">${(host||'—').substring(0,1).toUpperCase()}</span>`;
    tdT.innerHTML = `<div style="font-weight:800">${sanitize(a.title)}</div>
                     <div class="mono">${sanitize(a.published || "")}</div>
                     <div class="truncate" style="margin-top:6px">${sanitize(a.summary)}</div>
                     ${a.link ? `<div style="margin-top:6px"><a href="${a.link}" target="_blank" rel="noopener">Open source</a></div>` : ""}`;
    const tdS = document.createElement("td");
    tdS.innerHTML = `${dot}<span>${host || "—"}</span>`;
    const tdC = document.createElement("td");
    const cls = gradeClass(a.confidence);
    tdC.innerHTML = `<span class="${cls}">${a.confidence ?? "—"}</span>`;
    const tdK = document.createElement("td");
    tdK.innerHTML = (a.seo && a.seo.length ? a.seo : [])
      .slice(0,6)
      .map(x=>`<span class="chip">${sanitize(x.toLowerCase())}</span>`).join(" ");
    tr.appendChild(tdT); tr.appendChild(tdS); tr.appendChild(tdC); tr.appendChild(tdK);
    tbody.appendChild(tr);
  });
}
function renderSnapshot(articles, kwPairs, sourcePairs){
  const total = articles.length;
  const topKW = kwPairs[0]?.[0] || "—";
  const topSrc = sourcePairs[0]?.[0] || "—";
  const avgConf = total? Math.round(articles.reduce((s,a)=>s+(a.confidence||0),0)/total) : 0;
  const rows = [
    ["Articles in window", String(total)],
    ["Top keyword", topKW],
    ["Top source", topSrc],
    ["Avg confidence", `${avgConf}`],
    ["Window (hours)", String(WINDOW_HOURS)]
  ];
  const tb = $("#snapshot"); tb.innerHTML="";
  rows.forEach(([k,v])=>{
    const tr=document.createElement("tr"); tr.innerHTML = `<th>${k}</th><td>${v}</td>`; tb.appendChild(tr);
  });
}
function sanitize(s){ return (s||"").replace(/[<>&]/g, m=>({ "<":"&lt;", ">":"&gt;", "&":"&amp;" }[m])); }

/* ===== Live loop ===== */
let LAST_HASH = "";
let CACHE = [];

function withinWindow(a){
  const ageMs = Date.now() - (a.observedAt || Date.now());
  return ageMs <= WINDOW_HOURS*3600*1000;
}
async function tick(){
  try{
    const data = await fetchJSON(WORKER_JSON_URL);
    const items = Array.isArray(data.items) ? data.items : [];
    // de-dupe on title+link
    const map = new Map(CACHE.filter(withinWindow).map(x=>[(x.title+"|"+x.link).toLowerCase(), x]));
    for(const it of items){
      map.set((it.title+"|"+it.link).toLowerCase(), { ...it, observedAt: it.observedAt || Date.now() });
    }
    CACHE = [...map.values()].sort((a,b)=> (b.observedAt||0)-(a.observedAt||0));

    renderAll();
    $("#lastUpdated").textContent = "Last updated " + nowStr();
    document.querySelectorAll(".card").forEach(n=>{ n.classList.add("blink"); setTimeout(()=>n.classList.remove("blink"), 900); });
  }catch(e){ console.error(e); }
  finally{ setTimeout(tick, FRONTEND_POLL_MS); }
}

function renderAll(){
  const windowed = CACHE.filter(withinWindow);

  const srcCounts = new Map();
  windowed.forEach(a=>{ const h=hostOf(a.link)||"unknown"; srcCounts.set(h,(srcCounts.get(h)||0)+1); });
  const sourcePairs = [...srcCounts.entries()].sort((a,b)=>b[1]-a[1]);

  const kwPairs = topKeywords(windowed, 22);

  const confMap = new Map();
  windowed.forEach(a=>{
    const h=hostOf(a.link)||"unknown";
    const acc=confMap.get(h)||[0,0];
    acc[0]+= (a.confidence||0); acc[1]+=1; confMap.set(h,acc);
  });
  const confPairs = [...confMap.entries()].map(([h,[s,c]])=>[h, Math.round(s/c)]).sort((a,b)=>b[1]-a[1]);

  const keyList = kwPairs.slice(0,12).map(p=>p[0]);
  const M = cooccurMatrix(windowed, keyList);

  renderBars("#sources", sourcePairs, 10, "articles");
  renderBars("#keywords", kwPairs, 12, "hits");
  renderBars("#confSources", confPairs, 8, "conf");
  renderHeat("#heat", keyList, M);
  renderLatest(windowed.slice(0,12));
  renderSnapshot(windowed, kwPairs, sourcePairs);
  $("#windowPill").textContent = "Window: " + WINDOW_HOURS + "h";
}

/* Boot + controls */
(function initFromQuery(){
  const q = new URLSearchParams(location.search);
  const w = parseInt(q.get("window")||"",10);
  const r = parseInt(q.get("refresh")||"",10);
  if(!isNaN(w) && w>0){ WINDOW_HOURS = w; }
  if(!isNaN(r) && r>=10_000){ FRONTEND_POLL_MS = r; }
  $("#windowSel").value = String(WINDOW_HOURS);
  $("#refreshSel").value = String(FRONTEND_POLL_MS);
})();
$("#windowSel").addEventListener("change", e=>{ WINDOW_HOURS=parseInt(e.target.value,10)||6; renderAll(); });
$("#refreshSel").addEventListener("change", e=>{ FRONTEND_POLL_MS=parseInt(e.target.value,10)||60_000; });

tick();
</script>
</body>
</html>
