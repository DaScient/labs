<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>AI-Generated News Summaries — Analytics</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root{
    --bg:#ffffff; --text:#0b1220; --muted:#667085; --accent:#0f6fff;
    --card:#ffffff; --border:#e5e7eb; --dash:#eef2f7;
    --title:26px; --h2:18px; --mono:12px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:transparent;color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;line-height:1.5}
  header{position:sticky;top:0;z-index:10;background:rgba(255,255,255,.92);backdrop-filter:saturate(140%) blur(6px);border-bottom:1px solid var(--border)}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  h1{margin:0;font-size:var(--title);font-weight:800}
  .metaBar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;color:var(--muted);font-size:13px}
  .pill{display:inline-block;padding:4px 8px;border:1px solid var(--border);border-radius:999px;background:#f9fafb;color:#111;font-size:12px}
  main{padding:20px 0 60px}
  .grid{display:grid;gap:16px}
  @media (min-width:1000px){ .grid{grid-template-columns:2fr 1fr} }
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px}
  h2{margin:0 0 10px;font-size:var(--h2);font-weight:800}
  .list{display:flex;flex-direction:column;gap:10px}
  .barrow{display:grid;grid-template-columns:160px 1fr auto;gap:12px;align-items:center}
  .barrow .label{font-weight:600;font-size:14px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .barrow .barWrap{background:#f1f5f9;border-radius:8px;height:10px;position:relative}
  .barrow .bar{position:absolute;left:0;top:0;bottom:0;border-radius:8px;background:linear-gradient(90deg,#0f6fff,#5aa3ff)}
  .barrow .val{font-size:13px;color:var(--muted)}
  .table{width:100%;border-collapse:collapse;font-size:14px}
  .table th,.table td{border-bottom:1px dashed var(--dash);padding:8px 0;text-align:left;vertical-align:top}
  .heat{display:grid;gap:2px;border:1px solid var(--border);border-radius:10px;padding:8px;overflow:auto;max-height:480px;background:#fff}
  .heat .hdr{position:sticky;top:0;background:#fff}
  .heat .cell{display:flex;align-items:center;justify-content:center;height:26px;border-radius:4px;color:#0b1220;font-size:12px}
  .heat .lab{font-size:12px;color:#111;white-space:nowrap}
  .good{color:#15803d}.warn{color:#b45309}.bad{color:#b91c1c}
  a{color:var(--accent);text-decoration:none} a:hover{text-decoration:underline}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:var(--mono)}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>AI-Generated News Summaries — Analytics</h1>
    <div class="metaBar">
      <span id="lastUpdated">Loading…</span>
      <span class="pill" id="windowPill">Window: 6h</span>
      <span class="pill" id="refreshPill">Refresh: 90s</span>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="grid">
    <section class="card">
      <h2>Key Metrics</h2>
      <div style="display:grid;gap:16px;grid-template-columns:1fr 1fr">
        <div><div class="list" id="sources"></div></div>
        <div><div class="list" id="keywords"></div></div>
      </div>
      <div style="display:grid;gap:16px;grid-template-columns:1fr 1fr;margin-top:12px">
        <div>
          <h2>Average Confidence by Source</h2>
          <div class="list" id="confSources"></div>
        </div>
        <div>
          <h2>Snapshot</h2>
          <table class="table"><tbody id="snapshot"></tbody></table>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>Keyword Correlations</h2>
      <div class="mono" style="color:#667085;margin-bottom:6px">Co-occurrence across the current window</div>
      <div id="heat"></div>
    </section>
  </div>

  <section class="card" style="margin-top:16px">
    <h2>Latest Articles</h2>
    <table class="table">
      <thead><tr><th style="width:40%">Title</th><th>Source</th><th>Confidence</th><th>Top Terms</th></tr></thead>
      <tbody id="latest"></tbody>
    </table>
  </section>
</main>

<script>
const API_BASE = "https://gozaddy.aristocles24.workers.dev";
const DEFAULT_FEEDS = [
  "https://rss.nytimes.com/services/xml/rss/nyt/HomePage.xml",
  "https://feeds.washingtonpost.com/rss/national",
  "https://feeds.reuters.com/reuters/topNews",
  "https://www.aljazeera.com/xml/rss/all.xml",
  "https://feeds.npr.org/1001/rss.xml",
  "https://feeds.bbci.co.uk/news/rss.xml",
  "https://www.theguardian.com/world/rss",
  "https://apnews.com/hub/ap-top-news?utm_source=rss"
];

let WINDOW_HOURS = 6;
let FRONTEND_POLL_MS = 90_000;
const LIMIT = 40;
const SERVER_INTERVAL_SEC = 3600;

const $ = (s)=>document.querySelector(s);
function qs(name){ const u=new URL(location.href); return u.searchParams.get(name); }
(function initParams(){
  const w = parseInt(qs("window")||"", 10);
  const r = parseInt(qs("refresh")||"", 10);
  if(!isNaN(w) && w>0) WINDOW_HOURS = w;
  if(!isNaN(r) && r>=5000) FRONTEND_POLL_MS = r;
  $("#windowPill").textContent = `Window: ${WINDOW_HOURS}h`;
  $("#refreshPill").textContent = `Refresh: ${(FRONTEND_POLL_MS/1000|0)}s`;
})();

function buildUrl(){
  const feeds = qs("feeds") ? qs("feeds").split(",") : DEFAULT_FEEDS;
  const f = encodeURIComponent(feeds.join(","));
  return `${API_BASE}/summaries?feeds=${f}&limit=${LIMIT}&interval=${SERVER_INTERVAL_SEC}`;
}

async function fetchJSON(url){
  const r = await fetch(url + "&_t=" + Date.now(), { cache: "no-store" });
  if(!r.ok) throw new Error("Fetch failed " + r.status);
  return r.json();
}
function hostOf(link){ try{ return new URL(link).hostname.replace(/^www\./,''); }catch{ return ""; } }
function words(t){ return (t.toLowerCase().match(/[a-z0-9]+/g)||[]); }
const STOP = new Set(`a,an,the,of,in,on,for,with,and,or,to,from,by,as,is,are,was,were,be,been,at,that,this,these,those,it,its,their,his,her,our,your,not,no,if,then,than,but,so,also,into,over,under,about,via,per,within,without,across,between,among,will,can,may,might,could,should,would`.split(","));
function findSeoKeywords(text){
  const m = text.match(/^\s*seo keywords:\s*(.+)$/gim);
  if(!m) return [];
  const line = m[m.length-1];
  return (line.split(":")[1]||"").split(/[;,]/g).map(s=>s.trim()).filter(Boolean);
}
function topKeywords(list,k=20){
  const freq = new Map();
  for(const a of list){
    const kws = (a.keywords && a.keywords.length) ? a.keywords : words(a.summary).filter(w=>!STOP.has(w)).slice(0,60);
    for(const kw of kws){ const key = kw.toLowerCase(); freq.set(key,(freq.get(key)||0)+1); }
  }
  return [...freq.entries()].sort((a,b)=>b[1]-a[1]).slice(0,k);
}
function cooccurMatrix(list, keys){
  const idx = new Map(keys.map((k,i)=>[k,i]));
  const K = keys.length;
  const M = Array.from({length:K},()=>Array(K).fill(0));
  for(const a of list){
    const base = (a.keywords && a.keywords.length) ? a.keywords : words(a.summary).filter(w=>!STOP.has(w)).slice(0,40);
    const set = new Set(base.map(x=>x.toLowerCase()).filter(x=>idx.has(x)));
    const arr = [...set];
    for(let i=0;i<arr.length;i++){
      for(let j=i;j<arr.length;j++){
        const ii = idx.get(arr[i]), jj = idx.get(arr[j]);
        M[ii][jj]++; if(ii!==jj) M[jj][ii]++;
      }
    }
  }
  return M;
}

/* Renders */
function renderBars(sel, pairs, cap=10, suffix=""){
  const root = $(sel); root.innerHTML="";
  if(!pairs.length){ root.innerHTML = '<div class="mono" style="color:#667085">No data</div>'; return; }
  const max = Math.max(...pairs.map(p=>p[1])) || 1;
  pairs.slice(0,cap).forEach(([label,val])=>{
    const row = document.createElement("div"); row.className="barrow";
    row.innerHTML = `<div class="label">${label}</div>
      <div class="barWrap"><div class="bar" style="width:${(100*val/max).toFixed(1)}%"></div></div>
      <div class="val">${val}${suffix?(" "+suffix):""}</div>`;
    root.appendChild(row);
  });
}
function renderHeat(sel, keys, M){
  const root = $(sel); root.innerHTML="";
  if(!keys.length){ root.innerHTML = '<div class="mono" style="color:#667085">No correlations yet.</div>'; return; }
  const K = keys.length, max = Math.max(1,...M.flat());
  root.className = "heat";
  root.style.gridTemplateColumns = `140px repeat(${K}, minmax(36px,1fr))`;
  const blank = document.createElement("div"); blank.className="lab hdr"; root.appendChild(blank);
  for(let j=0;j<K;j++){ const d=document.createElement("div"); d.className="lab hdr"; d.textContent=keys[j]; root.appendChild(d); }
  for(let i=0;i<K;i++){
    const lab = document.createElement("div"); lab.className="lab"; lab.textContent=keys[i]; root.appendChild(lab);
    for(let j=0;j<K;j++){
      const v = M[i][j], r=v/max, hue=210-Math.round(210*r), alpha=(0.15+0.65*r).toFixed(2);
      const cell = document.createElement("div"); cell.className="cell";
      cell.style.background = `hsla(${hue},85%,60%,${alpha})`;
      cell.title = `${keys[i]} × ${keys[j]}: ${v}`;
      cell.textContent = v? String(v): "";
      root.appendChild(cell);
    }
  }
}
function gradeClass(s){ return s>=70?"good":s>=45?"warn":"bad"; }
function renderLatest(list){
  const tbody = $("#latest"); tbody.innerHTML="";
  list.forEach(a=>{
    const tr = document.createElement("tr");
    const host = a.source || hostOf(a.link);
    tr.innerHTML = `
      <td><div style="font-weight:700">${a.title}</div>
          <div class="mono">${a.published || ""}</div>
          ${a.link? `<a href="${a.link}" target="_blank" rel="noopener">Open source</a>`:""}</td>
      <td>${host||"—"}</td>
      <td><span class="${gradeClass(a.confidence)}" style="font-weight:700">${a.confidence ?? "—"}</span></td>
      <td>${(a.keywords||[]).slice(0,6).join(", ")}</td>`;
    tbody.appendChild(tr);
  });
}
function renderSnapshot(list, kwPairs, srcPairs){
  const avg = list.length? Math.round(list.reduce((s,x)=>s+(x.confidence||0),0)/list.length) : 0;
  const rows = [
    ["Articles in window", String(list.length)],
    ["Top keyword", kwPairs[0]?.[0] || "—"],
    ["Top source", srcPairs[0]?.[0] || "—"],
    ["Avg confidence", String(avg)],
    ["Window (hours)", String(WINDOW_HOURS)],
  ];
  const tb = $("#snapshot"); tb.innerHTML="";
  for(const [k,v] of rows){
    const tr=document.createElement("tr"); tr.innerHTML=`<th>${k}</th><td>${v}</td>`;
    tb.appendChild(tr);
  }
}

/* Live loop */
let CACHE = [];
function withinWindow(a){ const age = Date.now() - (a._ts || Date.now()); return age <= WINDOW_HOURS*3600*1000; }
async function tick(){
  try{
    const data = await fetchJSON(buildUrl());
    const now = Date.now();
    const arr = (data.items||[]).map(x=>({ ...x, _ts: now, source: x.source || hostOf(x.link) }));
    // merge unique by (title|source)
    const map = new Map(CACHE.filter(withinWindow).map(x=>[(x.title+"|"+(x.source||"")).toLowerCase(), x]));
    arr.forEach(a=> map.set((a.title+"|"+(a.source||"")).toLowerCase(), a));
    CACHE = [...map.values()].sort((a,b)=> (b._ts)-(a._ts));

    const win = CACHE.filter(withinWindow);
    const srcCount = new Map(); win.forEach(a=>srcCount.set(a.source,(srcCount.get(a.source)||0)+1));
    const srcPairs = [...srcCount.entries()].sort((a,b)=>b[1]-a[1]);

    const kwPairs = topKeywords(win, 20);
    const keys = kwPairs.slice(0,12).map(p=>p[0]);
    const M = cooccurMatrix(win, keys);

    renderBars("#sources", srcPairs, 8, "articles");
    renderBars("#keywords", kwPairs, 12, "hits");
    // confidence per source
    const confMap = new Map();
    win.forEach(a=>{ const k=a.source; const v=confMap.get(k)||[0,0]; v[0]+=a.confidence||0; v[1]+=1; confMap.set(k,v); });
    const confPairs = [...confMap.entries()].map(([k,[s,c]])=>[k, Math.round(s/Math.max(1,c))]).sort((a,b)=>b[1]-a[1]);
    renderBars("#confSources", confPairs, 8, "conf");
    renderHeat("#heat", keys, M);
    renderLatest(win.slice(0,10));
    $("#lastUpdated").textContent = "Last updated " + new Date().toLocaleString();
  }catch(e){
    console.error(e);
    $("#lastUpdated").textContent = "Error: " + e;
  }finally{
    setTimeout(tick, FRONTEND_POLL_MS);
  }
}
function hostOf(link){ try{ return new URL(link).hostname.replace(/^www\./,''); }catch{ return ""; } }
tick();
</script>
</body>
</html>
