<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>AI-Generated News Summaries — Analytics</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root{
    --bg:#ffffff; --text:#0b1220; --muted:#667085; --accent:#0f6fff;
    --card:#ffffff; --border:#e5e7eb; --dash:#eef2f7;
  }
  *{box-sizing:border-box}
  body{ margin:0; background:var(--bg); color:var(--text);
        font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial; line-height:1.55; }
  header{ position:sticky; top:0; z-index:10; background:rgba(255,255,255,.92);
          backdrop-filter:saturate(140%) blur(6px); border-bottom:1px solid var(--border); }
  .wrap{ max-width:1200px; margin:0 auto; padding:16px; }
  h1{ margin:0; font-size:24px; font-weight:800; letter-spacing:.2px; }
  .toolbar{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:8px; }
  .pill{ display:inline-block; padding:6px 10px; border:1px solid var(--border); border-radius:999px; font-size:12px; color:#111; background:#f8fafc }
  .btn{ padding:8px 12px; border:1px solid var(--border); border-radius:10px; background:#fff; cursor:pointer; }
  .btn:hover{ border-color:#cbd5e1 }
  main{ padding:18px 0 60px }
  .grid{ display:grid; gap:16px; }
  @media (min-width:1000px){ .grid{ grid-template-columns: 2fr 1fr; } }
  .card{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:16px; }
  h2{ margin:0 0 10px; font-size:16px; font-weight:800 }
  .list{ display:flex; flex-direction:column; gap:10px }
  .barrow{ display:grid; grid-template-columns: 180px 1fr auto; gap:12px; align-items:center; }
  .barrow .label{ font-weight:600; font-size:14px; color:#0b1220; overflow:hidden; text-overflow:ellipsis; white-space:nowrap }
  .barrow .barWrap{ background:#f1f5f9; border-radius:8px; height:10px; position:relative }
  .barrow .bar{ position:absolute; left:0; top:0; bottom:0; border-radius:8px; background:linear-gradient(90deg,#0f6fff,#5aa3ff) }
  .barrow .val{ font-size:13px; color:var(--muted) }
  .table{ width:100%; border-collapse:collapse; font-size:14px }
  .table th,.table td{ border-bottom:1px dashed var(--dash); padding:8px 0; text-align:left; vertical-align:top }
  .heat{ display:grid; gap:2px; border:1px solid var(--border); border-radius:10px; padding:8px; overflow:auto; max-height:480px; background:#fff; }
  .heat .hdr{ position:sticky; top:0; background:#fff }
  .heat .cell{ display:flex; align-items:center; justify-content:center; height:26px; border-radius:4px; color:#0b1220; font-size:12px }
  .heat .lab{ font-size:12px; color:#111; white-space:nowrap }
  .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; color:#222 }
  .good{ color:#15803d } .warn{ color:#b45309 } .bad{ color:#b91c1c }
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>AI-Generated News Summaries — Analytics</h1>
    <div class="toolbar">
      <span id="last" class="pill">Last updated: …</span>
      <label class="pill">Window:
        <select id="winSel" style="border:none;background:transparent;outline:0">
          <option value="3">3h</option>
          <option value="6" selected>6h</option>
          <option value="12">12h</option>
          <option value="24">24h</option>
        </select>
      </label>
      <label class="pill">Refresh:
        <select id="refSel" style="border:none;background:transparent;outline:0">
          <option value="60000">60s</option>
          <option value="90000" selected>90s</option>
          <option value="180000">3m</option>
        </select>
      </label>
      <button id="refresh" class="btn">Refresh now</button>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="grid">
    <section class="card">
      <h2>Key Metrics</h2>
      <div style="display:grid;gap:16px;grid-template-columns:1fr 1fr">
        <div class="list" id="sources"></div>
        <div class="list" id="keywords"></div>
      </div>
      <div style="display:grid;gap:16px;grid-template-columns:1fr 1fr;margin-top:12px">
        <div>
          <h2>Average Confidence by Source</h2>
          <div class="list" id="confSources"></div>
        </div>
        <div>
          <h2>Snapshot</h2>
          <table class="table"><tbody id="snapshot"></tbody></table>
        </div>
      </div>
      <div style="display:grid;gap:16px;grid-template-columns:1fr 1fr;margin-top:12px">
        <div>
          <h2>Emerging Keywords (Momentum)</h2>
          <div class="list" id="momentum"></div>
        </div>
        <div>
          <h2>Confidence Delta (Last 3 polls)</h2>
          <div class="mono" id="confDelta">Loading…</div>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>Keyword Correlations (Co-occurrence)</h2>
      <div class="mono" style="color:#667085;margin-bottom:8px">Across the selected time window.</div>
      <div id="heat"></div>
    </section>
  </div>

  <section class="card" style="margin-top:16px">
    <h2>Latest Articles</h2>
    <table class="table">
      <thead>
        <tr><th style="width:40%">Title</th><th>Source</th><th>Confidence</th><th>Top Terms</th></tr>
      </thead>
      <tbody id="latest"></tbody>
    </table>
  </section>
</main>

<script>
const WORKER = "https://gozaddy.aristocles24.workers.dev";
const FEEDS_URL_DEFAULT = "https://raw.githubusercontent.com/DaScient/labs/main/gozaddy/feeds.txt";
const q = new URLSearchParams(location.search);
let WINDOW_HOURS = parseInt(q.get("window")||"6",10);
let REFRESH_MS   = Math.max(30_000, parseInt(q.get("refresh")||"90000",10));
const feedsUrl   = q.get("feedsUrl") || FEEDS_URL_DEFAULT;

// UI defaults
document.getElementById("winSel").value = String(WINDOW_HOURS);
document.getElementById("refSel").value = String(REFRESH_MS);

const SUM_URL = WORKER + "/summaries?feedsUrl=" + encodeURIComponent(feedsUrl) + "&limit=120&interval=3600";
const $ = s => document.querySelector(s);
function hostOf(link){ try{ return new URL(link).hostname.replace(/^www\./,''); }catch(_){ return ""; } }
function gradeClass(score){ return score>=70?"good":score>=45?"warn":"bad"; }
function words(t){ return (t.toLowerCase().match(/[a-z0-9]+/g)||[]); }
const STOP = new Set(`a,an,the,of,in,on,for,with,and,or,to,from,by,as,is,are,was,were,be,been,at,that,this,these,those,it,its,their,his,her,our,your,not,no,if,then,than,but,so,also,into,over,under,about,via,per,within,without,across,between,among,will,can,may,might,could,should,would`.split(","));

let LAST_HASH = "";
let CACHE = [];
let CONF_HISTORY = []; // array of avg confidence

function uniq(items){
  const seen=new Set(), out=[];
  for(const a of items){
    const k=((a.link||"") + "|" + (a.title||"")).toLowerCase();
    if(seen.has(k)) continue; seen.add(k); out.push(a);
  }
  return out;
}
async function sha(str){
  const d = new TextEncoder().encode(str);
  const b = await crypto.subtle.digest("SHA-256", d);
  return Array.from(new Uint8Array(b)).map(x=>x.toString(16).padStart(2,"0")).join("");
}
async function fetchJSON(url){
  const r = await fetch(url + "&_t=" + Date.now(), { cache:"no-store" });
  if(!r.ok) throw new Error("Fetch failed: " + r.status);
  return r.json();
}

function findKeywords(a){
  if (a.keywords?.length) return a.keywords;
  return words((a.summary||a.title||"")).filter(w=>!STOP.has(w)&&w.length>2).slice(0,8);
}

function topKeywords(articles, k=20){
  const freq = new Map();
  for(const a of articles){
    for(const kw of findKeywords(a)){
      const key = kw.toLowerCase();
      freq.set(key, (freq.get(key)||0)+1);
    }
  }
  return [...freq.entries()].sort((a,b)=>b[1]-a[1]).slice(0,k);
}

function cooccurMatrix(articles, keys){
  const K = keys.length;
  const index = new Map(keys.map((k,i)=>[k,i]));
  const M = Array.from({length:K},()=>Array(K).fill(0));
  for(const a of articles){
    const set = new Set(findKeywords(a).map(k=>k.toLowerCase()).filter(k=>index.has(k)));
    const arr = [...set];
    for(let i=0;i<arr.length;i++){
      for(let j=i;j<arr.length;j++){
        const ii=index.get(arr[i]), jj=index.get(arr[j]);
        M[ii][jj]++; if(ii!==jj) M[jj][ii]++;
      }
    }
  }
  return M;
}

function renderBars(sel, pairs, cap=10, suffix=""){
  const root = $(sel); root.innerHTML="";
  if(!pairs.length){ root.innerHTML='<div class="mono">No data</div>'; return; }
  const max = Math.max(...pairs.map(p=>p[1])) || 1;
  pairs.slice(0,cap).forEach(([lab,val])=>{
    const row=document.createElement("div"); row.className="barrow";
    row.innerHTML = `
      <div class="label">${lab}</div>
      <div class="barWrap"><div class="bar" style="width:${(100*val/max).toFixed(1)}%"></div></div>
      <div class="mono">${val}${suffix?(" "+suffix):""}</div>`;
    root.appendChild(row);
  });
}

function renderHeat(containerSel, keys, M){
  const root = $(containerSel); root.innerHTML="";
  if(!keys.length){ root.innerHTML='<div class="mono">No correlations yet.</div>'; return; }
  const K = keys.length;
  const max = Math.max(1, ...M.flat());
  root.className = "heat";
  root.style.gridTemplateColumns = `140px repeat(${K}, minmax(36px, 1fr))`;
  const blank=document.createElement("div"); blank.className="lab hdr"; root.appendChild(blank);
  for(let j=0;j<K;j++){ const d=document.createElement("div"); d.className="lab hdr"; d.textContent=keys[j]; root.appendChild(d); }
  for(let i=0;i<K;i++){
    const lab=document.createElement("div"); lab.className="lab"; lab.textContent=keys[i]; root.appendChild(lab);
    for(let j=0;j<K;j++){
      const v=M[i][j], ratio=v/max, hue=210-Math.round(210*ratio), alpha=0.15+0.65*ratio;
      const cell=document.createElement("div"); cell.className="cell";
      cell.style.background=`hsla(${hue},85%,60%,${alpha.toFixed(2)})`;
      cell.title=`${keys[i]} × ${keys[j]}: ${v}`; cell.textContent=v?String(v):"";
      root.appendChild(cell);
    }
  }
}

function renderLatest(list){
  const tbody=$("#latest"); tbody.innerHTML="";
  list.forEach(a=>{
    const tr=document.createElement("tr");
    const tdT=document.createElement("td");
    const tdS=document.createElement("td");
    const tdC=document.createElement("td");
    const tdK=document.createElement("td");
    tdT.innerHTML = `<div style="font-weight:700">${a.title}</div>
                     <div class="mono">${a.published || ""}</div>
                     ${a.link?`<a href="${a.link}" target="_blank" rel="noopener">Open source</a>`:""}`;
    const host = hostOf(a.link);
    tdS.textContent = host || "—";
    const cls = gradeClass(Math.round(a.confidence||0));
    tdC.innerHTML = `<span class="${cls}" style="font-weight:700">${Math.round(a.confidence||0)}</span>`;
    tdK.textContent = (findKeywords(a)||[]).slice(0,6).join(", ");
    tr.appendChild(tdT); tr.appendChild(tdS); tr.appendChild(tdC); tr.appendChild(tdK);
    tbody.appendChild(tr);
  });
}

function renderSnapshot(articles, kwPairs, sourcePairs){
  const total=articles.length;
  const avgConf= total? Math.round(articles.reduce((s,a)=>s+(a.confidence||0),0)/total) : 0;
  const rows=[
    ["Articles in window", String(total)],
    ["Top keyword", kwPairs[0]?.[0] || "—"],
    ["Top source", sourcePairs[0]?.[0] || "—"],
    ["Avg confidence", String(avgConf)],
    ["Window (hours)", String(WINDOW_HOURS)]
  ];
  const tb=$("#snapshot"); tb.innerHTML="";
  rows.forEach(([k,v])=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<th>${k}</th><td>${v}</td>`;
    tb.appendChild(tr);
  });

  // Track average confidence trend
  CONF_HISTORY.push(avgConf);
  if (CONF_HISTORY.length>3) CONF_HISTORY = CONF_HISTORY.slice(-3);
  $("#confDelta").textContent = (CONF_HISTORY.length>=2)
    ? `Last: ${CONF_HISTORY[CONF_HISTORY.length-1]} | Δ: ${CONF_HISTORY[CONF_HISTORY.length-1]-CONF_HISTORY[0]}`
    : "Collecting…";
}

function momentumKeywords(prevPairs, currPairs){
  const prev = new Map(prevPairs);
  const out = [];
  for(const [k,v] of currPairs){
    const delta = v - (prev.get(k)||0);
    if(delta>0) out.push([k, delta]);
  }
  return out.sort((a,b)=>b[1]-a[1]).slice(0,8);
}

/* live loop */
let PREV_KW = [];
let TIMER;

async function tick(){
  try{
    const j = await fetchJSON(SUM_URL);
    const items = uniq(j.items||[]).map(a=>({ ...a, observedAt: Date.now() }));
    // windowing by observed time
    const windowed = items; // payload already time-ordered; client refresh drives "window"

    // keep a rolling cache by time
    const now = Date.now();
    CACHE = CACHE.concat(items)
      .filter(a => now - a.observedAt <= WINDOW_HOURS*3600*1000);

    renderAll();
    $("#last").textContent = "Last updated: " + new Date().toLocaleString();
  }catch(e){
    console.error(e);
  }finally{
    TIMER = setTimeout(tick, REFRESH_MS);
  }
}

function renderAll(){
  const windowed = CACHE.slice().sort((a,b)=> (b.publishedTs||0)-(a.publishedTs||0));

  // sources
  const srcCounts = new Map();
  windowed.forEach(a=> srcCounts.set(hostOf(a.link)||"unknown", (srcCounts.get(hostOf(a.link)||"unknown")||0)+1));
  const sourcePairs = [...srcCounts.entries()].sort((a,b)=>b[1]-a[1]);

  // keywords
  const kwPairs = topKeywords(windowed, 20);

  // confidence by source
  const confMap = new Map();
  windowed.forEach(a=>{
    const k = hostOf(a.link)||"unknown";
    const acc = confMap.get(k)||[0,0]; acc[0]+=(a.confidence||0); acc[1]++; confMap.set(k, acc);
  });
  const confPairs = [...confMap.entries()].map(([h,[s,c]])=>[h, Math.round(s/c)]).sort((a,b)=>b[1]-a[1]);

  // correlations
  const keyList = kwPairs.slice(0,12).map(p=>p[0]);
  const M = cooccurMatrix(windowed, keyList);

  // momentum
  const momentum = momentumKeywords(PREV_KW, kwPairs);
  PREV_KW = kwPairs;

  // render
  renderBars("#sources", sourcePairs, 8, "articles");
  renderBars("#keywords", kwPairs, 12, "hits");
  renderBars("#confSources", confPairs, 8, "conf");
  renderHeat("#heat", keyList, M);
  renderLatest(windowed.slice(0,12));
  renderSnapshot(windowed, kwPairs, sourcePairs);

  // momentum list
  const mom = document.getElementById("momentum");
  mom.innerHTML = "";
  if (!momentum.length) { mom.innerHTML = '<div class="mono">No deltas yet.</div>'; }
  momentum.forEach(([k, d])=>{
    const row=document.createElement("div"); row.className="barrow";
    row.innerHTML = `<div class="label">${k}</div>
      <div class="barWrap"><div class="bar" style="width:${Math.min(100, d*25)}%"></div></div>
      <div class="mono">+${d}</div>`;
    mom.appendChild(row);
  });
}

/* controls */
document.getElementById("refresh").onclick = ()=>{ clearTimeout(TIMER); tick(); };
document.getElementById("winSel").onchange = (e)=>{ WINDOW_HOURS=parseInt(e.target.value,10); renderAll(); };
document.getElementById("refSel").onchange = (e)=>{
  REFRESH_MS = parseInt(e.target.value,10);
  clearTimeout(TIMER); tick();
};

tick();
</script>
</body>
</html>
