<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>AI-Generated News Summaries — Analytics</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root{
    --bg: #ffffff;
    --panel: #ffffff;
    --text: #0b1220;
    --muted:#667085;
    --line: #e8edf3;
    --dash:#eef3f8;
    --accent:#0f6fff;
    --good:#15803d; --warn:#b45309; --bad:#b91c1c;
    --h1:26px; --h2:16px; --body:16px; --mono:12px;
  }
  @media (min-width:1000px){ :root{ --h1:28px; --h2:18px; --body:17px; } }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--text); line-height:1.5;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
  }
  header{
    position:sticky; top:0; z-index:10; background:rgba(255,255,255,.92);
    backdrop-filter:saturate(140%) blur(6px); border-bottom:1px solid var(--line);
  }
  .wrap{ max-width:1200px; margin:0 auto; padding:14px 16px; }
  h1{ margin:0 0 2px; font-size:var(--h1); font-weight:800; letter-spacing:.2px }
  .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center }
  .pill{ display:inline-flex; align-items:center; gap:8px;
         padding:6px 10px; border:1px solid var(--line); border-radius:10px; font-size:13px; color:#111; background:#f8fafc; }
  .pill select{ border:0; background:transparent; font-size:13px; color:#111; outline:0 }
  .muted{ color:var(--muted) }
  main.wrap{ padding:18px 16px 60px }
  .grid{ display:grid; gap:16px }
  @media (min-width:1100px){ .grid{ grid-template-columns: 1.6fr 1fr } }
  .card{
    background:var(--panel); border:1px solid var(--line); border-radius:16px; padding:16px;
  }
  h2{ margin:0 0 10px; font-size:var(--h2); font-weight:800; letter-spacing:.2px }
  .kpis{ display:grid; gap:10px }
  @media (min-width:900px){ .kpis{ grid-template-columns: repeat(4, 1fr) } }
  .kpi{ border:1px dashed var(--dash); border-radius:12px; padding:12px }
  .kpi .big{ font-size:22px; font-weight:800 }
  .barrow{ display:grid; grid-template-columns: 160px 1fr auto; gap:10px; align-items:center; }
  .barrow .label{ font-weight:600; font-size:14px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap }
  .barrow .wrap{ background:#f1f5f9; border-radius:8px; height:10px; position:relative }
  .barrow .bar{ position:absolute; inset:0 auto 0 0; border-radius:8px; background:linear-gradient(90deg,#0f6fff,#5aa3ff); width:0% }
  .table{ width:100%; border-collapse:collapse; font-size:14px }
  .table th,.table td{ border-bottom:1px dashed var(--dash); padding:8px 0; text-align:left; vertical-align:top }
  .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:var(--mono); color:#222 }
  a{ color:var(--accent); text-decoration:none } a:hover{text-decoration:underline}
  .badge{ font-size:11px; padding:2px 8px; border-radius:999px; border:1px solid var(--line); background:#f6f7fb; color:#111 }
  .good{ color:var(--good)} .warn{ color:var(--warn)} .bad{ color:var(--bad)}
  .chip{ display:inline-block; padding:2px 8px; border:1px solid var(--line); border-radius:999px; margin:2px 6px 2px 0; font-size:12px; background:#fff }
  .spark{ width:100%; height:36px; display:block }
  .cards{ display:grid; gap:12px }
  @media (min-width:1000px){ .cards{ grid-template-columns: repeat(3, 1fr) } }
  .ticker{ border:1px solid var(--line); border-radius:14px; padding:12px }
  .ticker h3{ margin:0 0 6px; font-size:16px }
  .rowBetween{ display:flex; justify-content:space-between; gap:10px; align-items:center }
  .sep{ height:1px; background:var(--line); margin:8px 0 }
  .heat{
    display:grid; gap:2px; border:1px solid var(--line); border-radius:10px; padding:8px; overflow:auto; background:#fff; max-height:520px;
  }
  .heat .hdr{ position:sticky; top:0; background:#fff }
  .heat .cell{ display:flex; align-items:center; justify-content:center; height:26px; border-radius:4px; color:#0b1220; font-size:12px }
  .heat .lab{ font-size:12px; color:#111; white-space:nowrap }
  .blink{ animation:blink .8s ease 1 } @keyframes blink{ 50%{ box-shadow:0 0 0 3px rgba(15,111,255,.18)}}
  .hint{ font-size:12px; color:var(--muted) }
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>AI-Generated News Summaries — Analytics</h1>
    <div class="row">
      <span id="lastUpdated" class="pill muted">Last updated: —</span>
      <span class="pill">Window
        <select id="winSel">
          <option value="3">3h</option><option value="6" selected>6h</option>
          <option value="12">12h</option><option value="24">24h</option>
        </select>
      </span>
      <span class="pill">Refresh
        <select id="refSel">
          <option value="60000">60s</option>
          <option value="90000" selected>90s</option>
          <option value="180000">3m</option>
          <option value="300000">5m</option>
        </select>
      </span>
      <span class="pill">Theme
        <select id="themeSel">
          <option value="light" selected>Light</option>
          <option value="dark">Dark</option>
        </select>
      </span>
      <span class="pill">Filter <input id="kwFilter" placeholder="keyword…" style="border:0;outline:0;background:transparent" /></span>
      <button id="clearBtn" class="pill" type="button">Clear</button>
    </div>
    <div class="hint" style="margin-top:6px">
      Tip: control via URL, e.g. <span class="mono">?window=6&refresh=90000&watch=GLD:gold,metal|CVX:oil,gas,chevron|RCI:travel,cruise,airline</span>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="grid">
    <section class="card">
      <h2>Key Intelligence</h2>
      <div class="kpis" id="kpis">
        <div class="kpi">
          <div class="muted">Articles (window)</div>
          <div class="big" id="kpiCount">—</div>
        </div>
        <div class="kpi">
          <div class="muted">Avg Confidence</div>
          <div class="big" id="kpiConf">—</div>
        </div>
        <div class="kpi">
          <div class="muted">Heat Index (∑ kw × conf)</div>
          <div class="big" id="kpiHeat">—</div>
        </div>
        <div class="kpi">
          <div class="muted">Newcomer Keywords</div>
          <div class="big" id="kpiNewKw">—</div>
        </div>
      </div>

      <div class="sep"></div>
      <h2 style="margin-top:0">Commodity Watch</h2>
      <div class="cards" id="watchList"></div>

      <div class="sep"></div>
      <div class="rowBetween">
        <h2 style="margin-top:0">Top Keywords</h2>
        <span class="hint">Frequency within window</span>
      </div>
      <div id="keywords"></div>

      <div class="sep"></div>
      <div class="rowBetween">
        <h2>Phrases on the Move</h2>
        <span class="hint">Bigrams & Trigrams with biggest Δ vs. prior polls</span>
      </div>
      <table class="table"><tbody id="phrases"></tbody></table>
    </section>

    <section class="card">
      <h2>Keyword Correlations</h2>
      <div class="hint" style="margin-bottom:8px">Co-occurrence across the current window (top terms). Click a keyword to focus.</div>
      <div id="heat"></div>

      <div class="sep"></div>
      <h2>Latest Articles</h2>
      <table class="table">
        <thead>
          <tr><th style="width:42%">Title</th><th>Source</th><th>Confidence</th><th>Top Terms</th></tr>
        </thead>
        <tbody id="latest"></tbody>
      </table>
    </section>
  </div>
</main>

<script>
/* ===== CONFIG ===== */
const WORKER_URL = (new URLSearchParams(location.search).get("worker")) ||
  "https://gozaddy.aristocles24.workers.dev/summaries";

const DEFAULT_FEEDS = [
  // (Short curated list; your Worker already supports many more)
  "https://feeds.reuters.com/reuters/topNews",
  "https://feeds.reuters.com/Reuters/worldNews",
  "https://www.aljazeera.com/xml/rss/all.xml",
  "https://feeds.bbci.co.uk/news/rss.xml",
  "https://rss.dw.com/rdf/rss-en-all",
  "https://www.nytimes.com/services/xml/rss/nyt/HomePage.xml",
  "https://feeds.washingtonpost.com/rss/world"
].join(",");

// Watchlist: Symbol label + keyword aliases. Override via ?watch=GLD:gold,metal|CVX:chevron,oil,gas|RCI:travel,cruise
let WATCH = [
  { symbol: "GLD", label: "Gold", aliases: ["gold","metal","bullion","gold price","gold prices"] },
  { symbol: "CVX", label: "Chevron / Nat Gas", aliases: ["chevron","oil","natural gas","lng","refinery","opec","brent","wti","gas"] },
  { symbol: "RCI", label: "Travel", aliases: ["travel","tourism","cruise","airline","hotel","booking","visa","visa-free"] }
];

const qWatch = new URLSearchParams(location.search).get("watch");
if(qWatch){
  try{
    WATCH = qWatch.split("|").map(def=>{
      const [sym,rest] = def.split(":");
      return { symbol: sym.trim(), label: sym.trim(), aliases: (rest||"").split(",").map(s=>s.trim()).filter(Boolean) };
    }).filter(w=>w.symbol);
  }catch(_){}
}

/* ===== UI controls ===== */
const $ = s => document.querySelector(s);
const winSel = $("#winSel"), refSel = $("#refSel"), themeSel = $("#themeSel"),
      lastUpdated = $("#lastUpdated"), kwFilter = $("#kwFilter"), clearBtn = $("#clearBtn");
const qp = new URLSearchParams(location.search);
if(qp.get("window")) winSel.value = qp.get("window");
if(qp.get("refresh")) refSel.value = qp.get("refresh");
if(qp.get("theme")) themeSel.value = qp.get("theme");
if(themeSel.value === "dark") applyDarkTheme();

winSel.onchange = persistAndReload;
refSel.onchange = persistAndReload;
themeSel.onchange = ()=>{ (themeSel.value==="dark")?applyDarkTheme():applyLightTheme(); persistAndReload(false); };
kwFilter.oninput = renderAll;
clearBtn.onclick = ()=>{ kwFilter.value=""; renderAll(); };
function persistAndReload(refresh=true){
  const nqp = new URLSearchParams(location.search);
  nqp.set("window", winSel.value);
  nqp.set("refresh", refSel.value);
  nqp.set("theme", themeSel.value);
  history.replaceState(null,"","?"+nqp.toString());
  if(refresh) tick(true);
}
function applyDarkTheme(){
  document.documentElement.style.setProperty("--bg", "#0e1117");
  document.documentElement.style.setProperty("--panel", "#0f141d");
  document.documentElement.style.setProperty("--text", "#e6e9ef");
  document.documentElement.style.setProperty("--muted", "#9aa4b2");
  document.documentElement.style.setProperty("--line", "#202636");
  document.documentElement.style.setProperty("--dash", "#2a3344");
}
function applyLightTheme(){
  document.documentElement.style.setProperty("--bg", "#ffffff");
  document.documentElement.style.setProperty("--panel", "#ffffff");
  document.documentElement.style.setProperty("--text", "#0b1220");
  document.documentElement.style.setProperty("--muted", "#667085");
  document.documentElement.style.setProperty("--line", "#e8edf3");
  document.documentElement.style.setProperty("--dash", "#eef3f8");
}

/* ===== Helpers ===== */
const STOP = new Set(`a,an,the,of,in,on,for,with,and,or,to,from,by,as,is,are,was,were,be,been,at,that,this,these,those,it,its,their,his,her,our,your,not,no,if,then,than,but,so,also,into,over,under,about,via,per,within,without,across,between,among,will,can,may,might,could,should,would`.split(","));
function words(t){ return (t.toLowerCase().replace(/<\/?[^>]+>/g," ").match(/[a-z0-9]+/g)||[]); }
function hostOf(link){ try{ return new URL(link).hostname.replace(/^www\./,''); }catch(_){ return ""; } }
function uniq(arr){ return [...new Set(arr)] }
function clamp(n,a,b){ return Math.max(a, Math.min(b,n)) }

function seoKeywords(text){
  const m = text.match(/^\s*seo keywords:\s*(.+)$/gim);
  if(!m) return [];
  return (m[m.length-1].split(":")[1]||"").split(/[;,]/g).map(s=>s.trim()).filter(Boolean);
}
function topKeywords(articles, k=20){
  const freq = new Map();
  for(const a of articles){
    let kws = seoKeywords(a.body);
    if(!kws.length) kws = words(a.body).filter(w=>!STOP.has(w)&&w.length>2).slice(0,100);
    for(const kw of kws){ const key = kw.toLowerCase(); freq.set(key, (freq.get(key)||0)+1); }
  }
  return [...freq.entries()].sort((a,b)=>b[1]-a[1]).slice(0,k);
}
function bigramsAndTrigrams(text){
  const w = words(text).filter(x=>!STOP.has(x) && x.length>2);
  const bi=[], tri=[];
  for(let i=0;i<w.length-1;i++){ bi.push(w[i]+" "+w[i+1]); if(i<w.length-2) tri.push(w[i]+" "+w[i+1]+" "+w[i+2]); }
  return { bi, tri };
}

/* Confidence heuristic */
const POS = new Set("confirm,confirmed,official,approved,announced,launch,launched,records,record,acquires,acquired,sec filing,final,definitive,report,results".split(","));
const NEG = new Set("may,might,could,reportedly,rumor,alleged,seems,suggests,likely,unverified,investigating,unclear,disputed,questioned,unconfirmed".split(","));
function confidenceScore(text, sourceHost=""){
  const bag = words(text);
  let pos=0, neg=0; for(const w of bag){ if(POS.has(w)) pos++; if(NEG.has(w)) neg++; }
  let score = 52 + 6*pos - 6*neg;
  if(/nytimes\.com|washingtonpost\.com|reuters\.com|bbc\.co\.uk|aljazeera\.com/i.test(sourceHost)) score += 6;
  return clamp(score, 0, 100);
}

/* Co-occurrence matrix */
function cooccurMatrix(articles, keys){
  const K = keys.length, idx = new Map(keys.map((k,i)=>[k,i]));
  const M = Array.from({length:K},()=>Array(K).fill(0));
  for(const a of articles){
    let kws = seoKeywords(a.body);
    if(!kws.length) kws = words(a.body).filter(w=>!STOP.has(w)&&w.length>2).slice(0,60);
    const set = new Set(kws.map(k=>k.toLowerCase()).filter(k=>idx.has(k)));
    const arr = [...set];
    for(let i=0;i<arr.length;i++){
      for(let j=i;j<arr.length;j++){
        const ii=idx.get(arr[i]), jj=idx.get(arr[j]); M[ii][jj]++; if(ii!==jj) M[jj][ii]++;
      }
    }
  }
  return M;
}

/* Z-score helper for mentions */
function zScore(series){
  if(series.length<4) return 0;
  const mean = series.reduce((a,b)=>a+b,0)/series.length;
  const sd = Math.sqrt(series.reduce((s,x)=>s+Math.pow(x-mean,2),0)/series.length) || 1;
  return (series[series.length-1]-mean)/sd;
}

/* Tiny sparkline (SVG) */
function spark(values, w=160, h=36, pad=4){
  if(!values.length) return `<svg class="spark" viewBox="0 0 ${w} ${h}"></svg>`;
  const min=Math.min(...values), max=Math.max(...values), span=Math.max(1, max-min);
  const step = (w-2*pad)/Math.max(1,values.length-1);
  const pts = values.map((v,i)=>{
    const x = pad + i*step;
    const y = h-pad - ((v-min)/span)*(h-2*pad);
    return `${x.toFixed(1)},${y.toFixed(1)}`;
  }).join(" ");
  return `<svg class="spark" viewBox="0 0 ${w} ${h}">
    <polyline points="${pts}" fill="none" stroke="currentColor" stroke-width="2" opacity="0.85"/>
  </svg>`;
}

/* ===== State ===== */
let FRONTEND_POLL_MS = parseInt(refSel.value,10);
let WINDOW_HOURS = parseInt(winSel.value,10);
let CACHE = []; // merged window articles
let POLL_HISTORY = []; // last N polls, each {ts, mentionsByTheme:{sym:count}}
let LAST_ETAG = "";

/* ===== Fetch & parse ===== */
async function loadSummaries(){
  const feedsQS = new URLSearchParams(location.search).get("feeds") || DEFAULT_FEEDS;
  const url = `${WORKER_URL}?feeds=${encodeURIComponent(feedsQS)}&limit=80&interval=${3600}&_t=${Date.now()}`;
  const r = await fetch(url, { cache:"no-store" });
  if(!r.ok) throw new Error("Fetch failed: "+r.status);
  return r.json();
}

function normalizeArticles(jsonList){
  // Worker returns array of [{title, link, published, summary, body, host, confidence, topTerms}] or similar
  return (jsonList||[]).map(x=>{
    const title = String(x.title||"").replace(/<!\[CDATA\[|\]\]>/g,"").trim();
    const body = String(x.summary||x.body||"").trim();
    const link = x.link||"";
    const host = x.host || hostOf(link);
    const published = x.published || "";
    const confidence = typeof x.confidence==="number" ? x.confidence : confidenceScore(body, host);
    const topTerms = Array.isArray(x.topTerms) ? x.topTerms :
      uniq((seoKeywords(body).length? seoKeywords(body): words(body).filter(w=>!STOP.has(w)).slice(0,8)).map(w=>w.toLowerCase()));
    return { title, link, host, published, body, confidence, topTerms, observedAt: Date.now() };
  });
}

/* ===== Render helpers ===== */
function renderBars(containerSel, pairs, cap=10, suffix=""){
  const root = $(containerSel); root.innerHTML="";
  if(!pairs.length){ root.innerHTML = '<div class="muted">No data</div>'; return; }
  const max = Math.max(...pairs.map(p=>p[1])) || 1;
  pairs.slice(0,cap).forEach(([label,val])=>{
    const row = document.createElement("div"); row.className="barrow";
    row.innerHTML = `<div class="label">${label}</div>
      <div class="wrap"><div class="bar" style="width:${(100*val/max).toFixed(1)}%"></div></div>
      <div class="mono">${val} ${suffix||""}</div>`;
    root.appendChild(row);
  });
}

function renderHeat(containerSel, keys, M){
  const root = $(containerSel); root.innerHTML="";
  if(!keys.length){ root.innerHTML='<div class="muted">No correlations yet.</div>'; return; }
  const K = keys.length, max = Math.max(1, ...M.flat());
  root.className = "heat";
  root.style.gridTemplateColumns = `140px repeat(${K}, minmax(32px, 1fr))`;
  const filt = (kwFilter.value||"").trim().toLowerCase();
  const mask = keys.map(k => !filt || k.includes(filt));
  // header
  root.appendChild(Object.assign(document.createElement("div"), {className:"lab hdr"}));
  for(let j=0;j<K;j++){ if(!mask[j]) continue;
    const d=document.createElement("div"); d.className="lab hdr"; d.textContent=keys[j]; d.style.cursor="pointer";
    d.onclick=()=>{ kwFilter.value=keys[j]; renderAll(); };
    root.appendChild(d);
  }
  // rows
  for(let i=0;i<K;i++){ if(!mask[i]) continue;
    const lab = document.createElement("div"); lab.className="lab"; lab.textContent=keys[i]; lab.style.cursor="pointer";
    lab.onclick=()=>{ kwFilter.value=keys[i]; renderAll(); };
    root.appendChild(lab);
    for(let j=0;j<K;j++){ if(!mask[j]) continue;
      const v = M[i][j], ratio = v/max;
      const hue = 140 - Math.round(140*ratio); const alpha = 0.12 + 0.68*ratio;
      const cell = document.createElement("div"); cell.className="cell";
      cell.style.background = `hsla(${hue}, 70%, 45%, ${alpha.toFixed(2)})`;
      cell.title = `${keys[i]} × ${keys[j]}: ${v}`; cell.textContent = v? String(v): "";
      root.appendChild(cell);
    }
  }
}

function renderLatest(list){
  const tbody = $("#latest"); tbody.innerHTML="";
  const filt = (kwFilter.value||"").trim().toLowerCase();
  list.forEach(a=>{
    if(filt && !((a.title||"").toLowerCase().includes(filt) || a.topTerms.some(t=>t.includes(filt)))) return;
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><div style="font-weight:700">${a.title}</div>
          <div class="mono">${a.published || ""}</div>
          ${a.link ? `<a href="${a.link}" target="_blank" rel="noopener">Open source</a>` : ""}</td>
      <td>${a.host || "—"}</td>
      <td><span class="${a.confidence>=70?"good":a.confidence>=45?"warn":"bad"}" style="font-weight:700">${a.confidence}</span></td>
      <td>${(a.topTerms||[]).slice(0,6).join(", ")}</td>`;
    tbody.appendChild(tr);
  });
}

/* Commodity Watch render */
function renderWatch(windowed){
  const root = $("#watchList"); root.innerHTML="";
  // Build counts across window and last few polls for spark
  const themeData = WATCH.map(w=>{
    const matcher = new RegExp(`\\b(${w.aliases.map(a=>a.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")).join("|")})\\b`, "i");
    const hits = windowed.filter(a => matcher.test(a.title) || matcher.test(a.body));
    const heat = hits.reduce((s,a)=> s + a.confidence*(a.topTerms?.length||1), 0);
    // spark from POLL_HISTORY mentions
    const series = POLL_HISTORY.map(p=> p.mentionsByTheme[w.symbol]||0).slice(-14);
    const delta = series.length>=2 ? (series[series.length-1] - series[series.length-2]) : 0;
    const z = zScore(series);
    const samples = hits.slice(0,3).map(a=>a.title);
    // co-mentions
    const freq = new Map();
    hits.forEach(a=> (a.topTerms||[]).forEach(t=>freq.set(t,(freq.get(t)||0)+1)));
    const topCo = [...freq.entries()].sort((a,b)=>b[1]-a[1]).slice(0,6).map(x=>x[0]);
    return { ...w, count:hits.length, heat:Math.round(heat), delta, z:Math.round(z*10)/10, series, samples, co:topCo };
  });

  themeData.forEach(t=>{
    const alert = t.z>=1.25 ? `<span class="badge" style="border-color:#ffe8b3;background:#fff7db;color:#8a5a00">Anomaly z=${t.z}</span>` : "";
    const el = document.createElement("div"); el.className="ticker";
    el.innerHTML = `
      <h3 class="rowBetween"><span>${t.label} <span class="badge mono">${t.symbol}</span></span> ${alert}</h3>
      <div class="rowBetween">
        <div><div class="muted">Mentions</div><div class="big">${t.count}</div></div>
        <div><div class="muted">Δ (prev poll)</div><div class="${t.delta>=0?'good':'bad'}" style="font-weight:700">${t.delta>=0?'+':''}${t.delta}</div></div>
        <div><div class="muted">Heat Index</div><div class="big">${t.heat}</div></div>
      </div>
      ${spark(t.series)}
      <div class="muted" style="margin:6px 0 4px">Co-mentions</div>
      <div>${t.co.map(c=>`<span class="chip">${c}</span>`).join(" ")||'<span class="muted">—</span>'}</div>
      <div class="muted" style="margin:10px 0 4px">Recent headlines</div>
      <ul style="margin:0;padding-left:18px">${t.samples.map(s=>`<li>${s}</li>`).join("")||'<li class="muted">No samples</li>'}</ul>
    `;
    root.appendChild(el);
  });
}

/* Phrases Δ render */
function renderPhrases(windowed){
  // Current freq
  const cur = new Map();
  windowed.forEach(a=>{
    const {bi,tri} = bigramsAndTrigrams(a.body+" "+a.title);
    [...bi,...tri].forEach(p=> cur.set(p, (cur.get(p)||0)+1));
  });
  // Previous aggregate (from prior polls but outside current window, light approximation)
  const prev = new Map();
  (POLL_HISTORY.slice(0,-1)).forEach(p=>{
    Object.entries(p.ngrams||{}).forEach(([k,v])=> prev.set(k, (prev.get(k)||0)+v));
  });

  const delta = [...cur.entries()].map(([k,v])=> [k, v - (prev.get(k)||0), v]).filter(x=>x[2]>1);
  delta.sort((a,b)=> (b[1]-a[1]) || (b[2]-a[2]));
  const top = delta.slice(0,12);

  const tbody = $("#phrases"); tbody.innerHTML="";
  top.forEach(([ph,d,v])=>{
    const tr=document.createElement("tr");
    tr.innerHTML = `<td>${ph}</td><td class="${d>=0?'good':'bad'}" style="font-weight:700">${d>=0?'+':''}${d}</td><td class="mono muted">${v} hits</td>`;
    tbody.appendChild(tr);
  });
}

/* Keywords & Snapshot */
function renderKeywords(windowed){
  const kwPairs = topKeywords(windowed, 18);
  renderBars("#keywords", kwPairs, 18, "hits");
}
function renderKpis(windowed){
  const count = windowed.length;
  const avgConf = count? Math.round(windowed.reduce((s,a)=>s+a.confidence,0)/count) : 0;
  const heat = windowed.reduce((s,a)=> s + a.confidence*(a.topTerms?.length||1), 0);
  const seen = new Set(); const prevSeen = new Set();
  windowed.forEach(a=> (a.topTerms||[]).forEach(t=> seen.add(t)));
  (POLL_HISTORY.slice(0,-1)).forEach(p=> (p.topSet||[]).forEach(k=> prevSeen.add(k)));
  const newcomers = [...seen].filter(x=>!prevSeen.has(x)).length;

  $("#kpiCount").textContent = count;
  $("#kpiConf").textContent = avgConf;
  $("#kpiHeat").textContent = Math.round(heat);
  $("#kpiNewKw").textContent = newcomers;
}

/* ===== Main render orchestrator ===== */
function renderAll(){
  const windowed = CACHE.filter(a => (Date.now()-a.observedAt) <= WINDOW_HOURS*3600*1000);
  const filt = (kwFilter.value||"").trim().toLowerCase();
  const filtered = !filt ? windowed :
    windowed.filter(a => a.title.toLowerCase().includes(filt) || a.topTerms.some(t=>t.includes(filt)));

  // Core sections
  renderKpis(filtered);
  renderWatch(filtered);
  renderKeywords(filtered);
  renderPhrases(filtered);

  // Heatmap
  const kwPairs = topKeywords(filtered, 14);
  const keys = kwPairs.map(p=>p[0]);
  renderHeat("#heat", keys, cooccurMatrix(filtered, keys));

  // Latest table
  renderLatest(filtered.slice(0,12));
}

/* ===== Poll loop ===== */
async function tick(force=false){
  try{
    FRONTEND_POLL_MS = parseInt(refSel.value,10);
    WINDOW_HOURS = parseInt(winSel.value,10);

    const data = await loadSummaries();
    const etag = (data && data.etag) || JSON.stringify(data).slice(0,200);
    if(!force && etag===LAST_ETAG){ setTimeout(()=>tick(false), FRONTEND_POLL_MS); return; }
    LAST_ETAG = etag;

    const articles = normalizeArticles(data.items || data);
    // Merge de-duped by (title|host)
    const map = new Map(CACHE.map(a=>[(a.title+"|"+a.host).toLowerCase(), a]));
    articles.forEach(a=> map.set((a.title+"|"+a.host).toLowerCase(), a));
    CACHE = [...map.values()].sort((a,b)=> b.observedAt - a.observedAt);

    // Build poll snapshot for watchlist & phrases
    const mentionsByTheme = {};
    WATCH.forEach(w=>{
      const re = new RegExp(`\\b(${w.aliases.map(a=>a.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")).join("|")})\\b`, "i");
      mentionsByTheme[w.symbol] = CACHE.filter(a => (Date.now()-a.observedAt)<=WINDOW_HOURS*3600*1000 && (re.test(a.title)||re.test(a.body))).length;
    });
    const ngrams = {};
    CACHE.slice(0,60).forEach(a=>{
      const {bi,tri} = bigramsAndTrigrams(a.body+" "+a.title);
      [...bi,...tri].forEach(p=> ngrams[p]=(ngrams[p]||0)+1);
    });
    const topSet = topKeywords(CACHE.slice(0,60), 40).map(p=>p[0]);

    POLL_HISTORY.push({ ts: Date.now(), mentionsByTheme, ngrams, topSet });
    if(POLL_HISTORY.length>48) POLL_HISTORY.shift();

    renderAll();
    lastUpdated.textContent = "Last updated: " + new Date().toLocaleString();

    document.querySelectorAll(".card").forEach(c=>{ c.classList.add("blink"); setTimeout(()=>c.classList.remove("blink"), 900); });
  }catch(e){
    console.error(e);
  }finally{
    setTimeout(()=>tick(false), FRONTEND_POLL_MS);
  }
}

/* Boot */
tick(true);
</script>
</body>
</html>
