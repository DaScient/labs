<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>AI-Generated News Summaries — Analytics</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root{
    /* light/transparent friendly */
    --bg: transparent;         /* allow embedding on white sites */
    --surface:#ffffff;         /* card background */
    --text:#0b1220;            /* primary text */
    --muted:#667085;           /* secondary text */
    --accent:#0f6fff;          /* links/accents */
    --border:#e5e7eb;          /* hairlines */
    --dash:#eef2f7;            /* dashed rows */

    --title:24px; --h2:16px; --body:16px; --mono:12px;
  }
  @media (min-width:1100px){
    :root{ --title:28px; --h2:18px; --body:17px; }
  }
  *{ box-sizing:border-box }
  html,body{ height:100% }
  body{
    margin:0;
    color:var(--text);
    background:var(--bg);
    font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
    line-height:1.5;
  }

  header{
    position:sticky; top:0; z-index:10;
    background:rgba(255,255,255,.92);
    backdrop-filter:saturate(140%) blur(6px);
    border-bottom:1px solid var(--border);
  }
  .wrap{ max-width:1200px; margin:0 auto; padding:16px; }
  h1{ margin:0; font-size:var(--title); font-weight:800; letter-spacing:.2px }
  .sub{ font-size:13px; color:var(--muted); margin-top:4px }

  .controls{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:10px }
  .pill{
    display:inline-flex; align-items:center; gap:6px;
    border:1px solid var(--border); border-radius:999px;
    padding:5px 10px; background:#f9fafb; color:#101828; font-size:12px;
  }
  select,button{
    font:inherit; font-size:13px; color:#111;
    border:1px solid var(--border); background:#fff; border-radius:10px;
    padding:6px 10px; outline:none; cursor:pointer;
  }
  button:hover, select:hover{ border-color:#d1d5db }

  main{ padding:18px 0 60px }
  .grid{ display:grid; gap:16px }
  @media (min-width:1100px){
    .grid{ grid-template-columns: 2fr 1fr; }
  }
  .card{
    background:var(--surface); border:1px solid var(--border);
    border-radius:14px; padding:16px;
  }
  h2{ margin:0 0 12px; font-size:var(--h2); font-weight:800; letter-spacing:.2px }

  .list{ display:flex; flex-direction:column; gap:10px }
  .barrow{ display:grid; grid-template-columns: 180px 1fr auto; gap:12px; align-items:center; }
  .barrow .label{ font-weight:600; font-size:14px; color:#0b1220; overflow:hidden; text-overflow:ellipsis; white-space:nowrap }
  .barrow .barWrap{ background:#f1f5f9; border-radius:8px; height:10px; position:relative }
  .barrow .bar{ position:absolute; left:0; top:0; bottom:0; border-radius:8px; background:linear-gradient(90deg,#0f6fff,#5aa3ff) }
  .barrow .val{ font-size:13px; color:var(--muted) }

  .table{ width:100%; border-collapse:collapse; font-size:14px }
  .table th,.table td{ border-bottom:1px dashed var(--dash); padding:8px 0; text-align:left; vertical-align:top }
  .table th{ font-weight:700; color:#111 }

  .muted{ color:var(--muted) }
  .good{ color:#15803d } .warn{ color:#b45309 } .bad{ color:#b91c1c }

  .heat{
    display:grid; gap:2px; border:1px solid var(--border); border-radius:10px; padding:8px;
    overflow:auto; max-height:520px; background:#fff;
  }
  .heat .hdr{ position:sticky; top:0; background:#fff; z-index:1 }
  .heat .cell{ display:flex; align-items:center; justify-content:center; height:26px; border-radius:4px; color:#0b1220; font-size:12px }
  .heat .lab{ font-size:12px; color:#111; white-space:nowrap }

  .mono{ font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; font-size:var(--mono); color:#222 }

  /* micro sparklines (pure CSS/inline SVG) */
  .spark{ height:28px; display:flex; align-items:center }
  .spark svg{ width:100%; height:20px; }

  .grid2{ display:grid; gap:12px }
  @media (min-width:1100px){ .grid2{ grid-template-columns:1fr 1fr } }

  .blink{ animation:blink .8s ease 1 } @keyframes blink{ 50%{ box-shadow:0 0 0 3px rgba(15,111,255,.18)}}

  a{ color:var(--accent); text-decoration:none } a:hover{ text-decoration:underline }
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>AI-Generated News Summaries — Analytics</h1>
    <div class="sub">Live decision signals from your AI summaries (keywords, momentum, confidence, clusters).</div>

    <div class="controls">
      <span class="pill">Last updated: <span id="lastUpdated" class="mono">—</span></span>
      <label class="pill">Window:
        <select id="windowSel">
          <option value="1">1h</option>
          <option value="3">3h</option>
          <option value="6" selected>6h</option>
          <option value="12">12h</option>
          <option value="24">24h</option>
        </select>
      </label>
      <label class="pill">Refresh:
        <select id="refreshSel">
          <option value="30000">30s</option>
          <option value="60000" selected>60s</option>
          <option value="90000">90s</option>
          <option value="300000">5m</option>
        </select>
      </label>
      <button id="refreshBtn">Refresh Now</button>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="grid">
    <section class="card">
      <h2>Key Metrics</h2>
      <div class="grid2">
        <div>
          <div class="list" id="sources"></div>
        </div>
        <div>
          <div class="list" id="keywords"></div>
        </div>
      </div>

      <div class="grid2" style="margin-top:12px">
        <div>
          <h2>Average Confidence by Source</h2>
          <div class="list" id="confSources"></div>
        </div>
        <div>
          <h2>Snapshot</h2>
          <table class="table">
            <tbody id="snapshot"></tbody>
          </table>
        </div>
      </div>

      <div class="grid2" style="margin-top:12px">
        <div>
          <h2>Emerging Keywords (Momentum)</h2>
          <div class="list" id="momentum"></div>
        </div>
        <div>
          <h2>Confidence Delta (Last 3 polls)</h2>
          <div class="list" id="confDelta"></div>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>Keyword Correlations (Co-occurrence)</h2>
      <div class="muted" style="margin-bottom:8px">Across the selected time window.</div>
      <div id="heat"></div>
    </section>
  </div>

  <section class="card" style="margin-top:16px">
    <h2>Event Clusters (By Shared Keyword)</h2>
    <div id="clusters" class="list"></div>
  </section>

  <section class="card" style="margin-top:16px">
    <h2>Latest Articles</h2>
    <table class="table">
      <thead>
        <tr>
          <th style="width:42%">Title</th>
          <th>Source</th>
          <th>Confidence</th>
          <th>Top Terms</th>
        </tr>
      </thead>
      <tbody id="latest"></tbody>
    </table>
  </section>
</main>

<script>
/* ===== CONFIG ===== */
/* Your worker endpoint returning ASCII summaries (unchanged contract) */
const WORKER_ASCII_URL =
  "https://gozaddy.aristocles24.workers.dev/ascii" +
  "?feeds=" + encodeURIComponent([
    "https://rss.nytimes.com/services/xml/rss/nyt/HomePage.xml",
    "https://feeds.washingtonpost.com/rss/national",
    "https://www.forbes.com/most-popular/feed/",
    "https://www.aljazeera.com/xml/rss/all.xml",
    "https://www.reutersagency.com/feed/?best-topics=top-news",
    "https://feeds.npr.org/1001/rss.xml",
    "https://www.ft.com/?format=rss",
    "https://www.economist.com/latest/rss.xml",
    "https://www.theguardian.com/world/rss",
    "https://apnews.com/rss"
  ].join(",")) +
  "&limit=24&interval=3600"; // worker refresh guarantees ≤ hourly on the server

/* defaults (can be changed via header controls) */
let FRONTEND_POLL_MS = 60_000; // 60s
let WINDOW_HOURS = 6;

/* ===== UTIL ===== */
const $ = (s)=>document.querySelector(s);
const nowStr = ()=>new Date().toLocaleString();

async function fetchText(url){
  const r = await fetch(url + "&_t=" + Date.now(), { cache:"no-store" });
  if(!r.ok) throw new Error("Fetch failed "+r.status);
  return r.text();
}
async function sha(str){
  const d = new TextEncoder().encode(str);
  const b = await crypto.subtle.digest("SHA-256", d);
  return Array.from(new Uint8Array(b)).map(x=>x.toString(16).padStart(2,"0")).join("");
}
function hostOf(link){
  try{ return new URL(link).hostname.replace(/^www\./,''); }catch(_){ return ""; }
}
function gradeClass(score){ return score>=70?"good":score>=45?"warn":"bad"; }

/* ===== Title / SEO / CDATA normalization ===== */
function cleanTitle(t){
  if(!t) return "(untitled)";
  // Strip CDATA
  t = t.replace(/^<!\[CDATA\[/i,'').replace(/\]\]>$/,'').trim();
  // Remove any SEO KEYWORDS lines accidentally at top
  if(/^seo keywords:/i.test(t)) return "(untitled)";
  // Collapse whitespace & trim artifacts
  return t.replace(/\s+/g,' ').replace(/\s*\|\s*$/,'').trim();
}

/* ===== Parse Worker ASCII (robust) =====
Block format:
  Title | link | published
  ------------------------   (>=20 dashes)
  BODY...
  ---------------------------------------------------------- (>=60 dashes)  ← separator
*/
function parseArticles(txt){
  const lines = txt.split(/\r?\n/);
  // skip banner headers
  let i=0; while(i<lines.length && (lines[i].startsWith("=") || !lines[i].trim())) i++;
  // cut footer note if present
  const footIdx = lines.findIndex(L=>/\(Updates hourly/i.test(L));
  const usable = (footIdx>-1 ? lines.slice(i, footIdx) : lines.slice(i));

  const out = [];
  let idx=0;
  while(idx<usable.length){
    const tLineRaw = (usable[idx]||"").trim();
    const dashLine = (usable[idx+1]||"").trim();
    const isStart = !!tLineRaw && /^-{20,}$/.test(dashLine);
    if(!isStart){ idx++; continue; }

    // Parse "Title | link | published"
    const parts = tLineRaw.split("|").map(s=>s.trim());
    let title = cleanTitle(parts[0]);
    let link = ""; let published = "";
    if(parts.length>=2 && /^https?:\/\//i.test(parts[1])) link = parts[1];
    if(parts.length>=3) published = parts.slice(2).join(" | ");

    // Collect body until sep (>=60 dashes) followed by potential next header
    const body = [];
    let j = idx+2;
    while(j<usable.length){
      const L = (usable[j]||"").trim();
      const longSep = /^-{60,}$/.test(L);
      const aheadTitle = (usable[j+1]||"").trim();
      const aheadDash   = (usable[j+2]||"").trim();
      const nextStart = aheadTitle && /^-{20,}$/.test(aheadDash);
      if(longSep && nextStart){ j++; break; }
      body.push(usable[j]);
      j++;
    }

    // If link was missing, try to find first URL inside body
    if(!link){
      const joined = body.join(" ");
      const m = joined.match(/https?:\/\/[^\s)]+/i);
      if(m) link = m[0];
    }

    // Guard: if title still looks like SEO line, set from first sentence
    if(/^seo keywords:/i.test(title) || title === "(untitled)"){
      const first = (body.join("\n").split(/\n+/).find(x=>x && !/^seo keywords:/i.test(x)) || "").trim();
      title = first ? cleanTitle(first).slice(0,140) : "(untitled)";
    }

    out.push({
      title, link, published,
      body: (body.join("\n")).trim(),
      observedAt: Date.now()
    });
    idx = j+1;
  }
  return out;
}

/* ===== Tokenization / Keywords ===== */
const STOP = new Set(`a,an,the,of,in,on,for,with,and,or,to,from,by,as,is,are,was,were,be,been,at,that,this,these,those,it,its,their,his,her,our,your,not,no,if,then,than,but,so,also,into,over,under,about,via,per,within,without,across,between,among,will,can,may,might,could,should,would`.split(","));
function words(t){ return (t.toLowerCase().match(/[a-z0-9]+/g)||[]); }
function findSeoKeywords(text){
  const m = text.match(/^\s*seo keywords:\s*(.+)$/gim);
  if(!m) return [];
  const line = m[m.length-1];
  const list = (line.split(":")[1]||"");
  return list.split(/[;,]/g).map(s=>s.trim()).filter(Boolean);
}

/* ===== Confidence / Veracity heuristic (0–100) ===== */
const POS = new Set("confirm,confirmed,official,approved,announced,launch,launched,records,record,acquires,acquired,sec filing,final,definitive,report,results".split(","));
const NEG = new Set("may,might,could,reportedly,rumor,alleged,seems,suggests,likely,unverified,investigating,unclear,disputed,questioned,unconfirmed".split(","));
function confidenceScore(text, host=""){
  const bag = words(text);
  let pos=0, neg=0;
  for(const w of bag){ if(POS.has(w)) pos++; if(NEG.has(w)) neg++; }
  let score = 52 + 6*pos - 6*neg;
  if(/nytimes\.com|washingtonpost\.com|forbes\.com|reuters\.com|apnews\.com|theguardian\.com|ft\.com|economist\.com|aljazeera\.com|npr\.org/i.test(host)) score += 6;
  return Math.max(0, Math.min(100, score));
}

/* ===== Co-occurrence / Correlations ===== */
function topKeywords(articles, k=20){
  const freq = new Map();
  for(const a of articles){
    let kws = findSeoKeywords(a.body);
    if(!kws.length){
      kws = words(a.body).filter(w=>!STOP.has(w) && w.length>2).slice(0,80);
    }
    for(const kw of kws){ const key = kw.toLowerCase(); freq.set(key, (freq.get(key)||0)+1); }
  }
  return [...freq.entries()].sort((a,b)=>b[1]-a[1]).slice(0,k);
}
function cooccurMatrix(articles, keys){
  const K = keys.length;
  const index = new Map(keys.map((k,i)=>[k,i]));
  const M = Array.from({length:K},()=>Array(K).fill(0));
  for(const a of articles){
    let kws = findSeoKeywords(a.body);
    if(!kws.length){ kws = words(a.body).filter(w=>!STOP.has(w) && w.length>2).slice(0,50); }
    const set = new Set(kws.map(k=>k.toLowerCase()).filter(k=>index.has(k)));
    const arr = [...set];
    for(let i=0;i<arr.length;i++){
      for(let j=i;j<arr.length;j++){
        const ii=index.get(arr[i]), jj=index.get(arr[j]);
        M[ii][jj]++; if(ii!==jj) M[jj][ii]++;
      }
    }
  }
  return M;
}

/* ===== Momentum / Trends ===== */
const HISTORY = []; // push({ ts, kwFreq: Map, confBySource: Map })
const HISTORY_MAX = 30; // last ~30 polls

function snapshotFrom(articles){
  // keyword frequency
  const kwFreq = new Map();
  for(const [kw,count] of topKeywords(articles, 40)){ kwFreq.set(kw,count); }

  // confidence by source (avg)
  const agg = new Map(); // host -> [sum,cnt]
  articles.forEach(a=>{
    const h = a.host || "unknown";
    const v = agg.get(h) || [0,0];
    v[0]+=a.confidence; v[1]+=1;
    agg.set(h,v);
  });
  const confBySource = new Map([...agg.entries()].map(([h,[s,c]])=>[h, Math.round(s/c)]));

  return { ts: Date.now(), kwFreq, confBySource };
}
function momentumTop(kw, lookback=5, top=8){
  // crude slope: current - median(prev n) to identify rising terms
  if(!HISTORY.length) return [];
  const cur = HISTORY[HISTORY.length-1].kwFreq;
  const prev = HISTORY.slice(-lookback-1, -1).map(h=>h.kwFreq);
  const med = (arr)=>{ const s=[...arr].sort((a,b)=>a-b); const m=Math.floor(s.length/2); return s.length? (s.length%2?s[m]:(s[m-1]+s[m])/2):0; };
  const deltas = [];
  for(const [k,v] of cur.entries()){
    const vals = prev.map(p=>p.get(k)||0);
    const base = med(vals);
    deltas.push([k, v - base, v]);
  }
  return deltas
    .filter(([k,d,v])=>v>0)
    .sort((a,b)=> (b[1]===a[1] ? b[2]-a[2] : b[1]-a[1]))
    .slice(0, top);
}
function confDeltaTop(lookback=3, top=6){
  if(HISTORY.length < lookback+1) return [];
  const last = HISTORY[HISTORY.length-1].confBySource;
  const prev = HISTORY[HISTORY.length-1-lookback].confBySource;
  const keys = new Set([...last.keys(), ...prev.keys()]);
  const rows = [];
  for(const k of keys){
    const a = last.get(k)||0;
    const b = prev.get(k)||0;
    rows.push([k, a-b, a]);
  }
  return rows.sort((x,y)=>Math.abs(y[1])-Math.abs(x[1])).slice(0, top);
}

/* ===== Clustering (by dominant keyword) ===== */
function buildClusters(articles, topN=8){
  const kwPairs = topKeywords(articles, 30).map(p=>p[0]);
  const clusters = new Map(); // kw -> [articles]
  for(const a of articles){
    let kws = findSeoKeywords(a.body);
    if(!kws.length){ kws = words(a.body).filter(w=>!STOP.has(w) && w.length>2).slice(0,20); }
    const hits = kws.map(k=>k.toLowerCase()).filter(k=>kwPairs.includes(k));
    const key = hits[0] || null;
    if(!key) continue;
    const arr = clusters.get(key) || [];
    arr.push(a);
    clusters.set(key, arr);
  }
  // sort clusters by size
  return [...clusters.entries()]
    .sort((a,b)=>b[1].length - a[1].length)
    .slice(0, topN);
}

/* ===== Tiny UI helpers ===== */
function renderBars(containerSel, pairs, cap=10, suffix=""){
  const root = $(containerSel); root.innerHTML = "";
  if(!pairs.length){ root.innerHTML = '<div class="muted">No data</div>'; return; }
  const max = Math.max(...pairs.map(p=>p[1])) || 1;
  pairs.slice(0,cap).forEach(([label,val])=>{
    const row = document.createElement("div"); row.className="barrow";
    const lab = document.createElement("div"); lab.className="label"; lab.textContent=label;
    const wrap = document.createElement("div"); wrap.className="barWrap";
    const bar = document.createElement("div"); bar.className="bar"; bar.style.width = (100*val/max).toFixed(1)+"%";
    const v = document.createElement("div"); v.className="val"; v.textContent = val + (suffix? " "+suffix:"");
    wrap.appendChild(bar);
    row.appendChild(lab); row.appendChild(wrap); row.appendChild(v);
    root.appendChild(row);
  });
}
function renderHeat(containerSel, keys, M){
  const root = $(containerSel); root.innerHTML="";
  if(!keys.length){ root.innerHTML='<div class="muted">No correlations yet.</div>'; return; }
  const K = keys.length;
  const max = Math.max(1, ...M.flat());
  root.className = "heat";
  root.style.gridTemplateColumns = `140px repeat(${K}, minmax(36px, 1fr))`;
  const blank = document.createElement("div"); blank.className="lab hdr"; root.appendChild(blank);
  for(let j=0;j<K;j++){ const d = document.createElement("div"); d.className="lab hdr"; d.textContent=keys[j]; root.appendChild(d); }
  for(let i=0;i<K;i++){
    const lab = document.createElement("div"); lab.className="lab"; lab.textContent=keys[i]; root.appendChild(lab);
    for(let j=0;j<K;j++){
      const v = M[i][j], ratio = v/max;
      const hue = 210 - Math.round(210*ratio); // blue → red
      const alpha = 0.15 + 0.65*ratio;
      const cell = document.createElement("div"); cell.className="cell";
      cell.style.background = `hsla(${hue}, 85%, 60%, ${alpha.toFixed(2)})`;
      cell.title = `${keys[i]} × ${keys[j]}: ${v}`;
      cell.textContent = v? String(v): "";
      root.appendChild(cell);
    }
  }
}
function renderLatest(list){
  const tbody = $("#latest"); tbody.innerHTML="";
  list.forEach(a=>{
    const tr = document.createElement("tr");
    const tdT = document.createElement("td");
    const tdS = document.createElement("td");
    const tdC = document.createElement("td");
    const tdK = document.createElement("td");

    tdT.innerHTML = `<div style="font-weight:700">${a.title}</div>
                     <div class="mono">${a.published || ""}</div>
                     ${a.link ? `<a href="${a.link}" target="_blank" rel="noopener">Open source</a>` : ""}`;

    tdS.textContent = a.host || "—";

    const cls = gradeClass(a.confidence);
    tdC.innerHTML = `<span class="${cls}" style="font-weight:700">${a.confidence}</span>`;

    tdK.textContent = (a.topTerms||[]).slice(0,6).join(", ");
    tr.appendChild(tdT); tr.appendChild(tdS); tr.appendChild(tdC); tr.appendChild(tdK);
    tbody.appendChild(tr);
  });
}
function renderSnapshot(articles, kwPairs, sourcePairs){
  const total = articles.length;
  const topKW = kwPairs[0]?.[0] || "—";
  const topSrc = sourcePairs[0]?.[0] || "—";
  const avgConf = total? Math.round(articles.reduce((s,a)=>s+a.confidence,0)/total) : 0;
  const rows = [
    ["Articles in window", String(total)],
    ["Top keyword", topKW],
    ["Top source", topSrc],
    ["Avg confidence", `${avgConf}`],
    ["Window (hours)", String(WINDOW_HOURS)]
  ];
  const tb = $("#snapshot"); tb.innerHTML="";
  rows.forEach(([k,v])=>{
    const tr=document.createElement("tr");
    tr.innerHTML = `<th>${k}</th><td>${v}</td>`;
    tb.appendChild(tr);
  });
}
function sparkline(values){
  if(values.length<2) values = [...values, ...values];
  const max = Math.max(...values, 1), min = Math.min(...values, 0);
  const norm = values.map(v=> (max===min? 0.5 : (v-min)/(max-min)));
  const pts = norm.map((y,i)=> `${(i/(norm.length-1))*100},${(1-y)*100}`).join(' ');
  return `<div class="spark"><svg viewBox="0 0 100 100" preserveAspectRatio="none">
            <polyline points="${pts}" fill="none" stroke="currentColor" stroke-width="6" opacity=".35"/>
            <polyline points="${pts}" fill="none" stroke="currentColor" stroke-width="2"/>
          </svg></div>`;
}
function renderMomentum(containerSel, rows){
  const root=$(containerSel); root.innerHTML="";
  if(!rows.length){ root.innerHTML='<div class="muted">No momentum yet.</div>'; return; }
  rows.forEach(([kw,delta,cur])=>{
    const row = document.createElement("div"); row.className="barrow";
    const lab = document.createElement("div"); lab.className="label"; lab.textContent=kw;
    const wrap = document.createElement("div"); wrap.innerHTML = sparkline([Math.max(0,cur-delta), cur]);
    const v = document.createElement("div"); v.className="val";
    const sign = delta>0 ? "+" : "";
    v.textContent = `${cur} (${sign}${delta})`;
    row.appendChild(lab); row.appendChild(wrap); row.appendChild(v);
    root.appendChild(row);
  });
}
function renderConfDelta(containerSel, rows){
  const root=$(containerSel); root.innerHTML="";
  if(!rows.length){ root.innerHTML='<div class="muted">No deltas yet.</div>'; return; }
  rows.forEach(([host,delta,cur])=>{
    const row = document.createElement("div"); row.className="barrow";
    const lab = document.createElement("div"); lab.className="label"; lab.textContent=host;
    const wrap = document.createElement("div"); wrap.innerHTML = sparkline([Math.max(0,cur-delta), cur]);
    const v = document.createElement("div"); v.className="val";
    const sign = delta>0 ? "+" : "";
    v.textContent = `${cur} (${sign}${delta})`;
    row.appendChild(lab); row.appendChild(wrap); row.appendChild(v);
    root.appendChild(row);
  });
}
function renderClusters(containerSel, clusters){
  const root=$(containerSel); root.innerHTML="";
  if(!clusters.length){ root.innerHTML='<div class="muted">No clusters detected yet.</div>'; return; }
  clusters.forEach(([kw,items])=>{
    const box = document.createElement("div"); box.style.borderTop = "1px dashed var(--dash)"; box.style.paddingTop="8px";
    const h = document.createElement("div"); h.innerHTML = `<strong>${kw}</strong> <span class="muted">(${items.length})</span>`;
    const ul = document.createElement("ul"); ul.style.margin="8px 0 0"; ul.style.paddingLeft="16px";
    items.slice(0,6).forEach(a=>{
      const li=document.createElement("li");
      const title = a.title || "(untitled)";
      li.innerHTML = `${title} ${a.link ? ` — <a href="${a.link}" target="_blank" rel="noopener">open</a>`:""}`;
      ul.appendChild(li);
    });
    box.appendChild(h); box.appendChild(ul);
    root.appendChild(box);
  });
}

/* ===== Live state & loop ===== */
let LAST_HASH = "";
let CACHE = [];               // unified article cache (windowed on render)
const MAX_CACHE = 400;        // keep more for longer windows

function withinWindow(a){
  const ageMs = Date.now() - a.observedAt;
  return ageMs <= WINDOW_HOURS*3600*1000;
}

async function poll(){
  try{
    const txt = await fetchText(WORKER_ASCII_URL);
    const h = await sha(txt);
    if(h === LAST_HASH) return; // no changes

    const parsed = parseArticles(txt).map(a=>{
      const host = hostOf(a.link);
      const conf = confidenceScore(a.body, host);
      const kws = findSeoKeywords(a.body);
      const topTerms = (kws.length ? kws : words(a.body).filter(w=>!STOP.has(w)).slice(0,8)).map(w=>w.toLowerCase());
      return { ...a, host, confidence: conf, topTerms };
    });

    // Merge with cache (dedupe by title+host)
    const keyOf = (x)=> (x.title + "|" + (x.host||"")).toLowerCase();
    const map = new Map(CACHE.map(a=>[keyOf(a), a]));
    parsed.forEach(p=> map.set(keyOf(p), p));
    CACHE = [...map.values()]
      .sort((a,b)=>b.observedAt - a.observedAt)
      .slice(0, MAX_CACHE);

    // History snapshot for momentum/delta
    HISTORY.push( snapshotFrom(CACHE.filter(withinWindow)) );
    if(HISTORY.length > HISTORY_MAX) HISTORY.shift();

    renderAll();
    LAST_HASH = h;
    $("#lastUpdated").textContent = nowStr();
    document.querySelectorAll(".card").forEach(n=>{ n.classList.add("blink"); setTimeout(()=>n.classList.remove("blink"), 900); });
  }catch(e){ console.error(e); }
}

function renderAll(){
  const windowed = CACHE.filter(withinWindow);

  // Sources
  const srcCounts = new Map();
  windowed.forEach(a=> srcCounts.set(a.host || "unknown", (srcCounts.get(a.host || "unknown")||0)+1));
  const sourcePairs = [...srcCounts.entries()].sort((a,b)=>b[1]-a[1]);

  // Keywords
  const kwPairs = topKeywords(windowed, 24);

  // Confidence per source
  const confMap = new Map(); // host -> [sum, cnt]
  windowed.forEach(a=>{
    const k = a.host || "unknown";
    const acc = confMap.get(k) || [0,0];
    acc[0]+=a.confidence; acc[1]+=1;
    confMap.set(k, acc);
  });
  const confPairs = [...confMap.entries()].map(([h,[s,c]])=>[h, Math.round(s/c)]).sort((a,b)=>b[1]-a[1]);

  // Correlations
  const keyList = kwPairs.slice(0,12).map(p=>p[0]);
  const M = cooccurMatrix(windowed, keyList);

  // Momentum & Confidence Delta
  const momentum = momentumTop(kwPairs.map(p=>p[0]));
  const delta = confDeltaTop();

  // Clusters
  const clusters = buildClusters(windowed, 8);

  // Render
  renderBars("#sources", sourcePairs, 10, "articles");
  renderBars("#keywords", kwPairs, 12, "hits");
  renderBars("#confSources", confPairs, 8, "conf");
  renderHeat("#heat", keyList, M);
  renderMomentum("#momentum", momentum);
  renderConfDelta("#confDelta", delta);
  renderClusters("#clusters", clusters);
  renderLatest(windowed.slice(0,10));
  renderSnapshot(windowed, kwPairs, sourcePairs);
}

/* ===== Controls ===== */
let loopId = null;
function schedule(){
  if(loopId) clearInterval(loopId);
  loopId = setInterval(poll, FRONTEND_POLL_MS);
}
$("#refreshSel").addEventListener("change", (e)=>{
  const v = parseInt(e.target.value,10);
  if(!isNaN(v) && v>0){ FRONTEND_POLL_MS = v; schedule(); }
});
$("#windowSel").addEventListener("change", (e)=>{
  const v = parseInt(e.target.value,10);
  if(!isNaN(v) && v>0){ WINDOW_HOURS = v; renderAll(); }
});
$("#refreshBtn").addEventListener("click", ()=>poll());

/* ===== Boot (respect query overrides: ?window=12&refresh=90000) ===== */
(function(){
  const q = new URLSearchParams(location.search);
  const w = parseInt(q.get("window")||"", 10);
  if(!isNaN(w) && w>0){ WINDOW_HOURS = w; $("#windowSel").value = String(w); }
  const r = parseInt(q.get("refresh")||"", 10);
  if(!isNaN(r) && r>0){ FRONTEND_POLL_MS = r; $("#refreshSel").value = String(r); }
})();
poll(); schedule();

</script>
</body>
</html>
